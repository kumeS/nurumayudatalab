# FleMa画像編集ツール

ゆるま湯データラボが提供する、フリマ出品画像づくりに特化したシングルページアプリです。ブラウザだけで完結し、画像の取り込み・文字装飾・書き出しまでを IndexedDB による自動保存付きで行えます。ローカル実行を前提とした軽量ツールで、アカウント作成やサーバー連携は不要です。

---

## 主な機能

- **マルチキャンバス編集**  
  追加ボタンでキャンバスを増やし、不要になったものはキャンバス右上の削除アイコンから安全に除去。キャンバスごとの状態やアクティブ選択は自動的に維持されます。

- **画像インポート（ファイル / URL）**  
  複数ファイルのドラッグイン/選択に加えて、HTTPS 画像 URL からの直接読込に対応。CORS 許可された画像ならワンクリックでキャンバス上へ配置され、サイズ制限（10MB）・ファイル種別チェックも組み込んでいます。

- **画像調整ツール**  
  明るさ / コントラスト / 彩度 / 色相フィルター、90° 回転・水平/垂直反転、矩形トリミング、一部ぼかし、背景削除（β）などを備えています。

- **テキスト装飾**  
  色・背景・影・アウトライン・字間・行間などをリアルタイムに調整可能。効果パネルは各パラメータが同期され、タップ/クリック後すぐにキャンバスへ反映されます。

- **レイヤー / Undo**  
  4種類のレイヤー移動（最前面/前へ/後ろへ/最背面）と 25 ステップの Undo/Redo を用意。ショートカット（Ctrl/Cmd + Z、Shift + Z）にも反応します。

- **ズーム & パン**  
  キャンバスはホイールズーム・ピンチズーム・ヘッダー UI で倍率調整が可能。Space + ドラッグや 2 本指ドラッグで自由にパンできます。

- **IndexedDB 自動保存**  
  プロジェクトは最大 20 件まで自動ローテーション保存され、60 秒ごとのオートセーブと操作後 2 秒のクイックセーブに対応。読み込み時は直前のキャンバス構成や選択情報を復元します。取り込んだ画像データも履歴として IndexedDB に保存されるため、リロード後でも再利用できます。

---

## 使い方

1. リポジトリをクローンしたらルートで静的サーバーを立ち上げます。
   ```bash
   python3 -m http.server 5173
   # または
   npx http-server . -p 5173
   ```
2. ブラウザで `http://localhost:5173` を開きます。
3. 「商品画像を選択」ボタンか URL 入力欄から素材を取り込み、テキストや装飾を追加します。
4. 画面右上のエクスポートボタンで PNG/JPG 出力が可能です。

**注意:** ブラウザのプライベートモードでは IndexedDB が無効化される場合があります。通常モードでの利用を推奨します。

---

## フォルダ構成と主なモジュール

```
.
├── index.html          # UI のシェル
├── css/style.css       # 共通スタイル
└── js/
    ├── main.js         # エントリーポイント（イベント束ね）
    ├── canvas.js       # Fabric.js キャンバスとズーム/レイヤー制御
    ├── image.js        # 画像読み込み・調整・URLインポート処理
    ├── text.js         # テキストツールとスタイル適用
    ├── export.js       # 画像書き出し
    ├── project.js      # プロジェクト保存・読み込み
    ├── db.js           # IndexedDB ヘルパー（プロジェクト & 画像履歴）
    └── utils.js        # 共通ユーティリティ
```

各モジュールは独立した役割を持ち、`main.js` で初期化・イベント登録を行います。Fabric.js は単一バンドルとして `canvas.js` / `image.js` / `text.js` から利用しています。

---

## IndexedDB 永続化の流れ

- **プロジェクト (`projects` ストア)**  
  - キャンバス構成、オブジェクト JSON、ズーム状態などをまとめて保存。  
  - 60 秒ごとのオートセーブ、操作終了後 2 秒でのクイックセーブを実施。  
  - 20 件を超えた場合は更新日時が古いものから自動削除します。

- **画像履歴 (`imageHistory` ストア)**  
  - 取り込んだ画像の Data URL とファイル名、タイムスタンプを保存。  
  - 履歴は最大 50 件まで保持し、超過分は古い順に整理します。  
  - URL から取得した画像も同じストアへ登録されるため、再読み込み後でも保持されます。

---

## 現在わかっている制限と改善アイデア

- **URL インポート時の CORS 制限**  
  - 外部サーバーが CORS を許可していない場合は取得に失敗します。  
  - *提案*: 画像プロキシ（Cloudflare Workers など）を用意するか、失敗時にユーザーへリダウンロード手順をガイドする。

- **画像履歴ビュー未実装**  
  - IndexedDB には保存されますが、UI から履歴を選び直すことはできません。  
  - *提案*: 「最近使った画像」リストをモーダル表示し、クリックで再配置できるようにする。

- **テキストテンプレートの管理性**  
  - 固定テンプレートの編集・保存機能はありません。  
  - *提案*: よく使うテキストスタイルをユーザー側で登録・呼び出しできるミニプリセットを追加する。

- **エクスポート設定の固定化**  
  - 出力解像度やファイル形式は毎回ダイアログで選択する仕様です。  
  - *提案*: 直近の設定を記憶するか、プリセットとして保存する簡易設定を導入する。

- **Safari 固有動作の検証不足**  
  - 指示にある手動確認項目（IndexedDB 永続化、部分ぼかし等）は Safari で未テストです。  
  - *提案*: Safari/iOS での動作検証リストを `docs/` にまとめ、確認できた項目を順次追加する。

- **アクセシビリティ改善余地**  
  - 一部ボタンのキーボードフォーカスリングがカスタムカラーのみです。  
  - *提案*: `aria-live` を用いた通知読み上げや、ショートカット一覧をヘルプにまとめる。

---

## コントリビューション

開発ルール・命名規則・テスト指針などは **`AGENTS.md` の「Repository Guidelines」** を参照してください。プルリクを作成する場合は、変更点の概要と手動確認内容を簡潔に記載して頂けると助かります。

---

## ライセンス / 利用範囲

このリポジトリはクローズドな利用を想定しており、大規模な本番公開やホスティング戦略は含まれていません。社内/チーム内でのツール利用や改善を目的にご利用ください。README の内容は 2024-03 時点の実装を基に記載しています。
