# FleMa画像編集ツール

ゆるま湯データラボが提供する、フリマ出品画像づくりに特化したシングルページアプリです。ブラウザだけで完結し、画像の取り込み・文字装飾・書き出しまでを IndexedDB による自動保存付きで行えます。ローカル実行を前提とした軽量ツールで、アカウント作成やサーバー連携は不要です。

---

## 主な機能

- **マルチキャンバス編集**
  追加ボタンでキャンバスを増やし、不要になったものはキャンバス右上の削除アイコンから安全に除去。キャンバスごとの状態やアクティブ選択は自動的に維持されます。

- **画像インポート（ファイル / URL）**
  複数ファイルのドラッグイン/選択に加えて、HTTPS 画像 URL からの直接読込に対応。CORS 許可された画像ならワンクリックでキャンバス上へ配置され、サイズ制限（10MB）・ファイル種別チェックも組み込んでいます。

- **画像調整ツール**
  - **色調補正**: 明るさ / コントラスト / 彩度 / 色相フィルター
  - **変形**: 90° 回転・水平/垂直反転、矩形トリミング
  - **加工**: 一部ぼかし（個人情報隠しに便利）、背景自動削除（β）
  - **レイヤー操作**: 最前面/前へ/後ろへ/最背面への移動、画像削除

- **フリマ特化テキストテンプレート**
  - **売れる言葉 15 種類**: 「新品未使用」「美品」「送料無料」「即日発送」「値下げ交渉OK」「限定品」「早い者勝ち」「セール中」「レア」「お得」「韓国限定」「韓国現地で購入」「正規品」「韓国正規店で購入」など
  - **ロゴ・アイコン 16 種類**: ゆるま湯ロゴ、スター、ジュエル、トラック、迅速発送、ハンドシェイク、タグ、クラウン、ボルト、パーセント、ファイア、セールタグ、グローブ、プレーン、サーティフィケート、ストア
  - **スタイルプリセット 16 種類**: 強調赤、ポップ黄色、エレガント、キュート、シンプル黒、黒字影付き、バッジ風、ネオン青、ゴールド、グリーン、オレンジ強調、紫エレガント、白枠付き、赤バッジ、レインボー、ネイビー

- **高度なテキスト装飾**
  - **基本設定**: フォントサイズ（12-320px）、フォント種類（6種類）、文字色、背景色（透過対応）
  - **スタイル**: 太字、斜体、下線
  - **変形**: 回転（-180° ~ 180°）、拡大（50% ~ 200%）、不透明度（0% ~ 100%）
  - **効果**: シャドウ（色・濃さ・ぼかし・距離・角度調整）、アウトライン（色・太さ調整）
  - **タイポグラフィ**: 字間（0-400）、行間（80%-200%）
  - **操作**: レイヤー移動、複製、削除

- **レイヤー & 履歴管理**
  - 4 種類のレイヤー移動（最前面/前へ/後ろへ/最背面）
  - 25 ステップの Undo/Redo 対応
  - キーボードショートカット（Ctrl/Cmd + Z、Ctrl/Cmd + Shift + Z）

- **ズーム & パン操作**
  - マウスホイールズーム・ピンチズーム対応
  - ヘッダー UI でのズームイン/アウト/リセット/画面フィット
  - Space + ドラッグまたは 2 本指ドラッグでパン移動
  - ズーム倍率表示

- **レスポンシブ対応**
  モバイル・タブレット・デスクトップで最適化された UI。PC 表示切り替えボタンでレイアウト変更が可能。

- **IndexedDB 自動保存**
  - **プロジェクト保存**: 最大 20 件まで自動ローテーション、60 秒ごとのオートセーブと操作後 2 秒のクイックセーブ
  - **画像履歴**: 最大 50 件の画像 Data URL を保存、リロード後も再利用可能
  - **状態復元**: キャンバス構成、オブジェクト、ズーム状態、選択情報を完全復元

---

## 使い方

1. リポジトリをクローンしたらルートで静的サーバーを立ち上げます。
   ```bash
   python3 -m http.server 5173
   # または
   npx http-server . -p 5173
   ```
2. ブラウザで `http://localhost:5173` を開きます。
3. 「商品画像を選択」ボタンか URL 入力欄から素材を取り込み、テキストや装飾を追加します。
4. 画面右上のエクスポートボタンで PNG/JPG 出力が可能です。

**注意:** ブラウザのプライベートモードでは IndexedDB が無効化される場合があります。通常モードでの利用を推奨します。

---

## フォルダ構成と主なモジュール

```
.
├── index.html          # UI のシェル
├── css/
│   └── style.css       # 共通スタイル
├── js/
│   ├── main.js         # エントリーポイント（イベント束ね）
│   ├── canvas.js       # Fabric.js キャンバスとズーム/レイヤー制御
│   ├── image.js        # 画像読み込み・調整・URLインポート処理
│   ├── text.js         # テキストツールとスタイル適用
│   ├── export.js       # 画像書き出し（PNG/JPG）
│   ├── project.js      # プロジェクト保存・読み込み
│   ├── db.js           # IndexedDB ヘルパー（プロジェクト & 画像履歴）
│   └── utils.js        # 共通ユーティリティ
└── ../favicon/
    └── nu-circle.svg   # ゆるま湯ロゴ favicon
```

各モジュールは独立した役割を持ち、`main.js` で初期化・イベント登録を行います。Fabric.js は単一バンドルとして `canvas.js` / `image.js` / `text.js` から利用しています。

### 技術スタック
- **Fabric.js 5.3.0**: キャンバス操作とオブジェクト管理
- **FileSaver.js 2.0.5**: ファイルダウンロード処理
- **DOMPurify 3.0.6**: XSS 保護
- **Font Awesome 6.4.0**: アイコン
- **Noto Sans JP**: 日本語フォント

---

## IndexedDB 永続化の流れ

- **プロジェクト (`projects` ストア)**  
  - キャンバス構成、オブジェクト JSON、ズーム状態などをまとめて保存。  
  - 60 秒ごとのオートセーブ、操作終了後 2 秒でのクイックセーブを実施。  
  - 20 件を超えた場合は更新日時が古いものから自動削除します。

- **画像履歴 (`imageHistory` ストア)**  
  - 取り込んだ画像の Data URL とファイル名、タイムスタンプを保存。  
  - 履歴は最大 50 件まで保持し、超過分は古い順に整理します。  
  - URL から取得した画像も同じストアへ登録されるため、再読み込み後でも保持されます。

---

## 未実装機能と改善提案

以下は、ツールをさらに使いやすくするための具体的な実装提案です。大規模実装ではなく、小〜中規模で段階的に追加できる機能に絞っています。

### 📋 優先度：高

1. **画像履歴パネルの実装**
   - **現状**: IndexedDB に最大 50 件の画像履歴が保存されているが、UI から再利用できない
   - **提案**: 画像パネルに「最近使った画像」セクションを追加し、サムネイルクリックで再配置
   - **実装ポイント**: `db.js` の `getRecentImages()` と連携、サムネイル表示（100x100px）

2. **エクスポート設定の記憶機能**
   - **現状**: 出力解像度やファイル形式を毎回選択する必要がある
   - **提案**: localStorage に直近のエクスポート設定を保存し、次回のデフォルト値として使用
   - **実装ポイント**: `export.js` に設定保存機能を追加、「設定を保存」チェックボックス

3. **キーボードショートカット一覧モーダル**
   - **現状**: ショートカット（Ctrl+Z, Space+ドラッグなど）が存在するが、一覧表示がない
   - **提案**: `?` キーまたはヘルプボタンでショートカット一覧をモーダル表示
   - **実装ポイント**: 新規 HTML モーダル追加、キーバインド一覧表の作成

### 🎨 優先度：中

4. **テキストスタイルのユーザープリセット**
   - **現状**: 固定の 16 スタイルプリセットのみ、カスタム保存不可
   - **提案**: 現在のテキストスタイルを「マイスタイル」として最大 5 件まで保存
   - **実装ポイント**: IndexedDB に新ストア `userTextPresets` を追加、プリセット管理 UI

5. **複数キャンバスの一括エクスポート**
   - **現状**: キャンバスごとに個別エクスポートが必要
   - **提案**: 「全てエクスポート」ボタンで全キャンバスを ZIP または連番 PNG で一括出力
   - **実装ポイント**: JSZip ライブラリ追加、または連番ファイル名での連続ダウンロード

6. **オブジェクト整列ツール**
   - **現状**: オブジェクトを手動で配置する必要がある
   - **提案**: 選択オブジェクトを「左揃え」「中央揃え」「右揃え」「上揃え」「下揃え」「等間隔配置」
   - **実装ポイント**: Fabric.js の座標計算、ツールバーに整列ボタン追加

7. **画像の角丸設定**
   - **現状**: 画像は常に矩形表示
   - **提案**: 画像選択時に角丸スライダー（0-100px）を追加
   - **実装ポイント**: Fabric.js の `clipPath` 機能、`image.js` に角丸適用関数

### 🔧 優先度：低

8. **グリッド/ガイド線表示**
   - **現状**: 整列の基準線がない
   - **提案**: トグルボタンでグリッド線（10px/50px 間隔）またはガイド線を表示
   - **実装ポイント**: キャンバス背景レイヤーにグリッド描画、設定パネルに表示切替

9. **画像調整の数値入力**
   - **現状**: 明るさ・コントラストなどはスライダーのみ
   - **提案**: スライダー横に数値入力欄を追加、直接数値入力を可能に
   - **実装ポイント**: `<input type="number">` 追加、スライダーと双方向同期

10. **キャンバスサイズのカスタマイズ**
    - **現状**: キャンバスサイズは固定（1200x1200px）
    - **提案**: プロジェクト作成時にサイズを選択（正方形/縦長/横長/カスタム）
    - **実装ポイント**: プロジェクト作成ダイアログ拡張、`canvas.js` のサイズ設定対応

11. **テキストの縦書き対応**
    - **現状**: 横書きのみ
    - **提案**: テキストコントロールパネルに「縦書き」トグルを追加
    - **実装ポイント**: Fabric.js の `writing-mode` 相当機能実装、または縦書き用フォント処理

12. **ドラッグ&ドロップの視覚的フィードバック強化**
    - **現状**: ドラッグ中の視覚的フィードバックが弱い
    - **提案**: ドラッグエリアのハイライト表示、ドロップ可能領域の明示
    - **実装ポイント**: CSS `:hover` および `dragover` イベントでのスタイル変更

### ⚠️ 既知の制限

- **URL インポート時の CORS 制限**
  外部サーバーが CORS を許可していない場合は取得に失敗します。回避策として、ユーザーに画像を一度ダウンロードしてからアップロードする手順を案内することを推奨します。

- **Safari/iOS での動作検証不足**
  IndexedDB 永続化、部分ぼかし、ピンチズームなどの Safari 特有の動作は未検証です。優先的なテスト項目として継続確認が必要です。

---

## コントリビューション

開発ルール・命名規則・テスト指針などは **`AGENTS.md` の「Repository Guidelines」** を参照してください。プルリクを作成する場合は、変更点の概要と手動確認内容を簡潔に記載して頂けると助かります。

---

## ライセンス / 利用範囲

このリポジトリはクローズドな利用を想定しており、大規模な本番公開やホスティング戦略は含まれていません。社内/チーム内でのツール利用や改善を目的にご利用ください。

---

## 更新履歴

### 2025-01
- favicon 追加（ゆるま湯ロゴ: `../favicon/nu-circle.svg`）
- README 大幅アップデート：実装内容の詳細化、未実装機能の具体的提案追加
- テンプレート機能の詳細記載（売れる言葉 15 種、ロゴ 16 種、スタイル 16 種）

README の内容は 2025-01 時点の実装を基に記載しています。
