=============================================================================
BUG REPORT 2
=============================================================================

作成日: 2025年1月  
担当: Professional Engineer (AI Assistant)  
対象: FleMa 画像編集ツール（webtool-ec-flema-image-tool）

本報告では、ユーザーから報告された以下の2件の不具合について調査した結果と、
想定される修正方針・実装上の留意点を整理する。

- バグ1: オブジェクト（画像・テキスト）の拡縮挙動とキャンバス本体の拡縮挙動が一致しない
- バグ2: 1枚目のキャンバスが画面上に表示されなくなる

=============================================================================
バグ1: オブジェクト拡縮とキャンバス拡縮の倍率がずれる
=============================================================================

【症状】  
- キャンバスズーム（ヘッダーのズームボタン／ホイール／ピンチなど）を実行した状態で
  オブジェクトをスケールすると、見た目の拡縮倍率と操作量が一致しない。  
- 具体例: ズーム200%時に画像をドラッグで拡大すると、期待よりも大きく膨らみ、
  再現性のある過剰スケーリングが発生する。

【再現手順】  
1. アプリを起動し、画像またはテキストを1つ配置する。  
2. ズームボタンかホイール操作でズームを200%にする。  
3. 配置したオブジェクトをドラッグで拡大／縮小すると、操作量に対して描画結果が過剰に変化する。  

【技術的原因】  
- ズーム操作時に **Fabric.js の内部ズーム**（`canvas.zoomToPoint` / `fabricCanvas.setZoom`）と  
  **DOM 側の CSS `transform: scale()`** を同時に適用しており、結果として同じ倍率が二重に掛かっている。  
  - `applyCanvasZoom`（`js/canvas.js:543-577`）で Fabric のズームを更新  
  - `syncCanvasViewportSize*`（`js/canvas.js:395-504`）でラッパーDOMへ CSS Transform を適用  
- Fabric.js は自身の座標系を `setZoom` で完全に管理するため、さらに CSS で拡縮すると  
  実際の描画倍率とマウスイベントで扱う論理座標が一致しなくなり、オブジェクト操作のズレとして現れる。

【影響範囲】  
- 全てのズーム操作（ホイール／ボタン／ピンチ）  
- オブジェクト編集（拡縮・移動・回転・位置合わせ）  
- `fitCanvasToContainer`, `zoomToFitObject`, `resetCanvasZoom` などズーム周りのヘルパー  
- 画像／テキスト追加時の初期配置ロジック（`positionImageOnCanvas`, `addNewText`）  

【推奨修正案】  
1. `syncCanvasViewportSizeForState` / `syncCanvasViewportSize` から CSS `transform: scale()` の適用を完全に取り除き、  
   DOM 側は常に論理サイズ（1080×1080 など）を維持させる。  
2. ズーム倍率は Fabric.js の内部ズーム（`setZoom` / `zoomToPoint`）だけで管理し、  
   共有ズーム値 `sharedCanvasZoom` から DOM へは何も掛けない。  
3. DOM の offset 計算をずらす処理（`canvas.calcOffset()`）は維持し、  
   内部ズームのみになったことを前提にマウス／タッチ操作を再テストする。  
4. マルチキャンバス同期も同じ方針で統一し、全てのキャンバスで Fabric 側だけを更新する。  

【実装時の留意点】  
- CSS Transform を除去するとキャンバス DOM の実寸は変わらないため、  
  見た目の拡大縮小は Fabric 側のズームに完全に依存する。ズーム後のスクロール／パン挙動を重点テストする。  
- UI アニメーション目的で `transition` や `will-change` を用いていた箇所は不要になるため削除しても問題ない。  
- 変更後は `zoomToFitObject`, `fitCanvasToContainer`, `resetCanvasZoom`, `zoomToPoint` 等を網羅的に動作確認する。  

=============================================================================
バグ2: 1枚目のキャンバスが表示されない
=============================================================================

【症状】  
- アプリ起動直後（キャンバス1枚のみの状態）で、キャンバス領域が灰色背景のまま表示され、白いキャンバスが見えない。  
- 水平方向にスクロールするとキャンバスが現れるケースがあり、初期表示ではオフセットされた位置に存在している。  

【再現手順】  
1. ビューポート幅 400px 以下（スマートフォン相当）の環境でアプリを起動する。  
2. 初期状態でキャンバスが見えず、灰色背景のみが表示される。  
3. `canvasContainer` を右方向へスクロールすると、オフセットされた位置にキャンバスが存在することを確認できる。  

【技術的原因】  
- バグ1と同じく CSS `transform: scale()` をキャンバス DOM に適用しているため、ズームアウト時に DOM 側の見かけサイズが小さくなり、  
  `transform-origin: center` によって左右均等に余白が生まれる。  
- さらに `canvasContainer.scrollLeft = 0` を毎回実行しているため、ズーム直後の表示は余白部分の左端になり、  
  実際のキャンバス本体（白い領域）がビューポートから外れたままになる。  

【影響範囲】  
- 初期表示／キャンバスリセット時 (`initializeFabricCanvas`, `resetCanvasWorkspaceToDefault`)  
- `fitCanvasToContainer` 実行後の表示（特にスマートフォンや狭幅画面）  
- スクロール位置を固定している処理（`syncCanvasViewportSize`）全般  

【推奨修正案】  
1. バグ1と同様に CSS Transform を完全に撤去し、DOM サイズは論理値のままにする。  
2. ズーム後のセンタリングは `centerCanvasInView`（viewportTransform の平行移動）で制御し、  
   `syncCanvasViewportSize` でスクロール位置を 0 に固定する処理はそのままにしても  
   DOM 側が縮まらないため余白問題は発生しない。  
3. 初期化 (`initializeFabricCanvas`) とリセット (`resetCanvasWorkspaceToDefault`) の直後に  
   `fitCanvasToContainer` → `centerCanvasInView` → `syncCanvasViewportSize` の順で呼び、  
   常にアクティブキャンバスがビューポート中央に収まることを確認する。  

【実装時の留意点】  
- CSS Transform を外した後でも、スマートフォン縦幅など極端に狭い画面ではズームアウト値が大きくなるため、  
  `fitCanvasToContainer` の下限値（`MIN_CANVAS_ZOOM`）を調整する余地がある。  
- 初期表示とマルチキャンバス切替の双方で、スクロール位置や表示位置が期待通りか手動テストを実施する。  

=============================================================================
段階的な解決アプローチ（推奨フロー）
=============================================================================

1. `syncCanvasViewportSizeForState` / `syncCanvasViewportSize` から CSS Transform を完全に除去する。  
2. `applyCanvasZoom`, `zoomToFitObject`, `fitCanvasToContainer`, `resetCanvasZoom` など  
   ズーム操作系が Fabric のズームのみを使用することを確認し、関連処理を微調整する。  
3. スマートフォン（縦向き）とデスクトップ双方で初期表示が中央に来るか、パン／ズーム操作が滑らかかを検証。  
4. オブジェクト操作（拡縮・移動・複製・回転）、画像／テキスト追加、複数キャンバス間の切替、保存／復元といった  
   重要フローを回帰テストする。  
5. 必要であればズーム時のアニメーションを CSS 以外（例: UI フィードバックやメッセージ）で補う。  

=============================================================================
備考
=============================================================================

- 本報告ではコードは変更していない。  
- 修正作業後は、既存の `Bug_report1` / `Bug_report_canvas_size` で想定されているテストケースを再度実施し、  
  過去の修正内容と矛盾がないことを確認すること。  
