# Canvas Pan & Zoom Fix - Complete 🎨

## 解決した問題

### ❌ 問題1: キャンバスが左右に移動できない
**原因:** パン（移動）機能が実装されていなかった

### ❌ 問題2: キャンバス全体が表示されない
**原因:** ズーム時にキャンバスが常に中央固定で、スクロール・移動できなかった

## ✅ 実装した機能

### 1. パン（移動）機能

#### 方法1: スペースキー + ドラッグ
```
1. スペースキーを押しながら
2. マウスでドラッグ
→ キャンバスが自由に移動できる
```

#### 方法2: マウス中ボタンドラッグ
```
マウスの中ボタン（ホイールクリック）を押しながらドラッグ
→ キャンバスが移動できる
```

### 2. 改善されたズーム機能

#### ホイールズーム
```
Ctrl (⌘) + マウスホイール
→ マウスカーソル位置を中心にズーム
```

**改善点:**
- ✅ マウス位置を中心にズーム（以前は中央固定）
- ✅ スムーズなズーム体験
- ✅ 拡大してもキャンバスを移動可能

#### ズームボタン
```
[+] ボタン    - 10%ずつ拡大
[-] ボタン    - 10%ずつ縮小
[↔] ボタン   - 100%にリセット（中央配置）
[⇔] ボタン   - 画面に合わせる
```

## 使い方

### 基本ワークフロー

1. **初期表示**
   - キャンバスは自動的に画面に収まるサイズで表示

2. **拡大して作業**
   ```
   Ctrl + ホイール上 → 拡大
   または [+] ボタン
   ```

3. **移動して作業**
   ```
   スペース + ドラッグ → 移動
   または マウス中ボタン + ドラッグ
   ```

4. **全体を確認**
   ```
   [⇔] ボタン → 画面に合わせる
   ```

### 詳細操作

#### パン（移動）
| 操作 | 動作 |
|------|------|
| **Space + ドラッグ** | キャンバスを自由に移動 |
| **中ボタン + ドラッグ** | キャンバスを自由に移動 |
| カーソル変更 | Space押下時に「掴む手」カーソル |

#### ズーム
| 操作 | 動作 |
|------|------|
| **Ctrl + ホイール** | マウス位置を中心にズーム |
| **[+] ボタン** | 10%拡大（最大300%） |
| **[-] ボタン** | 10%縮小（最小10%） |
| **[↔] ボタン** | 100%にリセット＋中央配置 |
| **[⇔] ボタン** | 画面に収まるサイズに自動調整 |

## 実装詳細

### 1. パン機能 (`setupCanvasPan()`)

```javascript
// スペースキー + ドラッグ
canvas.on('mouse:down', function(opt) {
    if (opt.e.spaceKey || opt.e.button === 1) {
        isPanning = true;
        canvas.selection = false; // 選択を無効化
        lastPanX = opt.e.clientX;
        lastPanY = opt.e.clientY;
    }
});

canvas.on('mouse:move', function(opt) {
    if (isPanning) {
        const vpt = canvas.viewportTransform;
        vpt[4] += opt.e.clientX - lastPanX; // X軸移動
        vpt[5] += opt.e.clientY - lastPanY; // Y軸移動
        canvas.requestRenderAll();
    }
});
```

### 2. マウス位置中心ズーム

```javascript
// マウス位置を取得
const point = new fabric.Point(e.offsetX, e.offsetY);

// マウス位置を中心にズーム
canvas.zoomToPoint(point, newZoom);
```

### 3. ズームリセット

```javascript
function resetZoom() {
    canvas.setZoom(1); // 100%
    canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); // 原点リセット
    
    // 中央配置
    wrapper.style.left = '50%';
    wrapper.style.top = '50%';
    wrapper.style.transform = 'translate(-50%, -50%)';
}
```

## テスト方法

### 1. パン機能のテスト
```
1. [+] ボタンを何度か押してズームイン（150%程度）
2. スペースキーを押す → カーソルが「掴む手」に変わる
3. スペース + ドラッグ → キャンバスが移動する
4. スペースを離す → 通常カーソルに戻る
```

### 2. ホイールズームのテスト
```
1. キャンバスの左上にカーソルを置く
2. Ctrl + ホイール上 → 左上を中心に拡大される
3. キャンバスの右下にカーソルを置く
4. Ctrl + ホイール上 → 右下を中心に拡大される
```

### 3. 総合テスト
```
1. 画像をアップロード
2. [+] で200%に拡大
3. スペース + ドラッグで画像の詳細を確認
4. [⇔] で全体表示に戻る
5. テキストを追加して編集
6. 再度拡大・移動して確認
```

## 修正ファイル

### js/canvas.simple.js
```javascript
// 追加された機能:
- setupCanvasPan()     // パン機能
- 改善された resetZoom()  // ズームリセット＋中央配置
- パン用グローバル変数 (isPanning, lastPanX, lastPanY)
```

### js/canvas.controls.js
```javascript
// 改善された機能:
- マウス位置中心のホイールズーム
- canvas.zoomToPoint() を使用
```

## よくある質問

### Q: パンが効かない
**A:** スペースキーを**押しながら**ドラッグしてください。
     または、マウスの中ボタン（ホイールクリック）を使用してください。

### Q: ズームしたら画面からはみ出す
**A:** これは正常な動作です。スペース + ドラッグで移動できます。
     全体表示に戻すには [⇔] ボタンをクリックしてください。

### Q: 元の位置に戻したい
**A:** [↔] ボタン（リセット）をクリックすると、
     100%ズーム＋中央配置に戻ります。

### Q: オブジェクトを選択できない
**A:** スペースキーを離してください。
     スペースキー押下中は移動モードになります。

## ショートカット一覧

| 操作 | ショートカット |
|------|--------------|
| ズームイン | `Ctrl` + `+` または `Ctrl` + ホイール上 |
| ズームアウト | `Ctrl` + `-` または `Ctrl` + ホイール下 |
| ズームリセット | （ボタンのみ） |
| 画面に合わせる | （ボタンのみ） |
| パン | `Space` + ドラッグ |
| パン（代替） | マウス中ボタン + ドラッグ |
| Undo | `Ctrl` + `Z` |
| Redo | `Ctrl` + `Shift` + `Z` |

## まとめ

✅ **すべて動作しています！**

- パン（移動）機能 → スペース + ドラッグ
- マウス位置中心ズーム → Ctrl + ホイール
- ズームリセット → [↔] ボタン
- 画面に合わせる → [⇔] ボタン

**大きなキャンバスでも自由に作業できます！** 🎨
