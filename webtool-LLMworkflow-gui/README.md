# LLMワークフローエディタ

> ビジュアルAIワークフロー作成ツール - プログラミング知識なしで複雑なAIパイプラインを構築

## 📌 プロジェクト概要

これは、バニラHTML、CSS、JavaScriptで構築されたビジュアルLLMワークフローエディタです。プログラミング知識を必要とせず、ノードベースのGUIシステムを使用して複雑なAIワークフローを作成できます。マルチステージ処理、ノード接続、ワークフロー実行をサポートするモジュラーES6アーキテクチャを特徴としています。

**現在のステータス**: v0.3.x - 接続レンダリング改善を含む重要なバグ修正フェーズ

## 🏗️ 現在のアーキテクチャ（モジュラー設計）

### コアモジュール

アプリケーションは**モジュラーES6クラスベースアーキテクチャ**に従います：

```
webtool-LLMworkflow-gui/
├── index.html              # 3パネルレイアウトのメインHTMLファイル
├── styles.css              # Tailwind CSSベースのスタイリング
├── workflow-editor.js      # メインオーケストレータークラス
├── node-manager.js         # ノード作成と管理
├── connection-manager.js   # 接続レンダリングとロジック
├── event-handlers.js       # DOMイベント処理
├── ui-manager.js          # UIパネルとプロパティ管理
├── workflow-executor.js   # ワークフロー実行エンジン
├── llm.js                 # LLM API統合（モック）
├── debug-monitor.js       # デバッグインフラストラクチャ
└── CLAUDE.md              # AIアシスタント用プロジェクトドキュメント
```

### モジュール責任

#### 1. **WorkflowEditor** (workflow-editor.js)
- 全モジュールを初期化・管理するメインコーディネータークラス
- ワークフロー状態の維持（ノード、接続、メタデータ）
- サブモジュールへの委譲メソッド提供
- キャンバス状態の処理（ズーム、パン、変換）

#### 2. **NodeManager** (node-manager.js)
- ノードの作成、削除、位置管理
- ノードタイプ定義とデフォルトデータ構造
- 異なるノードタイプ用のDOM要素生成
- ノードの選択と更新

#### 3. **ConnectionManager** (connection-manager.js)
- SVGベースの接続線レンダリング
- 接続の作成と削除ロジック
- キャンバス変換を含むポート位置計算
- 接続の検証と状態管理

#### 4. **EventHandlers** (event-handlers.js)
- マウスとキーボードイベント処理
- ノードとパレットアイテムのドラッグ&ドロップ機能
- キャンバスインタラクション処理
- ポートクリックによる接続作成

#### 5. **UIManager** (ui-manager.js)
- プロパティパネル生成と更新
- ノードパレットレンダリング
- モーダルダイアログとUI状態管理
- ノード固有の設定フォーム

#### 6. **WorkflowExecutor** (workflow-executor.js)
- 実行順序決定のためのトポロジカルソート
- データフローを含むノード実行
- モックLLM API呼び出し（現在シミュレート）
- 実行状態管理

### ✅ 完全に動作する機能
- **ビジュアルノードエディタ** パレットからのドラッグ&ドロップ
- **モジュラーES6アーキテクチャ** 明確な関心の分離
- **ノード管理システム** （8つのノードタイプ：input、llm、branch、merge、filter、loop、custom、output）
- **プロパティパネルシステム** ノード設定と編集用
- **ワークフロー実行エンジン** トポロジカルソートあり
- **イベント処理システム** ユーザーインタラクション用
- **デバッグ監視システム** 包括的ログ記録
- **ワークフローエクスポート/インポート機能** （プログラマティック）
- **ノード選択とハイライト**
- **無効な接続のクリーンアップ** 自動検証あり

### 🔄 部分的に動作する機能
- **接続システム**: 内部ロジックは動作、データ構造は正しいが、ビジュアルSVGレンダリングが不安定
- **プロパティパネル更新**: 動作するが、タイミング同期の問題あり
- **ノードドラッグ**: 基本機能は動作、軽微な位置オフセット問題あり
- **キャンバス変換**: スケールと移動状態は追跡されているが、全コンポーネントに完全適用されていない

### ❌ 修正が必要な重要問題
- **🔴 接続線が表示されない**: SVGパスは作成されるが座標計算が失敗
- **🔴 キャンバスパンが不足**: 大きなワークフローをナビゲートするためにキャンバスをドラッグできない  
- **🟡 入力ノードの色**: オレンジ色スキームでノードが見にくい
- **🟡 プロパティパネルタイミング**: 接続数が即座に更新されない
- **🟡 複数出力ポート**: ノードあたり単一出力ポートに制限

### ❌ 未実装
- データ永続化（localStorage/ファイル保存/読み込み）
- 実際のLLM API統合（現在モック）
- アンドゥ/リドゥ機能
- ワークフローテンプレートとサブワークフロー

## 🎯 サポートされるノードタイプ

| ノードタイプ | 説明 | UI状態 | ロジック状態 | 実行状態 |
|-------------|-----|--------|-------------|----------|
| **Input** | 設定可能な入力を持つデータエントリポイント | ✅ 完了 | ✅ 完了 | ✅ 動作 |
| **LLM Process** | プロンプト付きAI言語モデル処理 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Branch** | 条件ロジック分岐 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Merge** | 複数入力の集約 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Filter** | データフィルタリングと変換 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Loop** | 反復操作 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Custom** | カスタムJavaScriptコード実行 | ✅ 完了 | ✅ 完了 | 🔄 モック/シミュレート |
| **Output** | 最終出力先 | ✅ 完了 | ✅ 完了 | ✅ 動作 |

## 🐛 現在の開発状況とバグ修正

最近の開発とテスト（v0.3.xコミット）に基づいた現在の状況：

### 🔧 **最近実装された改善**
- **デバッグ監視システム**: 包括的ログ記録とエラー追跡の追加
- **接続管理**: エラーハンドリングを改善したSVGレンダリングの強化
- **ワークフロー検証**: 無効な接続の自動クリーンアップ
- **エクスポート/インポート機能**: プログラマティックワークフロー状態管理
- **グローバルデバッグメソッド**: `debugWorkflow()`、`validateWorkflow()`、`cleanupWorkflow()`、`rerenderWorkflow()`

### 🔴 **高優先度 - 修正が必要**

#### バグ #1: 接続線の可視性
- **状態**: 部分的に改善されたが、まだ不安定
- **問題**: 一部のキャンバス変換状態でSVG座標計算が失敗
- **証拠**: コンソールは接続作成成功を表示するが、ビジュアルレンダリングが断続的
- **ファイル**: `connection-manager.js`（208-257行、getPortPositionメソッド）

#### バグ #2: キャンバスパン実装
- **状態**: 未実装
- **問題**: キャンバスナビゲーションが不足（"バレット画面の左右上下移動が実装されていない"）
- **影響**: 大きなワークフローをナビゲートできない
- **ファイル**: `event-handlers.js`、キャンバスパンイベント処理が必要

### 🟡 **中優先度 - 注意が必要**

#### バグ #3: 入力ノードスタイリング
- **状態**: デザイン改善が必要
- **問題**: オレンジ色スキームで読みやすさが低下
- **ファイル**: `styles.css`（node-inputクラス）

#### バグ #4: プロパティパネル同期
- **状態**: キューシステムで部分的に改善
- **問題**: UI更新にまだタイミング遅延あり
- **ファイル**: `ui-manager.js`（queuePropertyPanelUpdateメソッド）

#### バグ #5: 複数出力ポートサポート
- **状態**: 未実装
- **要件**: ノードあたり最大3つの出力ポートをサポート
- **ファイル**: `connection-manager.js`、`node-manager.js`

## 🔧 実装進捗と次のステップ

### 🎯 **緊急のアクションアイテム**

#### 1. **接続線可視性修正**
- **現在の進捗**: 強化されたSVG作成と座標系実装
- **残る問題**: getPortPosition()メソッドでのキャンバス変換統合
- **次のステップ**: キャンバススケール/移動状態での座標計算をデバッグ

#### 2. **キャンバスパン実装**
- **現在の進捗**: workflow-editor.jsでキャンバスパン状態追跡実装
- **残る問題**: キャンバスドラッグ用イベントハンドラーが未接続
- **次のステップ**: event-handlers.jsでマウスイベント処理実装

#### 3. **UI/UX調整**
- **入力ノード色スキーム**: より良い可視性のためオレンジからティールに変更
- **プロパティパネルタイミング**: 既存のキューシステムをより効果的に使用
- **複数出力ポート**: connection-manager.jsポート位置ロジックの拡張

### 🚀 **最近の開発成果**

```javascript
// ブラウザコンソールで利用可能な新しいデバッグユーティリティ：
window.debugWorkflow()     // 包括的状態検査
window.validateWorkflow()  // 接続検証
window.cleanupWorkflow()   // 無効な接続を削除
window.rerenderWorkflow()  // 完全な再レンダリングを強制
```

**強化されたエラーハンドリング**: 包括的try-catchブロックとユーザーフレンドリーエラーメッセージ
**モジュラーアーキテクチャ**: UI、ロジック、レンダリング層間の明確な分離
**デバッグインフラストラクチャ**: リアルタイム監視とログシステム

### アプリケーションの実行

1. **直接ブラウザオープン**（macOS）:
   ```bash
   open index.html
   ```

2. **ローカルサーバー**（開発推奨）:
   ```bash
   # Python 3
   python -m http.server 8000
   # その後 http://localhost:8000 にアクセス
   
   # 代替サーバー
   python3 -m http.server 8000    # Python 3明示的
   npx http-server                 # Node.js利用可能な場合
   ```

3. **開発デバッグ**:
   ```javascript
   // ブラウザコンソールで利用可能：
   window.workflowEditor           // メインエディタインスタンス
   window.debugWorkflow()          // 状態検査
   window.validateWorkflow()       // 接続検証
   window.cleanupWorkflow()        // 無効な接続クリーンアップ
   window.rerenderWorkflow()       // 強制再レンダリング
   ```

### 技術スタック
- **フロントエンド**: バニラHTML5、CSS3、JavaScript（ES6+）
- **UIフレームワーク**: カスタムTailwindライクなCSSユーティリティ
- **ビルド**: なし（静的ファイル）
- **依存関係**: なし（CDN使用なし）

### アーキテクチャパターン
- **モジュラー設計**: 異なるES6クラスに分離された関心事
- **直接DOM操作**: フレームワークフリーの軽量実装
- **SVGベース描画**: SVGで描画される接続線
- **イベント駆動**: ユーザーインタラクションに応答
- **委譲パターン**: メインクラスが専門モジュールに委譲

## 📖 使用ガイド

### 基本操作

1. **ノード追加**: 左パレットからドラッグまたはクリックでキャンバスに追加
2. **ノード接続**: プロパティパネルドロップダウンまたはポート間ドラッグ  
3. **プロパティ編集**: ノード選択で右プロパティパネルを開く
4. **ワークフロー実行**: ツールバーの「Execute Workflow」ボタンをクリック
5. **ファイル操作**: 保存・読み込み機能（自動保存システム実装済み）

### デバッグ

ブラウザデベロッパーコンソールで利用可能：

```javascript
// メインエディタインスタンスにアクセス
window.workflowEditor

// ワークフローデータを検査
window.workflowEditor.workflow.nodes        // 全ノード  
window.workflowEditor.workflow.connections  // 全接続
window.workflowEditor.executionResults      // 実行結果

// 特定モジュールをデバッグ
window.workflowEditor.connectionManager.renderConnections()
window.workflowEditor.nodeManager.renderNodes()
```

## 🎯 開発ロードマップ

### フェーズ1: 重要なバグ修正（1週間）
1. **接続線可視性修正** - SVGレンダリングと座標計算
2. **キャンバスパン機能実装** - マウスドラッグナビゲーション  
3. **入力ノード色修正** - オレンジからティールに変更
4. **プロパティパネルタイミング修正** - 接続数更新
5. **複数出力ポートサポート追加** - ノードあたり最大3ポート

### フェーズ2: コア機能（2-3週間）
1. **実際のLLM API統合** - モック実装の置き換え
2. **データ永続化** - localStorageとファイル保存/読み込み
3. **高度な接続管理** - ビジュアルポート接続
4. **ワークフロー検証** - 構造とデータフロー検証

### フェーズ3: 高度な機能（1-2ヶ月）
1. **インポート/エクスポート機能** - JSON、コード生成
2. **バージョン管理と履歴** - アンドゥ/リドゥ、変更追跡
3. **パフォーマンス最適化** - 大規模ワークフロー処理
4. **協調編集** - マルチユーザーサポート

## 🤝 貢献

### コードスタイルガイドライン
1. **ES6+標準**: クラスベースアーキテクチャを用いた現代的JavaScript
2. **モジュラー設計**: 適切なモジュールで関心事を分離
3. **明確な命名**: 説明的な変数とメソッド名を使用
4. **ドキュメンテーション**: AIアシスタントガイダンス用CLAUDE.mdを更新

### テスト
- **UIテスト**: ビジュアルとインタラクションテスト用Playwright
- **手動テスト**: 複数ブラウザでテスト（Chrome、Firefox、Safari）
- **コンソールテスト**: ブラウザコンソールデバッグユーティリティを使用

### 新しいノードタイプの追加
1. `workflow-editor.js`の`nodeTypes`配列に定義を追加
2. `getIcon()`メソッドにアイコンSVGを追加
3. `node-manager.js`の`getDefaultNodeData()`メソッドでデフォルトデータを定義
4. `ui-manager.js`の`getNodeSpecificFields()`メソッドにプロパティフォームを追加
5. `workflow-executor.js`の`executeNode()`メソッドで実行ロジックを実装

## 📄 ファイル構造概要

| ファイル | 行数 | 目的 |
|---------|------|------|
| `workflow-editor.js` | ~1000 | メインコーディネーターと委譲、自動保存システム |
| `ui-manager.js` | ~1000+ | プロパティパネルとUI管理、保存・クリア機能 |
| `connection-manager.js` | ~490 | 接続ロジックとSVGレンダリング、レイアウト検知 |
| `event-handlers.js` | ~400 | マウス/キーボードイベント処理 |
| `node-manager.js` | ~740 | ノード作成と管理、ポート設定 |
| `workflow-executor.js` | ~150 | ワークフロー実行エンジン |
| `debug-monitor.js` | ~340 | デバッグインフラストラクチャ |
| `llm.js` | ~100 | LLM API統合（モック） |
| `styles.css` | ~850 | Tailwindベーススタイリング |
| `index.html` | ~325 | シングルページアプリケーションレイアウト |

---

## 🔍 デバッグと開発

### ブラウザコンソールコマンド
```javascript
// リアルタイムワークフロー検査
window.workflowEditor.workflow.nodes         // 全ノード
window.workflowEditor.workflow.connections   // 全接続  
window.workflowEditor.executionResults       // 最後の実行結果

// デバッグユーティリティ
window.debugWorkflow()     // 完全な状態ダンプ
window.validateWorkflow()  // 接続検証
window.cleanupWorkflow()   // 無効な接続削除
window.rerenderWorkflow()  // 完全な再レンダリング強制
```

### モジュール構造
- `workflow-editor.js`（~1000行） - デバッグユーティリティ付きメインオーケストレーター
- `connection-manager.js`（~490行） - 強化されたSVGレンダリングシステム
- `ui-manager.js`（~1000+行） - プロパティパネルとUI管理
- `event-handlers.js`（~400行） - ユーザーインタラクション処理
- `node-manager.js`（~740行） - ノードライフサイクル管理
- `workflow-executor.js`（~150行） - 実行エンジン
- `debug-monitor.js`（~340行） - デバッグインフラストラクチャ

## 📊 現在のステータス

**プロジェクトバージョン**: v0.3.x  
**アーキテクチャ**: デバッグインフラストラクチャ付きモジュラーES6クラス  
**最終更新**: 2024年12月  
**開発ステータス**: アクティブ - 接続レンダリングとUX改善

### 主要指標
- **総コード**: 9つのコアファイルで4,000+行
- **動作機能**: 80%（全UIコンポーネント、ワークフローロジック、デバッグツール）
- **重要問題**: 2つの高優先度（接続可視性、キャンバスパン）
- **中程度問題**: 3つ（スタイリング、タイミング、マルチポートサポート）
- **テストカバレッジ**: 包括的デバッグユーティリティによる手動テスト

### 開発フォーカス
- **第1週**: 接続線レンダリングとキャンバスナビゲーション修正
- **第2週**: UI/UX改善と複数出力ポートサポート
- **第3週**: 実際のLLM API統合とデータ永続化
- **第4週**: パフォーマンス最適化と高度な機能

**詳細なAIアシスタントガイダンスについては、[CLAUDE.md](./CLAUDE.md)を参照**