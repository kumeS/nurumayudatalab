<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êú™Êù•Ë®òÊÜ∂„ÅÆÂÖ±Ââµ„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #764ba2;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: #667eea;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #764ba2;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 30px;
            height: 30px;
            background: #764ba2;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #764ba2;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-btn {
            background: #764ba2;
            color: white;
        }

        .primary-btn:hover {
            background: #6a3d91;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .secondary-btn {
            background: #e0e0e0;
            color: #666;
        }

        .secondary-btn:hover {
            background: #d0d0d0;
        }

        /* „Çµ„É≥„Éó„É´Ë®òÊÜ∂„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .sample-memory-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .sample-btn {
            flex: none;
            padding: 6px 12px;
            font-size: 14px;
            background: #f8f9fa;
            color: #764ba2;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .sample-btn:hover {
            background: #764ba2;
            color: white;
            transform: translateY(-1px);
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .scenario-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .scenario-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-card.selected {
            border-color: #764ba2;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }

        .scenario-card h4 {
            color: #764ba2;
            margin-bottom: 10px;
        }

        .scenario-card p {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .memory-output {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            margin-top: 20px;
        }

        .memory-output h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .memory-timeline {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .timeline-item {
            display: flex;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #764ba2;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .timeline-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .timeline-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #764ba2;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="header fade-in">
            <h1>Êú™Êù•Ë®òÊÜ∂„ÅÆÂÖ±Ââµ„ÉÑ„Éº„É´</h1>
            <p class="subtitle">"„ÇÇ„Åó„ÇÇ"„ÅÆ‰∫∫Áîü„ÇíAI„Å®Ââµ„Çä„ÄÅ‰ªñËÄÖ„Å®‰∫§Êèõ„Åß„Åç„Çã‰ªÆÊÉ≥‰ΩìÈ®ì„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</p>
            <div class="nav-links">
                <a href="index.html">‚Üê ÂÖ±ÊÑü„Çπ„Éö„ÇØ„Éà„É©„É†„Éª„É°„ÉÉ„Çª„É≥„Ç∏„É£„Éº</a>
                <a href="#timeline">„Çø„Ç§„É†„É©„Ç§„É≥</a>
                <a href="#sharing">ÂÖ±ÊúâÊ©üËÉΩ</a>
            </div>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="main-content">
            <!-- ÁèæÂÆüË®òÊÜ∂ÂÖ•Âäõ -->
            <div class="section fade-in">
                <h2 class="section-title">
                    <span class="icon">üí≠</span>
                    ÁèæÂÆüË®òÊÜ∂„ÅÆÂÖ•Âäõ
                </h2>

                <div class="form-group">
                    <label for="realMemory">Â§ßÂàá„Å™Ë®òÊÜ∂„ÇÑ„Ç®„Éî„ÇΩ„Éº„Éâ</label>
                    <textarea id="realMemory" placeholder="‰æãÔºöÈ´òÊ†°ÊúÄÂæå„ÅÆÊñáÂåñÁ•≠„Åß„ÄÅ„ÇØ„É©„Çπ„ÅÆ„Åø„Çì„Å™„Å®Â§úÈÅÖ„Åè„Åæ„ÅßÊ∫ñÂÇô„Çí„Åó„Å¶„ÅÑ„ÅüÊôÇ„ÅÆ„Åì„Å®„ÄÇÂèãÈÅî„Å®Á¨ë„ÅÑ„Å™„Åå„Çâ‰ΩúÊ•≠„Åó„Å¶„ÅÑ„ÇãÊôÇÈñì„Åå„Å®„Å¶„ÇÇÊ•Ω„Åó„Åè„Å¶..."></textarea>
                </div>

                <!-- „Çµ„É≥„Éó„É´Ë®òÊÜ∂„Éú„Çø„É≥ -->
                <div class="sample-memories" style="margin: 10px 0;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">„Çµ„É≥„Éó„É´Ë®òÊÜ∂:</div>
                    <div class="sample-memory-buttons">
                        <button class="sample-btn" onclick="insertSampleMemory('family')">ÂÆ∂ÊóèÊóÖË°å</button>
                        <button class="sample-btn" onclick="insertSampleMemory('school')">Â≠¶Ê†°ÁîüÊ¥ª</button>
                        <button class="sample-btn" onclick="insertSampleMemory('achievement')">ÈÅîÊàê‰ΩìÈ®ì</button>
                        <button class="sample-btn" onclick="insertSampleMemory('friendship')">ÂèãÊÉÖ</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="memoryCategory">Ë®òÊÜ∂„ÅÆ„Ç´„ÉÜ„Ç¥„É™</label>
                    <select id="memoryCategory">
                        <option value="family">ÂÆ∂Êóè„ÉªË¶™Êóè</option>
                        <option value="education">ÊïôËÇ≤„ÉªÂ≠¶Áøí</option>
                        <option value="friendship">Âèã‰∫∫„Éª‰∫∫ÈñìÈñ¢‰øÇ</option>
                        <option value="achievement">ÈÅîÊàê„ÉªÊàêÂäü‰ΩìÈ®ì</option>
                        <option value="challenge">Âõ∞Èõ£„ÉªÊå´Êäò‰ΩìÈ®ì</option>
                        <option value="travel">ÊóÖË°å„ÉªÂÜíÈô∫</option>
                        <option value="work">‰ªï‰∫ã„Éª„Ç≠„É£„É™„Ç¢</option>
                        <option value="love">ÊÅãÊÑõ„ÉªÁµêÂ©ö</option>
                        <option value="creative">Ââµ‰Ωú„ÉªË°®Áèæ</option>
                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                    </select>
                </div>

                <div class="button-group">
                    <button class="primary-btn" onclick="analyzeRealMemory()">
                        <span>üîç</span>
                        Ë®òÊÜ∂„ÇíÂàÜÊûê
                    </button>
                    <button class="secondary-btn" onclick="clearMemoryInput()">
                        <span>üóëÔ∏è</span>
                        „ÇØ„É™„Ç¢
                    </button>
                </div>
            </div>

            <!-- if‰∏ñÁïåË®≠ÂÆö -->
            <div class="section fade-in">
                <h2 class="section-title">
                    <span class="icon">üåç</span>
                    "if‰∏ñÁïå"„Éë„É©„É°„Éº„ÇøË®≠ÂÆö
                </h2>

                <div class="form-group">
                    <label>‰∫ãÂâçË®≠ÂÆö„Ç∑„Éä„É™„Ç™</label>
                    <div class="scenario-grid">
                        <div class="scenario-card" onclick="selectScenario('different-era')">
                            <h4>Áï∞„Å™„ÇãÊôÇ‰ª£</h4>
                            <p>Ê±üÊà∏ÊôÇ‰ª£„ÄÅÊòéÊ≤ªÊôÇ‰ª£„ÄÅÊú™Êù•Á§æ‰ºö„Å™„Å©„ÅßÂêå„Åò‰ΩìÈ®ì„Çí„Åó„Åü„ÇâÔºü</p>
                        </div>
                        <div class="scenario-card" onclick="selectScenario('different-culture')">
                            <h4>Áï∞ÊñáÂåñÂúè</h4>
                            <p>„Ç¢„É°„É™„Ç´„ÄÅ„É®„Éº„É≠„ÉÉ„Éë„ÄÅ„Ç¢„Éï„É™„Ç´„Å™„Å©Áï∞„Å™„ÇãÊñáÂåñ„ÅßËÇ≤„Å£„Åü„ÇâÔºü</p>
                        </div>
                        <div class="scenario-card" onclick="selectScenario('different-family')">
                            <h4>Áï∞„Å™„ÇãÂÆ∂ÊóèÊßãÊàê</h4>
                            <p>‰∏Ä‰∫∫„Å£Â≠ê„ÄÅÂ§ßÂÆ∂Êóè„ÄÅÂõΩÈöõÁµêÂ©öÂÆ∂Â∫≠„Å™„Å©„ÅßËÇ≤„Å£„Åü„ÇâÔºü</p>
                        </div>
                        <div class="scenario-card" onclick="selectScenario('different-socioeconomic')">
                            <h4>Áï∞„Å™„ÇãÁ§æ‰ºöÈöéÂ±§</h4>
                            <p>ÂØåË£ïÂ±§„ÄÅ‰∏≠ÈñìÂ±§„ÄÅÂä¥ÂÉçËÄÖÈöéÁ¥ö„Å™„Å©Áï∞„Å™„ÇãÁí∞Â¢É„ÅßËÇ≤„Å£„Åü„ÇâÔºü</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customScenario">„Ç´„Çπ„Çø„É†„Ç∑„Éä„É™„Ç™</label>
                    <textarea id="customScenario" placeholder="Áã¨Ëá™„ÅÆ„Äå„ÇÇ„Åó„ÇÇ„Äç„Ç∑„Éä„É™„Ç™„ÇíËá™Áî±„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>

                <div class="button-group">
                    <button class="primary-btn" onclick="generateIfMemory()">
                        <span>‚ú®</span>
                        ifË®òÊÜ∂„ÇíÁîüÊàê
                    </button>
                    <button class="secondary-btn" onclick="randomScenario()">
                        <span>üé≤</span>
                        „É©„É≥„ÉÄ„É†ÁîüÊàê
                    </button>
                </div>
            </div>
        </div>

        <!-- ÁîüÊàêÁµêÊûúË°®Á§∫ -->
        <div class="section fade-in">
            <h2 class="section-title">
                <span class="icon">üìñ</span>
                ÁîüÊàê„Åï„Çå„ÅüifË®òÊÜ∂
            </h2>
            <div class="memory-output" id="memoryOutput">
                <p style="color: #999; text-align: center;">Ë®òÊÜ∂„ÇíÂÖ•Âäõ„Åó„Å¶ifË®òÊÜ∂ÁîüÊàê„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
        </div>

        <!-- „Çø„Ç§„É†„É©„Ç§„É≥ -->
        <div class="memory-timeline fade-in" id="timeline">
            <h2 class="section-title">
                <span class="icon">‚è∞</span>
                ifË®òÊÜ∂„Çø„Ç§„É†„É©„Ç§„É≥
            </h2>
            <div id="timelineContent">
                <p style="color: #999; text-align: center;">„Åæ„Å†ifË®òÊÜ∂„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentRealMemory = null;
        let currentScenario = null;
        let ifMemoryHistory = [];

        // ÁèæÂÆüË®òÊÜ∂ÂàÜÊûê
        async function analyzeRealMemory() {
            const realMemory = document.getElementById('realMemory').value.trim();
            const category = document.getElementById('memoryCategory').value;

            if (!realMemory) {
                alert('Ë®òÊÜ∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®òÈå≤ÔºàÂÜçË©¶Ë°åÁî®Ôºâ
            setLastAction('analyzeMemory', { realMemory, category });

            showLoading('init');

            try {
                showLoading('analysis');
                const analysis = await analyzeMemoryWithAI(realMemory, category);
                
                showLoading('complete');
                currentRealMemory = {
                    content: realMemory,
                    category: category,
                    analysis: analysis,
                    timestamp: new Date()
                };

                // ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                document.getElementById('memoryOutput').innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #e8f5e8; border-radius: 10px; color: #2e7d32;">
                        <p><strong>‚úÖ Ë®òÊÜ∂„ÅÆÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü</strong></p>
                        <p style="margin-top: 10px; font-size: 14px;">if‰∏ñÁïå„ÇíË®≠ÂÆö„Åó„Å¶ifË®òÊÜ∂„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                `;
            } catch (error) {
                console.error('Ë®òÊÜ∂ÂàÜÊûê„Ç®„É©„Éº:', error);
                if (error instanceof APIError) {
                    showDetailedError(error);
                } else {
                    document.getElementById('memoryOutput').innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 10px; color: #c62828;">
                            <p><strong>‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong></p>
                            <p style="margin-top: 10px; font-size: 14px;">${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // AIË®òÊÜ∂ÂàÜÊûê
        async function analyzeMemoryWithAI(memory, category) {
            const prompt = [
                {
                    role: "system",
                    content: `„ÅÇ„Å™„Åü„ÅØË®òÊÜ∂ÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰∏é„Åà„Çâ„Çå„ÅüË®òÊÜ∂„ÇíÂàÜÊûê„Åó„ÄÅ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅÆJSON„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

{
  "keyElements": ["ÈáçË¶Å„Å™Ë¶ÅÁ¥†1", "ÈáçË¶Å„Å™Ë¶ÅÁ¥†2", ...],
  "emotions": ["ÊÑüÊÉÖ1", "ÊÑüÊÉÖ2", ...],
  "culturalContext": "ÊñáÂåñÁöÑËÉåÊôØ„ÅÆË™¨Êòé",
  "relationships": ["Èñ¢‰øÇÊÄß1", "Èñ¢‰øÇÊÄß2", ...],
  "values": ["‰æ°ÂÄ§Ë¶≥1", "‰æ°ÂÄ§Ë¶≥2", ...],
  "setting": {
    "time": "ÊôÇÊúü„ÉªÊôÇ‰ª£",
    "place": "Â†¥ÊâÄ„ÉªÁí∞Â¢É",
    "social": "Á§æ‰ºöÁöÑÁä∂Ê≥Å"
  }
}`
                },
                {
                    role: "user",
                    content: `‰ª•‰∏ã„ÅÆË®òÊÜ∂„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà„Ç´„ÉÜ„Ç¥„É™: ${category}ÔºâÔºö\n\n${memory}`
                }
            ];

            const response = await callLLMAPI(prompt);
            return JSON.parse(response);
        }

        // „Ç∑„Éä„É™„Ç™ÈÅ∏Êäû
        function selectScenario(scenarioType) {
            // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Êñ∞„Åó„ÅÑÈÅ∏Êäû„Çí„Éû„Éº„ÇØ
            event.target.closest('.scenario-card').classList.add('selected');

            const scenarios = {
                'different-era': {
                    type: 'Áï∞„Å™„ÇãÊôÇ‰ª£',
                    options: ['Ê±üÊà∏ÊôÇ‰ª£Êú´Êúü', 'ÊòéÊ≤ªÁ∂≠Êñ∞Êúü', 'Â§ßÊ≠£„É≠„Éû„É≥', 'Êà¶ÂæåÂæ©ËààÊúü', 'È´òÂ∫¶ÁµåÊ∏àÊàêÈï∑Êúü', '2050Âπ¥„ÅÆÊú™Êù•Á§æ‰ºö']
                },
                'different-culture': {
                    type: 'Áï∞ÊñáÂåñÂúè',
                    options: ['„Ç¢„É°„É™„Ç´‰∏≠Ë•øÈÉ®', '„Éï„É©„É≥„ÇπÁî∞ËàéÁî∫', '„Ç§„É≥„ÉâÂ§ßÈÉΩÂ∏Ç', '„Ç¢„Éï„É™„Ç´ÈÉ®ÊóèÁ§æ‰ºö', '‰∏≠Êù±Á†ÇÊº†Âú∞Â∏Ø', 'ÂåóÊ¨ßÊ£ÆÊûóÂú∞Âüü']
                },
                'different-family': {
                    type: 'Áï∞„Å™„ÇãÂÆ∂ÊóèÊßãÊàê',
                    options: ['Â§ßÂÆ∂Êóè(Á•ñÁà∂ÊØç„ÉªË¶™ÊàöÂêåÂ±Ö)', '‰∏Ä‰∫∫„Å£Â≠êÂÆ∂Â∫≠', 'ÂõΩÈöõÁµêÂ©öÂÆ∂Â∫≠', '„Å≤„Å®„ÇäË¶™ÂÆ∂Â∫≠', 'È§äÂ≠êÁ∏ÅÁµÑÂÆ∂Â∫≠', 'ÂÖ±Âêå‰ΩìËÇ≤ÂÖê']
                },
                'different-socioeconomic': {
                    type: 'Áï∞„Å™„ÇãÁ§æ‰ºöÈöéÂ±§',
                    options: ['ÂØåË£ïÂ±§(Ë≤°Èñ•ÂÆ∂Á≥ª)', 'Áü•Ë≠òÈöéÁ¥ö(Â≠¶ËÄÖÂÆ∂Á≥ª)', 'ÂïÜÂ∑•Ê•≠ËÄÖÈöéÁ¥ö', 'Ëæ≤Ê•≠Âæì‰∫ãËÄÖ', 'Ëä∏Ë°ìÂÆ∂„Ç≥„Éü„É•„Éã„ÉÜ„Ç£', 'ÈÅäÁâßÊ∞ëÁ§æ‰ºö']
                }
            };

            currentScenario = scenarios[scenarioType];
            
            // „Ç´„Çπ„Çø„É†„Ç∑„Éä„É™„Ç™Ê¨Ñ„ÇíÊõ¥Êñ∞
            const randomOption = currentScenario.options[Math.floor(Math.random() * currentScenario.options.length)];
            document.getElementById('customScenario').value = 
                `${currentScenario.type}: ${randomOption}„ÅßÂêå„Åò‰ΩìÈ®ì„Çí„Åó„ÅüÂ†¥Âêà`;
        }

        // „É©„É≥„ÉÄ„É†„Ç∑„Éä„É™„Ç™ÁîüÊàê
        function randomScenario() {
            const allScenarios = ['different-era', 'different-culture', 'different-family', 'different-socioeconomic'];
            const randomScenario = allScenarios[Math.floor(Math.random() * allScenarios.length)];
            selectScenario(randomScenario);
        }

        // ifË®òÊÜ∂ÁîüÊàê
        async function generateIfMemory() {
            if (!currentRealMemory) {
                alert('„Åæ„ÅöÁèæÂÆü„ÅÆË®òÊÜ∂„ÇíÂÖ•Âäõ„ÉªÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const customScenario = document.getElementById('customScenario').value.trim();
            if (!customScenario) {
                alert('if„Ç∑„Éä„É™„Ç™„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË®òÈå≤ÔºàÂÜçË©¶Ë°åÁî®Ôºâ
            setLastAction('generateMemory', { scenario: customScenario });

            showLoading('init');

            try {
                showLoading('scenario');
                
                showLoading('generation');
                const ifMemory = await generateIfMemoryWithAI(currentRealMemory, customScenario);
                
                showLoading('complete');
                displayIfMemory(ifMemory);
                addToTimeline(ifMemory);
            } catch (error) {
                console.error('ifË®òÊÜ∂ÁîüÊàê„Ç®„É©„Éº:', error);
                if (error instanceof APIError) {
                    showDetailedError(error);
                } else {
                    document.getElementById('memoryOutput').innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 10px; color: #c62828;">
                            <p><strong>‚ùå ifË®òÊÜ∂ÁîüÊàê„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong></p>
                            <p style="margin-top: 10px; font-size: 14px;">${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // AI„Å´„Çà„ÇãifË®òÊÜ∂ÁîüÊàê
        async function generateIfMemoryWithAI(realMemory, scenario) {
            const prompt = [
                {
                    role: "system",
                    content: `„ÅÇ„Å™„Åü„ÅØifË®òÊÜ∂ÁîüÊàê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÁèæÂÆü„ÅÆË®òÊÜ∂„ÇíÁï∞„Å™„ÇãÊù°‰ª∂‰∏ã„Åß„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Å®„Åó„Å¶ÂÜçÊßãÁØâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅÆJSON„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
{
  "ifStory": "ifË®òÊÜ∂„ÅÆË©≥Á¥∞„Å™„Çπ„Éà„Éº„É™„Éº",
  "culturalDifferences": ["ÊñáÂåñÁöÑÈÅï„ÅÑ1", "ÊñáÂåñÁöÑÈÅï„ÅÑ2", ...],
  "valueChanges": ["‰æ°ÂÄ§Ë¶≥„ÅÆÂ§âÂåñ1", "‰æ°ÂÄ§Ë¶≥„ÅÆÂ§âÂåñ2", ...],
  "newPerspectives": ["Êñ∞„Åó„ÅÑË¶ñÁÇπ1", "Êñ∞„Åó„ÅÑË¶ñÁÇπ2", ...],
  "emotionalImpact": "ÊÑüÊÉÖÁöÑ„Å™ÂΩ±Èüø„ÅÆÂàÜÊûê",
  "lessonsLearned": ["Â≠¶„Å≥1", "Â≠¶„Å≥2", ...],
  "comparisonWithReality": "ÁèæÂÆü„Å®„ÅÆÊØîËºÉ„ÉªËÄÉÂØü"
}`
                },
                {
                    role: "user",
                    content: `ÁèæÂÆüË®òÊÜ∂: ${realMemory.content}
ÂàÜÊûêÁµêÊûú: ${JSON.stringify(realMemory.analysis)}
if„Ç∑„Éä„É™„Ç™: ${scenario}

„Åì„ÅÆÊù°‰ª∂„ÅßifË®òÊÜ∂„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                }
            ];

            const response = await callLLMAPI(prompt);
            const ifMemory = JSON.parse(response);
            
            return {
                ...ifMemory,
                originalMemory: realMemory,
                scenario: scenario,
                timestamp: new Date()
            };
        }

        // ifË®òÊÜ∂Ë°®Á§∫
        function displayIfMemory(ifMemory) {
            const output = document.getElementById('memoryOutput');
            
            output.innerHTML = `
                <h3>ÁîüÊàê„Åï„Çå„ÅüifË®òÊÜ∂</h3>
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #764ba2;">
                    <p style="line-height: 1.6; margin-bottom: 15px;">${ifMemory.ifStory}</p>
                </div>
                
                <h4 style="color: #764ba2; margin: 20px 0 10px 0;">ÊñáÂåñÁöÑÈÅï„ÅÑ</h4>
                <ul style="margin-left: 20px; line-height: 1.6;">
                    ${ifMemory.culturalDifferences.map(diff => `<li>${diff}</li>`).join('')}
                </ul>
                
                <h4 style="color: #764ba2; margin: 20px 0 10px 0;">‰æ°ÂÄ§Ë¶≥„ÅÆÂ§âÂåñ</h4>
                <ul style="margin-left: 20px; line-height: 1.6;">
                    ${ifMemory.valueChanges.map(change => `<li>${change}</li>`).join('')}
                </ul>
                
                <h4 style="color: #764ba2; margin: 20px 0 10px 0;">Êñ∞„Åó„ÅÑË¶ñÁÇπ</h4>
                <ul style="margin-left: 20px; line-height: 1.6;">
                    ${ifMemory.newPerspectives.map(perspective => `<li>${perspective}</li>`).join('')}
                </ul>
                
                <h4 style="color: #764ba2; margin: 20px 0 10px 0;">ÁèæÂÆü„Å®„ÅÆÊØîËºÉ</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; line-height: 1.6;">
                    ${ifMemory.comparisonWithReality}
                </div>
            `;
        }

        // „Çø„Ç§„É†„É©„Ç§„É≥„Å´ËøΩÂä†
        function addToTimeline(ifMemory) {
            ifMemoryHistory.unshift(ifMemory);
            updateTimeline();
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('ifMemoryHistory', JSON.stringify(ifMemoryHistory));
        }

        // „Çø„Ç§„É†„É©„Ç§„É≥Êõ¥Êñ∞
        function updateTimeline() {
            const timelineContent = document.getElementById('timelineContent');
            
            if (ifMemoryHistory.length === 0) {
                timelineContent.innerHTML = '<p style="color: #999; text-align: center;">„Åæ„Å†ifË®òÊÜ∂„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }

            timelineContent.innerHTML = ifMemoryHistory.map((memory, index) => `
                <div class="timeline-item fade-in">
                    <div class="timeline-content">
                        <div class="timeline-date">${formatTimestamp(memory.timestamp)}</div>
                        <div class="timeline-title">ifË®òÊÜ∂ #${ifMemoryHistory.length - index}</div>
                        <div class="timeline-description">
                            <strong>„Ç∑„Éä„É™„Ç™:</strong> ${memory.scenario}<br>
                            <strong>ÂÖÉË®òÊÜ∂:</strong> ${memory.originalMemory.content.substring(0, 100)}...
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // „Ç´„Çπ„Çø„É†„Ç®„É©„Éº„ÇØ„É©„Çπ
        class APIError extends Error {
            constructor(message, type, status, details = {}) {
                super(message);
                this.name = 'APIError';
                this.type = type;
                this.status = status;
                this.details = details;
                this.timestamp = new Date();
            }
        }

        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜ
        let isOnline = navigator.onLine;
        
        window.addEventListener('online', () => {
            isOnline = true;
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
        });

        // LLM APIÂëº„Å≥Âá∫„ÅóÔºàÂº∑ÂåñÁâà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Ôºâ
        async function callLLMAPI(messages, retryCount = 0) {
            const maxRetries = 3;
            const apiUrl = 'https://nurumayu-worker.skume-bioinfo.workers.dev/';
            
            // „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!isOnline) {
                throw new APIError('„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„Åß„Åô„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'OFFLINE', 0);
            }

            const requestData = {
                model: "meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8",
                temperature: 0.7,
                stream: false,
                max_completion_tokens: 2000,
                messages: messages
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorDetails = {
                        status: response.status,
                        statusText: response.statusText,
                        url: apiUrl
                    };

                    if (response.status === 429) {
                        throw new APIError('APIÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'RATE_LIMIT', response.status, errorDetails);
                    } else if (response.status === 503) {
                        throw new APIError('API„Çµ„Éº„Éê„Éº„Åå‰∏ÄÊôÇÁöÑ„Å´Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ', 'SERVICE_UNAVAILABLE', response.status, errorDetails);
                    } else if (response.status >= 500) {
                        throw new APIError('API„Çµ„Éº„Éê„Éº„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'SERVER_ERROR', response.status, errorDetails);
                    } else {
                        throw new APIError(`APIÂëº„Å≥Âá∫„Åó„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü (${response.status})`, 'API_ERROR', response.status, errorDetails);
                    }
                }

                const data = await response.json();
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else if (data.answer) {
                    return data.answer;
                } else {
                    throw new APIError('APIÂøúÁ≠î„Å´ÊúüÂæÖ„Åï„Çå„Çã„Éï„Ç£„Éº„É´„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'INVALID_RESPONSE', response.status);
                }

            } catch (error) {
                if (error instanceof APIError) {
                    throw error;
                }

                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„É™„Éà„É©„Ç§
                if (retryCount < maxRetries && (error.name === 'TypeError' || error.message.includes('fetch'))) {
                    console.warn(`APIÂëº„Å≥Âá∫„ÅóÂ§±Êïó„ÄÅ„É™„Éà„É©„Ç§ ${retryCount + 1}/${maxRetries}:`, error.message);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                    return callLLMAPI(messages, retryCount + 1);
                }

                throw new APIError(`„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: ${error.message}`, 'NETWORK_ERROR', 0, { originalError: error.message });
            }
        }

        // „Ç®„É©„ÉºË°®Á§∫ÔºàË©≥Á¥∞ÁâàÔºâ
        function showDetailedError(error) {
            const errorMessages = {
                'OFFLINE': 'ÁèæÂú®„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„Åß„Åô„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'RATE_LIMIT': 'APIÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'SERVICE_UNAVAILABLE': 'API„Çµ„Éº„Éì„Çπ„Åå‰∏ÄÊôÇÁöÑ„Å´Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'SERVER_ERROR': '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'NETWORK_ERROR': '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'INVALID_RESPONSE': 'API„Åã„Çâ„ÅÆÂøúÁ≠î„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ'
            };

            const userMessage = errorMessages[error.type] || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
            
            document.getElementById('memoryOutput').innerHTML = `
                <div style="padding: 20px; background: #ffebee; border-radius: 10px; color: #c62828; border-left: 4px solid #f44336;">
                    <p><strong>‚ùå ${userMessage}</strong></p>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; font-size: 12px; color: #666;">ÊäÄË°ìÁöÑË©≥Á¥∞</summary>
                        <pre style="font-size: 11px; margin-top: 5px; color: #666; background: #f5f5f5; padding: 8px; border-radius: 4px; overflow-x: auto;">„Ç®„É©„Éº„Çø„Ç§„Éó: ${error.type}
„Çπ„ÉÜ„Éº„Çø„Çπ: ${error.status}
ÊôÇÂàª: ${error.timestamp.toLocaleString()}
Ë©≥Á¥∞: ${JSON.stringify(error.details, null, 2)}</pre>
                    </details>
                    <button onclick="retryLastAction()" style="margin-top: 10px; padding: 8px 16px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üîÑ ÂÜçË©¶Ë°å
                    </button>
                </div>
            `;
        }

        // ÂÜçË©¶Ë°åÊ©üËÉΩ
        let lastAction = null;
        let lastParams = null;

        function setLastAction(action, params) {
            lastAction = action;
            lastParams = params;
        }

        function retryLastAction() {
            if (lastAction === 'analyzeMemory') {
                analyzeRealMemory();
            } else if (lastAction === 'generateMemory') {
                generateIfMemory();
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function showLoading(stage = 'init') {
            const output = document.getElementById('memoryOutput');
            
            const stageMessages = {
                'init': { text: 'AIÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...', progress: 10 },
                'analysis': { text: 'Ë®òÊÜ∂„ÇíÂàÜÊûê‰∏≠...', progress: 30 },
                'scenario': { text: 'if‰∏ñÁïå„ÇíÊßãÁØâ‰∏≠...', progress: 60 },
                'generation': { text: 'ifË®òÊÜ∂„ÇíÁîüÊàê‰∏≠...', progress: 90 },
                'complete': { text: 'ÁîüÊàêÂÆå‰∫Ü', progress: 100 }
            };
            
            const stageInfo = stageMessages[stage] || stageMessages['init'];
            
            output.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin: 15px 0 5px 0; color: #764ba2; font-weight: 500;">${stageInfo.text}</p>
                    <div style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; margin: 10px 0; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #764ba2, #667eea); width: ${stageInfo.progress}%; transition: width 0.5s ease; border-radius: 2px;"></div>
                    </div>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Âá¶ÁêÜÊôÇÈñì„ÅÆÁõÆÂÆâ: 5-8Áßí</p>
                </div>
            `;
        }

        function hideLoading() {
            // showLoadingÂæå„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Çã„ÅÆ„Åß„ÄÅÁâπÂà•„Å™Âá¶ÁêÜ„ÅØ‰∏çË¶Å
        }

        function clearMemoryInput() {
            document.getElementById('realMemory').value = '';
            document.getElementById('customScenario').value = '';
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            currentRealMemory = null;
            currentScenario = null;
        }

        // „Çµ„É≥„Éó„É´Ë®òÊÜ∂ÊåøÂÖ•
        function insertSampleMemory(type) {
            const sampleMemories = {
                'family': 'Â∞èÂ≠¶3Âπ¥Áîü„ÅÆÂ§è„ÄÅÂÆ∂Êóè„Åß„Ç≠„É£„É≥„Éó„Å´Ë°å„Å£„ÅüÊôÇ„ÅÆ„Åì„Å®„Åß„Åô„ÄÇÁà∂„Å®‰∏ÄÁ∑í„Å´„ÉÜ„É≥„Éà„ÇíÁ´ã„Å¶„Å¶„ÄÅÊØç„Å®Â¶π„Å®Â∑ù„ÅßÈÅä„Å≥„Åæ„Åó„Åü„ÄÇÂ§ú„ÅØÁÑö„ÅçÁÅ´„ÇíÂõ≤„Çì„Åß„Éû„Ç∑„É•„Éû„É≠„ÇíÁÑº„ÅÑ„Å¶„ÄÅÊòüÁ©∫„ÇíË¶ã„Å™„Åå„ÇâÂÆ∂Êóè„Åß„Åä„Åó„ÇÉ„Åπ„Çä„Åó„Åæ„Åó„Åü„ÄÇÊôÆÊÆµÂøô„Åó„ÅÑÁà∂„Å®Èï∑ÊôÇÈñìÈÅé„Åî„Åõ„Å¶„ÄÅ„Å®„Å¶„ÇÇÂ¨â„Åó„Åã„Å£„ÅüË®òÊÜ∂„Åß„Åô„ÄÇ',
                'school': 'È´òÊ†°ÊúÄÂæå„ÅÆÊñáÂåñÁ•≠„ÅÆÊ∫ñÂÇô„Åß„ÄÅ„ÇØ„É©„Çπ„ÅÆ„Åø„Çì„Å™„Å®Â§úÈÅÖ„Åè„Åæ„ÅßÊïôÂÆ§„Å´ÊÆã„Å£„Å¶‰ΩúÊ•≠„Åó„Å¶„ÅÑ„ÅüÊôÇ„ÅÆ„Åì„Å®„Åß„Åô„ÄÇÁñ≤„Çå„Å¶„ÅÑ„Çã„ÅØ„Åö„Å™„ÅÆ„Å´„ÄÅÂèãÈÅî„Å®Á¨ë„ÅÑ„Å™„Åå„ÇâÁúãÊùø„Çí‰Ωú„Å£„Åü„Çä„ÄÅÂá∫„ÅóÁâ©„ÅÆÁ∑¥Áøí„Çí„Åó„Åü„Çä„Åó„Å¶„ÅÑ„ÇãÊôÇÈñì„Åå„Å®„Å¶„ÇÇÊ•Ω„Åó„Åè„Å¶„ÄÅ„Äå„Åì„ÅÆÊôÇÈñì„Åå„Åö„Å£„Å®Á∂ö„Åë„Å∞„ÅÑ„ÅÑ„ÅÆ„Å´„Äç„Å®ÊÄù„ÅÑ„Åæ„Åó„Åü„ÄÇ',
                'achievement': '‰∏≠Â≠¶ÊôÇ‰ª£„ÄÅËã¶Êâã„Å†„Å£„ÅüÊï∞Â≠¶„ÅÆ„ÉÜ„Çπ„Éà„ÅßÂàù„ÇÅ„Å¶90ÁÇπ‰ª•‰∏ä„ÇíÂèñ„Å£„ÅüÊôÇ„ÅÆ„Åì„Å®„Åß„Åô„ÄÇÊØéÊó•ÊîæË™≤Âæå„Å´ÂÖàÁîü„Å´Ë≥™Âïè„Åó„Å¶„ÄÅÂèãÈÅî„Å®‰∏ÄÁ∑í„Å´ÂãâÂº∑‰ºö„Çí„Åó„Å¶„ÄÅË´¶„ÇÅ„Åö„Å´È†ëÂºµ„ÇäÁ∂ö„Åë„Åæ„Åó„Åü„ÄÇÁµêÊûú„ÇíË¶ã„ÅüÊôÇ„ÅÆÈÅîÊàêÊÑü„Å®„ÄÅÂÖàÁîü„ÇÑÂèãÈÅî„Åå‰∏ÄÁ∑í„Å´Âñú„Çì„Åß„Åè„Çå„ÅüÊôÇ„ÅÆÊ∞óÊåÅ„Å°„ÅØ‰ªä„Åß„ÇÇË¶ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                'friendship': 'Ëª¢Ê†°Áîü„Å®„Åó„Å¶Êñ∞„Åó„ÅÑÂ≠¶Ê†°„Å´ÂÖ•„Å£„ÅüÊôÇ„ÄÅ‰∏Ä‰∫∫„Åß„ÅÑ„ÇãÁßÅ„Å´ÊúÄÂàù„Å´Â£∞„Çí„Åã„Åë„Å¶„Åè„Çå„ÅüÂèãÈÅî„Åå„ÅÑ„Åæ„Åó„Åü„ÄÇ„ÅäÂºÅÂΩì„Çí‰∏ÄÁ∑í„Å´È£ü„Åπ„Çà„ÅÜ„Å®Ë™ò„Å£„Å¶„Åè„Çå„Å¶„ÄÅ„Åù„ÅÆÊó•„Åã„ÇâÊØéÊó•‰∏ÄÁ∑í„Å´ÈÅé„Åî„Åô„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑÁí∞Â¢É„Å∏„ÅÆ‰∏çÂÆâ„ÅåÊ∂à„Åà„Å¶„ÄÅ„Åù„ÅÆÂèãÈÅî„ÅÆ„Åä„Åã„Åí„ÅßÂ≠¶Ê†°ÁîüÊ¥ª„ÅåÊ•Ω„Åó„Åè„Å™„Çä„Åæ„Åó„Åü„ÄÇ'
            };

            const categories = {
                'family': 'family',
                'school': 'education',
                'achievement': 'achievement',
                'friendship': 'friendship'
            };

            const memoryInput = document.getElementById('realMemory');
            const categorySelect = document.getElementById('memoryCategory');
            const sampleMemory = sampleMemories[type];
            
            if (sampleMemory) {
                memoryInput.value = sampleMemory;
                categorySelect.value = categories[type];
                memoryInput.focus();
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('ifMemoryHistory');
            if (saved) {
                try {
                    ifMemoryHistory = JSON.parse(saved);
                    updateTimeline();
                } catch (error) {
                    console.error('ifË®òÊÜ∂Â±•Ê≠¥„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó:', error);
                }
            }
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„ÅÆË®≠ÂÆö
            setupKeyboardAccessibility();
        });

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„ÅÆË®≠ÂÆö
        function setupKeyboardAccessibility() {
            // „Ç∞„É≠„Éº„Éê„É´„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', function(event) {
                // Ctrl+Enter: Ë®òÊÜ∂ÂàÜÊûêÂÆüË°å
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault();
                    if (currentRealMemory) {
                        generateIfMemory();
                    } else {
                        analyzeRealMemory();
                    }
                }
                
                // Ctrl+K: Ë®òÊÜ∂ÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
                if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                    event.preventDefault();
                    document.getElementById('realMemory').focus();
                }
                
                // Ctrl+L: ÂÖ•Âäõ„ÇØ„É™„Ç¢
                if ((event.ctrlKey || event.metaKey) && event.key === 'l') {
                    event.preventDefault();
                    clearMemoryInput();
                }
                
                // Alt+1-4: „Çµ„É≥„Éó„É´Ë®òÊÜ∂ÊåøÂÖ•
                if (event.altKey && ['1', '2', '3', '4'].includes(event.key)) {
                    event.preventDefault();
                    const types = ['family', 'school', 'achievement', 'friendship'];
                    insertSampleMemory(types[parseInt(event.key) - 1]);
                }
            });

            // ARIAÂ±ûÊÄß„ÅÆËøΩÂä†
            addAriaLabels();
            
            // „Éò„É´„Éó„Éú„Çø„É≥„ÅÆËøΩÂä†
            addKeyboardHelpButton();
        }

        // ARIAÂ±ûÊÄß„ÅÆËøΩÂä†
        function addAriaLabels() {
            // „É°„Ç§„É≥„ÅÆË¶ÅÁ¥†„Å´ARIAÂ±ûÊÄß„ÇíËøΩÂä†
            document.getElementById('realMemory').setAttribute('aria-label', 'Ë®òÊÜ∂ÂÖ•Âäõ„Ç®„É™„Ç¢„ÄÇCtrl+Enter„ÅßÂàÜÊûê„ÇíÂÆüË°å„Åó„Åæ„Åô');
            document.getElementById('memoryCategory').setAttribute('aria-label', 'Ë®òÊÜ∂„ÅÆ„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû');
            document.getElementById('customScenario').setAttribute('aria-label', 'if„Ç∑„Éä„É™„Ç™ÂÖ•Âäõ„Ç®„É™„Ç¢');
            
            // „Éú„Çø„É≥„Å´ARIAÂ±ûÊÄß„ÇíËøΩÂä†
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent.includes('Ë®òÊÜ∂„ÇíÂàÜÊûê')) {
                    button.setAttribute('aria-label', 'Ë®òÊÜ∂„ÇíÂàÜÊûê (Ctrl+Enter)');
                } else if (button.textContent.includes('ifË®òÊÜ∂„ÇíÁîüÊàê')) {
                    button.setAttribute('aria-label', 'ifË®òÊÜ∂„ÇíÁîüÊàê (Ctrl+Enter)');
                } else if (button.textContent.includes('„ÇØ„É™„Ç¢')) {
                    button.setAttribute('aria-label', 'ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢ (Ctrl+L)');
                }
            });

            // ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„Å´live region„ÇíË®≠ÂÆö
            const memoryOutput = document.getElementById('memoryOutput');
            memoryOutput.setAttribute('aria-live', 'polite');
            memoryOutput.setAttribute('aria-label', 'ifË®òÊÜ∂ÁîüÊàêÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢');
        }

        // „Éò„É´„ÉóË°®Á§∫Ê©üËÉΩ
        function showKeyboardHelp() {
            const helpText = `
                „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà:
                Ctrl+Enter: Ë®òÊÜ∂ÂàÜÊûê„ÉªifË®òÊÜ∂ÁîüÊàê
                Ctrl+K: Ë®òÊÜ∂ÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
                Ctrl+L: ÂÖ•Âäõ„ÇØ„É™„Ç¢
                Alt+1-4: „Çµ„É≥„Éó„É´Ë®òÊÜ∂ÊåøÂÖ•
                Tab: Ë¶ÅÁ¥†Èñì„ÅÆÁßªÂãï
            `;
            alert(helpText);
        }

        // „Éò„É´„Éó„Éú„Çø„É≥„ÅÆËøΩÂä†
        function addKeyboardHelpButton() {
            const helpButton = document.createElement('button');
            helpButton.textContent = 'üéπ „Ç≠„Éº„Éú„Éº„Éâ„Éò„É´„Éó';
            helpButton.className = 'secondary-btn';
            helpButton.style.position = 'fixed';
            helpButton.style.bottom = '20px';
            helpButton.style.right = '20px';
            helpButton.style.zIndex = '1000';
            helpButton.style.fontSize = '12px';
            helpButton.style.padding = '8px 12px';
            helpButton.onclick = showKeyboardHelp;
            helpButton.setAttribute('aria-label', '„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆ„Éò„É´„Éó„ÇíË°®Á§∫');
            document.body.appendChild(helpButton);
        }
    </script>
</body>
</html>