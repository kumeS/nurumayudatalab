# WebR × Optimal Transport 可視化システム

## 目的と概要

このシステムは、WebR（ブラウザ上で動作するR）を利用して最適輸送（Optimal Transport）問題を解き、点群の時間変化をインタラクティブに可視化するツールです。HTML5とJavaScriptを使用して、Rの機能をWebAssembly経由でブラウザ上に実装しています。

## システムアーキテクチャ

| コンポーネント               | 役割                                  |
| --------------------- | ----------------------------------- |
| HTML5 + Canvas        | 描画領域の提供                           |
| JavaScript (webr.mjs) | WebR の初期化／制御、パラメータ受け渡し           |
| WebR (R in WASM)      | R スクリプト実行、transport パッケージ読み込み、グラフ描画 |
| Canvas 描画コントローラ     | WebR の出力イメージを `<canvas>` に描画      |

## 主な機能

- **クラスタリングと最適輸送計算**: 各時点のデータに対して自動的に最適なクラスタ数を決定し、クラスタリングを行った後、連続する時点間で最適輸送計画を計算します。
- **複数の可視化モード**: 
  - クラスタ点群: 各時点のクラスタリング結果と輸送プランを表示
  - 密度マップ: 点群の密度分布をコンター図として表示
  - ベクトル場: 各クラスタ重心の移動をベクトル場として可視化
- **インタラクティブなパラメータ設定**: 時点数、点数、最大クラスタ数などのパラメータを調整可能
- **アニメーション機能**: 時間変化を動的に表示
- **画像保存機能**: 可視化結果をPNG画像として保存

## データフロー

```
JavaScript → WebR(R) → Canvas
  ↓             ↓        ↑
init()   →   R初期化      ｜
  ↓             ↓        ｜
evalR()  →  パッケージ読込み  ｜
  ↓             ↓        ｜
evalR()  →  canvas設定    ｜
  ↓             ↓        ｜
evalR()  →  OT計算+描画   ｜
  ↑             ↓        ｜
受信     ←  canvasImage  ｜
  ↓                      ｜
drawImage() ───────────→ ｜
```

## 使用方法

1. `index.html` ファイルをWebブラウザで開きます
2. 左側のパネルでパラメータを設定します:
   - **時点数**: 時系列データのステップ数 (3-20)
   - **各時点の点数**: 各時点でのサンプル点の数 (50-500)
   - **最大クラスタ数**: 自動決定されるクラスタ数の上限 (2-10)
   - **可視化モード**: 「クラスタ点群」「密度マップ」「ベクトル場」から選択
3. 「実行」ボタンをクリックして計算を開始します
4. 計算が完了すると、結果が右側のキャンバスに表示されます
5. 「アニメーション」ボタンをクリックすると、時間変化のアニメーションが表示されます
6. 「画像として保存」ボタンをクリックすると、現在の表示をPNG画像として保存できます

## 表示データの説明

### クラスタ点群モード
各時点で生成された2次元点群データをk-means法でクラスタリングし、連続する時点間の最適輸送計画を表示します。
- カラフルな点: クラスタごとに色分けされたデータ点
- ✕印: クラスタ重心
- 灰色の矢印: 輸送経路（矢印の太さは輸送量を反映）

### 密度マップモード
点群の2次元密度分布をカーネル密度推定（KDE）によって計算し、等高線（コンター）として可視化します。特に中央時点で詳細な密度マップを表示します。
- カラフルな点: クラスタごとに色分けされたデータ点
- 青い等高線: 密度分布のコンター

### ベクトル場モード
各時点間の最適輸送計画からバリセントリック写像を計算し、ベクトル場として可視化します。
- 金色の点: クラスタ重心
- 青い矢印: 輸送ベクトル（矢印の太さは輸送量を反映）
- 赤い数値: ベクトルの大きさ

## 技術的詳細

### 使用技術

- **WebR**: WebAssemblyを利用してブラウザ上でRを実行
- **R言語パッケージ**:
  - `transport`: 最適輸送計算
  - `cluster`: クラスタリングとシルエット解析
  - `MASS`: カーネル密度推定（密度マップモード）
- **JavaScript/HTML5/CSS**: フロントエンドインターフェース
  - TailwindCSS: レスポンシブデザイン
  - FontAwesome: アイコン

### 非機能要件

- **ブラウザ互換性**: 最新のChrome/Firefox/Safari
- **レスポンシブ**: `<canvas>` のサイズを動的に変更可能
- **パフォーマンス**: 100～500点のサンプルをリアルタイムで描画可能
- **セキュリティ**: CSP設定を遵守、外部スクリプトはHTTPS経由で取得

### アルゴリズム

1. **データ生成**: 各時点で正規分布に従う乱数点を生成（時間とともに中心が移動）
2. **クラスタリング**: シルエット幅を使用して最適なクラスタ数を自動決定し、k-means法でクラスタリング
3. **輸送プラン計算**: 連続する時点間でクラスタの重心と質量（クラスタサイズ）に基づいて最適輸送計画を計算
4. **可視化**: 選択したモードに応じて結果を可視化

### パラメータ受け渡し

JavaScript側で生成／取得したオブジェクトを文字列埋め込み (`evalR`) または仮想ファイル（`writeFile`）経由でWebR側に渡します。

## 実装状況

### 実装済み機能
- 基本的なOT可視化（クラスタ点群、密度マップ、ベクトル場）
- アニメーション機能
- 可視化モードの切り替え
- 画像保存機能
- 表示データの説明

### 部分実装
- パラメータ調整によるリアルタイム再計算
- 外部データ読み込み（現在はUI上で無効化されています）

### 計画中の機能
- Sinkhorn法（エントロピックOT）
- よりインタラクティブな可視化（ズーム・パン機能）
- CSVやJSONファイルからのデータ読み込み
- 実データセットの例を追加
- `ggplot2` + `webr::svg()` によるSVG出力・インタラクティブ化
- Web Workersを利用した計算オフロード
- レスポンシブデザインの強化

## 注意事項

- 初回実行時にはWebRの初期化とパッケージのインストールに時間がかかります
- 点数が多いほど計算に時間がかかりますが、より詳細な結果が得られます
- ブラウザのキャッシュをクリアすると、WebRの設定が初期化されます
- 現在のバージョンでは、Chrome, Firefox, Safariなどの最新版ブラウザでの使用を推奨します

## 参考文献

- Peyré, G., & Cuturi, M. (2019). Computational Optimal Transport. Foundations and Trends in Machine Learning, 11(5-6), 355-607.
- Villani, C. (2008). Optimal Transport: Old and New. Springer. 