# Image Transformation Tracker - 画像変換追跡システム

最終更新: 2025-01-22 (v3)

## 📚 Recent Bug Fixes & Improvements (2025-01-22 v3)

### 右クリックメニューの完全修正
1. **二重イベントハンドラー実装**
   - vis.jsの`oncontext`イベントとcanvas要素への直接的な`contextmenu`イベントの両方を実装
   - ブラウザ互換性を向上

2. **イベント処理の改善**
   - Canvas要素の正確な位置計算
   - DOMtoCanvas変換を使用した正確なノード検出
   - イベント伝播の適切な制御

3. **メニュー表示の安定化**
   - メニューのz-indexとpointer-eventsを強制
   - CSSでの視覚的な改善（影、ホバーエフェクト）
   - コンソールログによるデバッグ情報の出力

4. **ドラッグ制御の改善**
   - 右クリック時の一時的なドラッグ無効化
   - タイミング制御の最適化

## 📚 Recent Bug Fixes & Improvements (2025-01-22 v2)

### 新機能・改善点
1. **Active/Inactiveノードの視覚的区別**
   - アクティブノード（画像あり）: 紫色のグラデーション背景
   - 非アクティブノード（画像なし）: グレーの背景
   - ステータスインジケーターでACTIVE/INACTIVEを表示

2. **プロンプト設定済みエッジの色分け**
   - プロンプトあり: 紫色の太い線
   - プロンプトなし: グレーの細い線
   - ラベルの色も連動して変更

3. **プロンプトの再編集機能**
   - 設定済みプロンプトをダブルクリックで再編集可能
   - 現在のプロンプトがテキストエリアに自動表示
   - 設定済みステータスをバッジで表示

4. **画像アップロードの修正**
   - 右クリックメニューから直接アップロード可能
   - FileReaderエラーハンドリングを改善
   - アップロード後の自動リドロー

5. **右クリックメニューの安定化**
   - メニューの初期化チェックを追加
   - DOM存在確認を強化
   - コンソールログでデバッグ情報を出力

## 📚 Recent Bug Fixes (2025-01-22 v1)

### 修正済みのバグ
1. **ダブルクリックによるノード作成の削除**
   - 空のキャンバスエリアをダブルクリックしてもノードが作成されなくなりました

2. **右クリックメニューのバグ修正**
   - ノードを右クリックしても移動しなくなりました
   - メニューがすぐに消える問題を解決
   - 一時的にドラッグを無効化することで安定性を向上

3. **メモリリークの防止**
   - イベントリスナーのクリーンアップを改善
   - destroy()メソッドを拡張してリソースを適切に解放
   - コンテナ要素の再作成でイベントリスナーを完全に削除

4. **エラーハンドリングの改善**
   - ファイルアップロードの非同期処理を改善
   - Promise.allSettledを使用して部分的な失敗を処理
   - ファイルサイズ制限（10MB）を追加

5. **vis.jsレンダリングエラーの修正**
   - カスタムノードレンダリングの返り値を修正
   - drawExternalLabelプロパティを削除してエラーを解消

6. **未定義オブジェクトの修正**
   - storageオブジェクトの未定義エラーを修正
   - nodeManager, edgeManager, apiServiceを実装
   - グローバル変数の参照を適切に処理

7. **パフォーマンスの最適化**
   - debouncedSave()を追加して過度なストレージ書き込みを防止
   - 非同期処理のエラー境界を追加

## 📋 プロジェクト概要

**Image Transformation Tracker**は、AI駆動の画像変換を追跡・管理するWebアプリケーションです。画像をアップロードし、LLM（IO Intelligence API）を使用してプロンプトを生成し、複数の画像変換を実行。変換の履歴とプロンプトをツリー構造で視覚化し、優れた変換結果を起点に更なる変換を深めていくことができます。

### 🎯 プロジェクトの目標
- 画像変換のプロセスを完全に追跡可能にする
- プロンプトエンジニアリングの学習と改善を支援
- 変換の系譜をビジュアル化して創造的な探求を促進
- 効果的なプロンプトを蓄積し再利用可能にする

## ✨ 現在実装済みの機能

### 1. 画像アップロード機能
- ドラッグ&ドロップまたはクリックでの画像アップロード
- 対応形式: JPG, PNG, GIF, WebP
- 最大ファイルサイズ: 20MB
- アップロード画像のプレビュー表示

### 2. AI駆動のプロンプト生成
- LLMモデル選択（GPT-4o, Gemini Flash）
- 8種類の変換スタイルプリセット
  - Artistic（アーティスティック）
  - Photorealistic（写実的）
  - Anime（アニメスタイル）
  - Cyberpunk（サイバーパンク）
  - Watercolor（水彩画）
  - Oil Painting（油絵）
  - Sketch（スケッチ）
  - 3D Render（3Dレンダリング）
- カスタムスタイル対応
- 追加指示の入力機能

### 3. 画像変換機能
- 複数の画像生成モデル対応
  - Flux Pro Ultra（高品質）
  - GPT Image（最高品質・低速）
  - Imagen 4（バランス型）
  - Recraft V3（写実的）
  - Ideogram V3（一貫性重視）
- 1回の変換で1-10枚の画像生成
- リアルタイムプログレス表示
- 変換結果のグリッド表示

### 4. 変換履歴管理
- 全変換履歴の自動保存（LocalStorage）
- 履歴の検索・フィルタリング
- 履歴からのプロンプト再利用
- 履歴の削除機能
- データのエクスポート/インポート

### 5. ツリービジュアライゼーション
- Vis.jsを使用した変換ツリーの可視化
- 親子関係の明確な表示
- ノードクリックで詳細表示
- ダブルクリックで画像を新しいソースに設定
- フルスクリーン表示対応
- ビューのリセット機能

### 6. 連鎖的な画像変換
- 変換結果を新しいソース画像として使用
- 変換の系譜を追跡
- 興味深い結果から更なる探求が可能

### 7. ユーザーインターフェース
- ダークテーマのモダンなデザイン
- グラスモーフィズムエフェクト
- レスポンシブデザイン
- キーボードショートカット
  - Ctrl/Cmd + G: プロンプト生成
  - Ctrl/Cmd + T: 画像変換
  - Ctrl/Cmd + H: 履歴表示
  - Esc: モーダルを閉じる

### 8. データ永続化
- RESTful Table APIとの連携
- transformationsテーブルスキーマ定義済み
- CRUD操作対応

## 🔄 現在の機能エントリーポイント

### メインページ
- **URL**: `/index.html`
- **機能**: 
  - 画像アップロード
  - プロンプト生成
  - 画像変換実行
  - 結果表示
  - ツリービュー

### API エンドポイント（RESTful Table API）
- `GET tables/transformations` - 変換履歴一覧取得
- `GET tables/transformations/{id}` - 特定の変換詳細取得
- `POST tables/transformations` - 新規変換保存
- `PUT tables/transformations/{id}` - 変換情報更新
- `DELETE tables/transformations/{id}` - 変換削除

## 🚀 今後実装予定の機能

### 優先度: 高
1. **実際のAPI連携**
   - IO Intelligence APIとの実連携
   - 画像生成APIとの実連携
   - エラーハンドリングの強化

2. **プロンプト最適化**
   - プロンプトテンプレートライブラリ
   - プロンプトの自動最適化
   - 成功パターンの学習

### 優先度: 中
3. **高度な変換機能**
   - バッチ変換（複数プロンプト同時実行）
   - スタイル転送機能
   - 画像アップスケーリング
   - 背景除去機能

4. **分析機能**
   - 変換統計ダッシュボード
   - プロンプト効果分析
   - モデル性能比較

### 優先度: 低
5. **コラボレーション機能**
   - 変換結果の共有
   - プロンプトテンプレート共有
   - コミュニティギャラリー

6. **拡張機能**
   - プラグインシステム
   - カスタムモデル追加
   - ワークフロー自動化

## 💻 技術スタック

### フロントエンド
- HTML5
- Tailwind CSS（CDN）
- Vanilla JavaScript (ES6+)
- Vis.js（ネットワークビジュアライゼーション）
- Font Awesome（アイコン）

### データ管理
- LocalStorage（クライアント側）
- RESTful Table API（サーバー側）

### 外部API（予定）
- IO Intelligence API（LLM）
- 画像生成API
- 画像解析API

## 🔧 セットアップ方法

1. プロジェクトをデプロイ
2. 設定画面からIO Intelligence API キーを入力
3. 画像をアップロードして変換開始

## 📊 データモデル

### transformationsテーブル
```javascript
{
  id: string,                    // 一意の変換ID
  session_id: string,             // セッション識別子
  parent_id: string,              // 親変換ID（ツリー構造）
  source_image: string,           // ソース画像URL
  prompt: string,                 // 生成されたプロンプト
  llm_model: string,              // 使用したLLMモデル
  image_model: string,            // 使用した画像生成モデル
  transform_style: string,        // 変換スタイル
  additional_instructions: string,// 追加指示
  result_images: array,           // 生成画像の配列
  metadata: object,               // その他のメタデータ
  timestamp: datetime             // 変換実行日時
}
```

## 🎯 推奨される次のステップ

1. **API連携の実装**
   - IO Intelligence APIの実装
   - 画像生成APIの実装
   - 認証機能の追加

2. **パフォーマンス最適化**
   - 画像の遅延読み込み
   - キャッシュ戦略の実装
   - 大規模データ対応

3. **ユーザビリティ向上**
   - オンボーディングツアー
   - ツールチップの追加
   - ヘルプドキュメント

4. **品質向上**
   - ユニットテストの追加
   - E2Eテストの実装
   - アクセシビリティ改善

## 📝 使用方法

1. **画像のアップロード**
   - ドロップゾーンに画像をドラッグ&ドロップ
   - またはクリックしてファイル選択

2. **プロンプト生成**
   - 変換スタイルを選択
   - 必要に応じて追加指示を入力
   - 「プロンプトを生成」ボタンをクリック

3. **画像変換**
   - 生成枚数を設定（1-10枚）
   - 「画像を変換」ボタンをクリック
   - 変換完了を待つ

4. **結果の活用**
   - 気に入った結果をクリックして選択
   - 「この画像から変換を続ける」で連鎖変換
   - または画像をダウンロード

5. **履歴の確認**
   - ヘッダーの「履歴」ボタンをクリック
   - 過去の変換を確認・再利用

## 🌐 公開URL

- **開発環境**: ローカルで`index.html`を開く
- **本番環境**: Publishタブから公開（予定）

## 📄 ライセンス

MIT License

## 👥 コントリビューター

- 久米慧嗣 (Satoshi Kume) - プロジェクトオーナー

## 🔗 関連リンク

- [IO Intelligence API Documentation](https://io.google/intelligence)
- [Vis.js Documentation](https://visjs.org/)
- [Tailwind CSS](https://tailwindcss.com/)

---

**Last Updated**: 2025-01-20
**Version**: 1.0.0