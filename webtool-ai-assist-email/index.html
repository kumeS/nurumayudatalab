<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI-powered Web Editor (AWE) - シンプルなWebベースのAIエディターでメール作成を効率化">
    <meta name="keywords" content="AI, editor, email, productivity, web app, artificial intelligence">
    <meta name="author" content="AIeditor Team">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="AI-powered Web Editor (AWE)">
    <meta property="og:description" content="AIが文脈を理解してメール作成を支援する革新的なWebエディター">
    <meta property="og:type" content="website">
    
    <meta name="theme-color" content="#FF9966">
    
    <title>AI-powered Web Editor (AWE)</title>
    
    <style>
/* ===== CSS RESET ===== */
*,
*::before,
*::after {
    box-sizing: border-box;
}

* {
    margin: 0;
    padding: 0;
}

/* ===== CSS CUSTOM PROPERTIES ===== */
:root {
    /* Colors - Light Mode - ぬるま湯データラボ風（オレンジ系） */
    --primary-color: #FF9966;
    --primary-dark: #FF7F50;
    --primary-light: #FFB347;
    --secondary-color: #FFA500;
    --accent-color: #FFAA66;
    
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --text-muted: #718096;
    --text-inverse: #ffffff;
    
    --background-primary: #ffffff;
    --background-secondary: #f7fafc;
    --background-tertiary: #edf2f7;
    
    --border-color: #e2e8f0;
    --border-focus: #FF9966;
    
    --success-color: #38a169;
    --warning-color: #d69e2e;
    --error-color: #e53e3e;
    
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
    
    /* Typography */
    --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --font-family-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    
    --font-size-xs: 0.75rem;   /* 12px */
    --font-size-sm: 0.875rem;  /* 14px */
    --font-size-base: 1rem;    /* 16px */
    --font-size-lg: 1.125rem;  /* 18px */
    --font-size-xl: 1.25rem;   /* 20px */
    --font-size-2xl: 1.5rem;   /* 24px */
    --font-size-3xl: 1.875rem; /* 30px */
    
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;
    
    --line-height-tight: 1.25;
    --line-height-normal: 1.5;
    --line-height-relaxed: 1.625;
    
    /* Spacing */
    --space-1: 0.25rem;  /* 4px */
    --space-2: 0.5rem;   /* 8px */
    --space-3: 0.75rem;  /* 12px */
    --space-4: 1rem;     /* 16px */
    --space-5: 1.25rem;  /* 20px */
    --space-6: 1.5rem;   /* 24px */
    --space-8: 2rem;     /* 32px */
    --space-10: 2.5rem;  /* 40px */
    --space-12: 3rem;    /* 48px */
    --space-16: 4rem;    /* 64px */
    
    /* Borders & Radius */
    --border-width: 1px;
    --border-radius-sm: 0.25rem;
    --border-radius: 0.375rem;
    --border-radius-md: 0.5rem;
    --border-radius-lg: 0.75rem;
    
    /* Animations */
    --transition-fast: 0.15s ease-out;
    --transition-base: 0.2s ease-out;
    --transition-slow: 0.3s ease-out;
    
    /* Layout */
    --header-height: 60px;
    --toolbar-height: 48px;
    --ai-panel-width: 320px;
    --prompt-section-height: 80px;
    --content-max-width: 1200px;
    --content-padding-x: clamp(1rem, 4vw, 2.5rem);
    
    /* Z-index scale */
    --z-dropdown: 1000;
    --z-sticky: 1020;
    --z-fixed: 1030;
    --z-modal-backdrop: 1040;
    --z-modal: 1050;
    --z-popover: 1060;
    --z-tooltip: 1070;
}

/* Dark mode colors */
[data-theme="dark"] {
    /* Colors - Dark Mode - ぬるま湯データラボ風（オレンジ系） */
    --primary-color: #FFB088;
    --primary-dark: #FF9966;
    --primary-light: #FFC299;
    --secondary-color: #FFB84D;
    --accent-color: #FFBB77;
    
    --text-primary: #e2e8f0;
    --text-secondary: #cbd5e0;
    --text-muted: #a0aec0;
    --text-inverse: #1a202c;
    
    --background-primary: #1a202c;
    --background-secondary: #2d3748;
    --background-tertiary: #4a5568;
    
    --border-color: #4a5568;
    --border-focus: #FFB088;
    
    --success-color: #48bb78;
    --warning-color: #ed8936;
    --error-color: #f56565;
    
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.3);
}

/* Theme transition */
* {
    transition: background-color var(--transition-base), 
                border-color var(--transition-base), 
                color var(--transition-base);
}

/* ===== BASE STYLES ===== */
html {
    scroll-behavior: smooth;
    font-size: 16px;
}

body {
    font-family: var(--font-family-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-normal);
    line-height: var(--line-height-normal);
    color: var(--text-primary);
    background-color: var(--background-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
}

/* Skip Link for Accessibility */
.skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: var(--primary-color);
    color: var(--text-inverse);
    padding: var(--space-2) var(--space-4);
    text-decoration: none;
    border-radius: var(--border-radius);
    z-index: var(--z-tooltip);
    transition: top var(--transition-fast);
}

.skip-link:focus {
    top: 6px;
}

/* ===== HEADER ===== */
.app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--background-primary);
    border-bottom: var(--border-width) solid var(--border-color);
    z-index: var(--z-fixed);
}

.header-content {
    height: 100%;
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding-x);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: var(--space-6);
}

.logo {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.logo-icon {
    flex-shrink: 0;
}

.logo-text {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-color);
}

.save-status {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.save-indicator {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--border-radius-sm);
    background: var(--background-secondary);
}

.save-indicator.saving {
    color: var(--warning-color);
    background: #fef5e7;
}

.save-indicator.saved {
    color: var(--success-color);
    background: #f0fff4;
}

.save-indicator.error {
    color: var(--error-color);
    background: #fed7d7;
}

.header-nav {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.nav-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.nav-button:hover {
    background: var(--background-secondary);
    color: var(--text-primary);
}

.nav-button:focus {
    outline: 2px solid var(--border-focus);
    outline-offset: 2px;
}

/* ===== MAIN LAYOUT ===== */
.app-main {
    margin-top: var(--header-height);
    min-height: calc(100vh - var(--header-height));
    display: flex;
    flex-direction: column;
}

/* ===== TOOLBAR ===== */
.toolbar {
    height: var(--toolbar-height);
    background: var(--background-secondary);
    border-bottom: var(--border-width) solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 0 var(--content-padding-x);
    gap: var(--space-3);
    overflow-x: auto;
    box-sizing: border-box;
    box-shadow: var(--shadow-sm);
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

.toolbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    min-height: 32px;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid transparent;
    background: var(--background-primary);
    color: var(--text-primary);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.toolbar-btn:hover {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.toolbar-btn:focus {
    outline: 2px solid var(--border-focus);
    outline-offset: 2px;
}

.toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.toolbar-btn:disabled:hover {
    background: var(--background-primary);
    color: var(--text-primary);
}

.toolbar-btn.active {
    background: var(--primary-color);
    color: var(--text-inverse);
}

.toolbar-divider {
    width: var(--border-width);
    height: 20px;
    background: var(--border-color);
    margin: 0 var(--space-2);
}

.ai-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--text-inverse);
}

.ai-btn:hover {
    background: linear-gradient(135deg, var(--primary-dark), var(--secondary-color));
}

/* ===== EDITOR LAYOUT ===== */
/* ===== CONTENT WRAPPER (Vertical Layout) ===== */
.content-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    width: min(var(--content-max-width), 100%);
    box-sizing: border-box;
    padding: var(--space-6) var(--content-padding-x);
    gap: var(--space-6);
    margin: 0 auto;
    overflow-y: visible;
}

/* Legacy .editor-layout (now unused) */
.editor-layout {
    display: flex;
    flex-direction: column;
    flex: 1;
}

/* ===== EDITOR SECTION (Bottom) ===== */
.editor-section {
    position: relative;
    display: flex;
    flex-direction: column;
    background: var(--background-primary);
    flex: 1;
    min-height: 500px;
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

/* ===== EMAIL HEADER ===== */
.email-header {
    background: var(--background-secondary);
    border-bottom: var(--border-width) solid var(--border-color);
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.email-field {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.email-field label {
    min-width: 60px;
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.email-input {
    flex: 1;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-primary);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    transition: all var(--transition-fast);
}

.email-input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.email-input::placeholder {
    color: var(--text-muted);
}

/* ===== MAIN EDITOR ===== */
.editor-textarea {
    flex: 1;
    padding: var(--space-6);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    border: none;
    outline: none;
    resize: none;
    background: transparent;
    color: var(--text-primary);
    min-height: 400px;
    overflow-y: auto;
}

.editor-textarea:empty::before {
    content: attr(data-placeholder);
    color: var(--text-muted);
    pointer-events: none;
    font-style: italic;
}

.editor-textarea:focus:empty::before {
    opacity: 0.5;
}

.editor-textarea:focus {
    background: var(--background-secondary);
}

/* Rich Text Formatting */
.editor-textarea strong,
.editor-textarea b {
    font-weight: var(--font-weight-bold);
}

.editor-textarea em,
.editor-textarea i {
    font-style: italic;
}

.editor-textarea u {
    text-decoration: underline;
}

.editor-textarea ul,
.editor-textarea ol {
    padding-left: var(--space-6);
    margin: var(--space-2) 0;
}

.editor-textarea li {
    margin: var(--space-1) 0;
}

/* Grammar Check Indicators */
.grammar-indicators {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1;
}

.grammar-error {
    border-bottom: 2px wavy var(--error-color);
    cursor: pointer;
    pointer-events: auto;
}

.grammar-suggestion {
    border-bottom: 2px wavy var(--warning-color);
    cursor: pointer;
    pointer-events: auto;
}

/* ===== AI CHAT (in AI Panel) ===== */
.ai-chat-container {
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--space-3);
}

.ai-chat-messages {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: var(--space-3);
    padding: var(--space-2);
    background: var(--background-secondary);
    border-radius: var(--border-radius);
}

.chat-message {
    margin-bottom: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-normal);
    animation: fadeIn 0.3s ease-in-out;
}

.chat-message.user-message {
    background: var(--primary-light);
    color: var(--text-primary);
    margin-left: var(--space-4);
}

.chat-message.ai-message {
    background: var(--background-tertiary);
    color: var(--text-primary);
    margin-right: var(--space-4);
}

.chat-message.error-message {
    background: var(--error-color);
    color: white;
}

.chat-message.ai .chat-message-content {
    background: var(--background-tertiary);
    color: var(--text-primary);
    margin-right: var(--space-8);
    border-radius: var(--border-radius) var(--border-radius) var(--border-radius) var(--border-radius-sm);
}

.chat-message.error .chat-message-content {
    background: var(--error-color);
    color: var(--text-inverse);
}

.chat-message.temporary .chat-message-content {
    opacity: 0.7;
    animation: pulse 1.5s infinite;
}

.chat-message-content {
    padding: var(--space-3);
    border-radius: var(--border-radius);
    word-wrap: break-word;
    line-height: 1.5;
}

.chat-message-time {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    margin-top: var(--space-1);
    text-align: right;
}

.chat-message.user .chat-message-time {
    text-align: right;
}

.chat-message.ai .chat-message-time {
    text-align: left;
}

.ai-chat-input-container {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.ai-chat-input {
    flex: 1;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-secondary);
    font-family: var(--font-family-base);
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    transition: all var(--transition-fast);
}

.ai-chat-input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.ai-chat-send-btn {
    padding: var(--space-2);
    background: var(--primary-color);
    color: var(--text-inverse);
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-chat-send-btn:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.ai-chat-send-btn:active {
    transform: translateY(0);
}

/* ===== CONTACT FORM ===== */
.contact-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.form-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.form-field label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
}

.form-input {
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-primary);
    font-family: var(--font-family-base);
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    transition: all var(--transition-fast);
}

.form-input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.form-textarea {
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-primary);
    font-family: var(--font-family-base);
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    transition: all var(--transition-fast);
    resize: vertical;
    line-height: 1.5;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.form-textarea::placeholder {
    color: var(--text-muted);
    font-style: italic;
}

/* Apply Contact Button */
.apply-contact-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border: none;
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    width: 100%;
    background: var(--primary-color);
    color: var(--text-inverse);
}

.apply-contact-btn:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.apply-contact-btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

/* Saved Contacts */
.saved-contacts {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: var(--border-width) solid var(--border-color);
}

.saved-contacts-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    margin-bottom: var(--space-3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.contacts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    max-height: 300px;
    overflow-y: auto;
}

.no-contacts {
    padding: var(--space-4);
    text-align: center;
    color: var(--text-muted);
    font-size: var(--font-size-sm);
    font-style: italic;
}

.contact-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--background-secondary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    transition: all var(--transition-fast);
}

.contact-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.contact-item.active {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-md);
    background: linear-gradient(135deg, rgba(255, 153, 102, 0.08), rgba(255, 186, 102, 0.12));
}

.contact-info {
    flex: 1;
}

.contact-name {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
}

.contact-company {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-1);
}

.contact-relation {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    background: var(--background-tertiary);
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
}

.contact-updated {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    margin-top: var(--space-1);
}

.contact-actions {
    display: flex;
    gap: var(--space-1);
}

.contact-load-btn,
.contact-delete-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    background: var(--background-tertiary);
    color: var(--text-secondary);
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.contact-load-btn:hover {
    background: var(--primary-light);
    color: var(--primary-color);
}

.contact-delete-btn:hover {
    background: var(--error-color);
    color: white;
}

/* Email History */
.email-history {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: var(--border-width) solid var(--border-color);
}

.email-history-title {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--text-secondary);
    margin-bottom: var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.email-history-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    max-height: 400px;
    overflow-y: auto;
}

.no-history {
    padding: var(--space-4);
    text-align: center;
    color: var(--text-muted);
    font-size: var(--font-size-sm);
    font-style: italic;
}

.history-item {
    padding: var(--space-3);
    background: var(--background-secondary);
    border: var(--border-width) solid var(--border-color);
    border-left: 3px solid var(--primary-color);
    border-radius: var(--border-radius);
}

.history-date {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.history-subject {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
}

.history-preview {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

.history-actions {
    margin-top: var(--space-2);
    display: flex;
    gap: var(--space-2);
}

.history-view-btn,
.history-delete-btn {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.history-view-btn {
    background: var(--background-tertiary);
    color: var(--text-secondary);
}

.history-view-btn:hover {
    background: var(--primary-light);
    color: var(--primary-color);
}

.history-delete-btn {
    background: transparent;
    color: var(--text-muted);
}

.history-delete-btn:hover {
    color: var(--error-color);
}

/* ===== SECTION HEADERS (共通スタイル) ===== */
.section-header {
    background: var(--background-secondary);
    border-bottom: var(--border-width) solid var(--border-color);
    padding: var(--space-4);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
}

/* ===== AI PANEL (Top Section) ===== */
.ai-panel {
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

/* Legacy classes (keep for compatibility) */
.ai-panel-header {
    display: none;
}

.ai-panel-title {
    display: none;
}

.close-panel-btn {
    display: none;
}

.ai-panel-header:hover {
    background: var(--background-secondary);
    color: var(--text-primary);
}

.ai-panel-content {
    padding: var(--space-4);
    max-height: none;
    overflow-y: visible;
}

.ai-section {
    margin-bottom: var(--space-6);
}

.ai-section-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-3);
}

/* AI Suggestions */
.suggestions-list,
.grammar-results {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.suggestion-item,
.grammar-item {
    padding: var(--space-3);
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.suggestion-item:hover,
.grammar-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.suggestion-text {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    margin-bottom: var(--space-1);
}

.suggestion-confidence {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
}

.no-suggestions,
.no-issues {
    padding: var(--space-4);
    text-align: center;
    color: var(--text-muted);
    font-size: var(--font-size-sm);
}

/* Tone Options */
.tone-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.tone-option {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

.tone-option:hover {
    background: var(--background-primary);
}

.tone-option input[type="radio"] {
    accent-color: var(--primary-color);
}

/* Templates */
.templates-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.template-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-1);
    padding: var(--space-3);
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    text-align: left;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.template-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
}

.template-name {
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
}

.template-desc {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

/* ===== AI PROMPT SECTION ===== */
.ai-prompt-section {
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: var(--space-4) var(--content-padding-x);
    width: min(var(--content-max-width), 100%);
    margin: var(--space-6) auto var(--space-8);
    box-shadow: var(--shadow-lg);
    box-sizing: border-box;
}

.prompt-input-container {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.prompt-input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-base);
    line-height: var(--line-height-normal);
    background: var(--background-secondary);
    color: var(--text-primary);
    transition: all var(--transition-fast);
}

.prompt-input:focus {
    outline: none;
    border-color: var(--border-focus);
    background: var(--background-primary);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.prompt-submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border: none;
    background: var(--primary-color);
    color: var(--text-inverse);
    border-radius: var(--border-radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.prompt-submit-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.prompt-submit-btn:focus {
    outline: 2px solid var(--border-focus);
    outline-offset: 2px;
}

.prompt-suggestions {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.prompt-suggestion {
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    background: var(--background-secondary);
    color: var(--text-secondary);
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.prompt-suggestion:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-modal);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--background-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform var(--transition-base);
}

.modal-overlay.show .modal-content {
    transform: scale(1);
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-6);
    border-bottom: var(--border-width) solid var(--border-color);
}

.modal-header h2 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
}

.close-modal-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.close-modal-btn:hover {
    background: var(--background-secondary);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--space-6);
}

.setting-group {
    margin-bottom: var(--space-4);
}

.setting-group label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: var(--font-weight-medium);
    color: var(--text-primary);
}

.setting-group input[type="range"] {
    width: 100%;
    margin: var(--space-2) 0;
}

.setting-group input[type="checkbox"] {
    margin-right: var(--space-2);
    accent-color: var(--primary-color);
}

.setting-input {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--background-primary);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-2);
    transition: all var(--transition-fast);
}

.setting-input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.1);
}

.setting-description {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    line-height: 1.4;
}

.setting-description.danger {
    color: var(--error-color);
    font-weight: var(--font-weight-medium);
}

.setting-btn {
    padding: var(--space-2) var(--space-4);
    background: var(--primary-color);
    color: var(--text-inverse);
    border: none;
    border-radius: var(--border-radius);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.setting-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.setting-btn.danger {
    background: var(--error-color);
    color: var(--text-inverse);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    justify-content: center;
}

.setting-btn.danger:hover:not(:disabled) {
    background: #c53030;
    box-shadow: var(--shadow-md);
}

.setting-btn.danger:active {
    background: #9c2626;
    transform: translateY(0);
}

/* Shortcuts Help */
.shortcuts-help {
    position: fixed;
    bottom: var(--space-4);
    left: var(--space-4);
    background: var(--background-primary);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius-lg);
    padding: var(--space-4);
    box-shadow: var(--shadow-lg);
    max-width: 300px;
    z-index: var(--z-popover);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all var(--transition-base);
}

.shortcuts-help.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.shortcuts-list {
    margin-top: var(--space-3);
}

.shortcuts-list dt {
    font-family: var(--font-family-mono);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--primary-color);
    margin-bottom: var(--space-1);
}

.shortcuts-list dd {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
    margin-left: 0;
}

/* ===== RESPONSIVE DESIGN ===== */

/* Tablet (768px - 1023px) */
@media (max-width: 1023px) {
    .content-wrapper {
        /* Maintain vertical layout */
    }
    
    .ai-panel {
        /* Full width on tablets */
        width: 100%;
    }
    
    .editor-section {
        min-height: 400px;
    }
    
    .toolbar {
        flex-wrap: wrap;
        height: auto;
        min-height: var(--toolbar-height);
        padding: var(--space-2) var(--space-4);
    }
    
    .header-content {
        padding: 0 var(--space-3);
    }
    
    .logo-text {
        font-size: var(--font-size-lg);
    }
}

/* Mobile (767px and below) */
@media (max-width: 767px) {
    :root {
        --header-height: 50px;
        --toolbar-height: auto;
        --ai-panel-width: 100%;
        --prompt-section-height: 120px;
    }
    
    .content-wrapper {
        padding: var(--space-4) var(--space-3);
        gap: var(--space-4);
    }
    
    .ai-prompt-section {
        padding: var(--space-4) var(--space-3);
        margin: var(--space-4) auto var(--space-6);
    }
    
    .header-content {
        padding: 0 var(--space-2);
    }
    
    .logo-section {
        gap: var(--space-3);
    }
    
    .logo-text {
        display: none;
    }
    
    .save-indicator {
        font-size: var(--font-size-xs);
        padding: var(--space-1);
    }
    
    .toolbar {
        padding: var(--space-2);
        gap: var(--space-2);
    }
    
    .toolbar-btn {
        min-height: 36px;
        padding: var(--space-2);
        font-size: var(--font-size-xs);
    }
    
    .toolbar-btn span {
        display: none;
    }
    
    .ai-panel {
        top: calc(var(--header-height) + var(--toolbar-height));
        bottom: var(--prompt-section-height);
        width: 100%;
        transform: translateY(100%);
    }
    
    .ai-panel.show {
        transform: translateY(0);
    }
    
    .editor-textarea {
        padding: var(--space-4);
        font-size: var(--font-size-base);
    }
    
    .ai-prompt-section {
        padding: var(--space-3);
    }
    
    .prompt-input-container {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .prompt-input {
        padding: var(--space-3);
    }
    
    .prompt-submit-btn {
        width: 100%;
        height: 40px;
    }
    
    .prompt-suggestions {
        justify-content: center;
    }
    
    .modal-content {
        width: 95%;
        margin: var(--space-4);
    }
    
    .toast-container {
        top: calc(var(--header-height) + var(--space-2));
        right: var(--space-2);
        left: var(--space-2);
        max-width: none;
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    :root {
        --border-color: #000000;
        --text-secondary: #000000;
        --background-secondary: #ffffff;
    }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .skip-link:focus {
        transition: none;
    }
}

/* Print styles */
@media print {
    .app-header,
    .toolbar,
    .ai-panel,
    .ai-prompt-section,
    .loading-overlay,
    .toast-container,
    .modal-overlay,
    .shortcuts-help {
        display: none !important;
    }
    
    .app-main {
        margin-top: 0;
    }
    
    .editor-layout {
        grid-template-columns: 1fr;
    }
    
    .editor-textarea {
        padding: 0;
        background: transparent;
        color: #000000;
    }
}

/* Focus visible polyfill support */
.js-focus-visible :focus:not(.focus-visible) {
    outline: none;
}

/* Utility classes */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.hidden {
    display: none !important;
}

.invisible {
    visibility: hidden !important;
}

/* Theme Toggle Button */
.theme-toggle {
    position: relative;
    width: 40px;
    height: 40px;
    border: none;
    background: transparent;
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.theme-toggle:hover {
    background: var(--background-secondary);
}

.theme-toggle:focus {
    outline: 2px solid var(--border-focus);
    outline-offset: 2px;
}

.theme-toggle svg {
    width: 20px;
    height: 20px;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
}

.theme-toggle:hover svg {
    color: var(--text-primary);
}

/* Sun and Moon icon animations */
.theme-icon {
    position: absolute;
    transition: all var(--transition-base);
}

.theme-icon.sun {
    opacity: 1;
    transform: rotate(0deg) scale(1);
}

.theme-icon.moon {
    opacity: 0;
    transform: rotate(180deg) scale(0.5);
}

[data-theme="dark"] .theme-icon.sun {
    opacity: 0;
    transform: rotate(180deg) scale(0.5);
}

[data-theme="dark"] .theme-icon.moon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
}

/* Email Actions */
.email-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: var(--border-width) solid var(--border-color);
}

.email-action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    border: var(--border-width) solid var(--border-color);
    background: var(--background-primary);
    color: var(--text-primary);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.email-action-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-1px);
}

.email-action-btn.send-btn {
    background: var(--primary-color);
    color: var(--text-inverse);
    border-color: var(--primary-color);
}

.email-action-btn.send-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* Email Preview Modal */
.email-preview-modal .modal-content {
    max-width: 700px;
}

.email-preview-body {
    padding: var(--space-6);
}

.email-preview-field {
    margin-bottom: var(--space-3);
    padding: var(--space-2) 0;
    font-size: var(--font-size-sm);
}

.email-preview-field strong {
    color: var(--text-secondary);
    margin-right: var(--space-2);
    min-width: 80px;
    display: inline-block;
}

.email-preview-separator {
    height: var(--border-width);
    background: var(--border-color);
    margin: var(--space-4) 0;
}

.email-preview-body-content {
    background: var(--background-secondary);
    border-radius: var(--border-radius);
    padding: var(--space-4);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--text-primary);
    white-space: pre-wrap;
}

/* ===== レスポンシブデザイン ===== */
@media (max-width: 1024px) {
    .content-wrapper {
        /* Already vertical layout */
    }
    
    .ai-panel {
        width: 100%;
        border-bottom: 2px solid var(--border-color);
    }
    
    .editor-section {
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    :root {
        --header-height: 56px;
        --toolbar-height: auto;
        --space-4: 0.875rem;
    }
    
    /* ヘッダー */
    .header-content {
        padding: 0 var(--space-3);
    }
    
    .logo-text {
        font-size: var(--font-size-lg);
    }
    
    .save-indicator {
        font-size: var(--font-size-xs);
        padding: var(--space-1) var(--space-2);
    }
    
    /* ツールバー */
    .toolbar {
        flex-wrap: wrap;
        height: auto;
        min-height: var(--toolbar-height);
        padding: var(--space-2) var(--space-3);
        gap: var(--space-2);
    }
    
    .toolbar-group {
        gap: var(--space-1);
    }
    
    .toolbar-btn {
        min-height: 36px;
        padding: var(--space-1) var(--space-2);
        font-size: var(--font-size-xs);
    }
    
    .toolbar-btn span {
        display: none;
    }
    
    .toolbar-divider {
        height: 24px;
    }
    
    /* エディタ */
    .editor-textarea {
        padding: var(--space-4);
        min-height: 300px;
        font-size: var(--font-size-sm);
    }
    
    .email-header {
        padding: var(--space-3);
        gap: var(--space-2);
    }
    
    .email-field {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-1);
    }
    
    .email-field label {
        min-width: auto;
    }
    
    .email-input {
        width: 100%;
    }
    
    /* AIパネル */
    .ai-panel {
        padding: var(--space-3);
    }
    
    .ai-section {
        margin-bottom: var(--space-3);
    }
    
    .ai-section-title {
        font-size: var(--font-size-base);
    }
    
    /* プロンプトセクション */
    .ai-prompt-section {
        padding: var(--space-3);
    }
    
    .prompt-input {
        font-size: var(--font-size-sm);
        padding: var(--space-2) var(--space-3);
    }
    
    .prompt-suggestions {
        gap: var(--space-1);
    }
    
    .prompt-suggestion {
        font-size: var(--font-size-xs);
        padding: var(--space-1) var(--space-2);
    }
    
    /* モーダル */
    .modal-content {
        width: 95%;
        max-width: 95%;
        margin: var(--space-4);
        max-height: calc(100vh - var(--space-8));
    }
    
    .modal-body {
        padding: var(--space-4);
    }
}

@media (max-width: 480px) {
    .logo-icon {
        width: 28px;
        height: 28px;
    }
    
    .logo-text {
        font-size: var(--font-size-base);
    }
    
    .nav-button {
        width: 36px;
        height: 36px;
    }
    
    .toolbar-btn {
        min-width: 36px;
        padding: var(--space-1);
    }
    
    .email-field {
        gap: var(--space-1);
    }
    
    .chat-message {
        margin-left: var(--space-2);
        margin-right: var(--space-2);
    }
    
    .user-message {
        margin-left: var(--space-4);
    }
    
    .ai-message {
        margin-right: var(--space-4);
    }
}

/* スクロールバーのスタイリング */
.toolbar::-webkit-scrollbar,
.ai-chat-messages::-webkit-scrollbar,
.editor-textarea::-webkit-scrollbar {
    height: 6px;
    width: 6px;
}

.toolbar::-webkit-scrollbar-track,
.ai-chat-messages::-webkit-scrollbar-track,
.editor-textarea::-webkit-scrollbar-track {
    background: var(--background-secondary);
}

.toolbar::-webkit-scrollbar-thumb,
.ai-chat-messages::-webkit-scrollbar-thumb,
.editor-textarea::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.toolbar::-webkit-scrollbar-thumb:hover,
.ai-chat-messages::-webkit-scrollbar-thumb:hover,
.editor-textarea::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
}

/* フォーカス可視性の向上 */
*:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* ===== Toast Notifications ===== */
.toast-container {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    z-index: var(--z-tooltip);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    pointer-events: none;
}

.toast {
    min-width: 250px;
    max-width: 400px;
    padding: var(--space-3) var(--space-4);
    background: var(--background-primary);
    color: var(--text-primary);
    border-left: 4px solid var(--primary-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-normal);
    opacity: 0;
    transform: translateX(100%);
    transition: all var(--transition-base);
    pointer-events: auto;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast.success {
    border-left-color: var(--success-color);
    background: #f0fff4;
    color: #22543d;
}

[data-theme="dark"] .toast.success {
    background: #22543d;
    color: #c6f6d5;
}

.toast.error {
    border-left-color: var(--error-color);
    background: #fff5f5;
    color: #742a2a;
}

[data-theme="dark"] .toast.error {
    background: #742a2a;
    color: #fed7d7;
}

.toast.warning {
    border-left-color: var(--warning-color);
    background: #fffaf0;
    color: #744210;
}

[data-theme="dark"] .toast.warning {
    background: #744210;
    color: #feebc8;
}

.toast.info {
    border-left-color: var(--primary-color);
}

@media (max-width: 768px) {
    .toast-container {
        bottom: var(--space-2);
        right: var(--space-2);
        left: var(--space-2);
    }
    
    .toast {
        min-width: auto;
        max-width: none;
    }
}

/* ===== Loading Overlay ===== */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: var(--z-modal-backdrop);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
}

.loading-overlay.show {
    opacity: 1;
    visibility: visible;
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-4);
}

.spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.loading-text {
    color: white;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
}
    </style>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-editor" class="skip-link">メインエディターにスキップ</a>
    
    <!-- Header -->
    <header class="app-header" role="banner">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <svg class="logo-icon" width="32" height="32" viewBox="0 0 32 32" aria-hidden="true">
                        <circle cx="16" cy="16" r="14" fill="#FF9966"/>
                        <text x="16" y="20" font-family="Arial" font-size="12" fill="white" text-anchor="middle">AI</text>
                    </svg>
                    <h1 class="logo-text">AWE</h1>
                </div>
                <div class="save-status" id="save-status" role="status" aria-live="polite">
                    <span class="save-indicator" id="save-indicator">保存済み</span>
                </div>
            </div>
            
            <nav class="header-nav" role="navigation">
                <button class="theme-toggle" id="theme-toggle" type="button" aria-label="テーマを切り替え">
                    <svg class="theme-icon sun" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z" fill="currentColor"/>
                    </svg>
                    <svg class="theme-icon moon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.4 6.35,17.41C9.37,20.43 14,20.54 17.33,17.97Z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="nav-button" id="settings-btn" type="button" aria-label="設定を開く">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" fill="currentColor"/>
                    </svg>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Application -->
    <main class="app-main" role="main">
        <!-- Toolbar -->
        <div class="toolbar" role="toolbar" aria-label="編集ツールバー">
            <!-- Format Buttons -->
            <div class="toolbar-group format-group">
                <button class="toolbar-btn" id="bold-btn" type="button" aria-label="太字" data-format="bold">
                    <strong>B</strong>
                </button>
                <button class="toolbar-btn" id="italic-btn" type="button" aria-label="斜体" data-format="italic">
                    <em>I</em>
                </button>
                <button class="toolbar-btn" id="underline-btn" type="button" aria-label="下線" data-format="underline">
                    <u>U</u>
                </button>
                <div class="toolbar-divider" aria-hidden="true"></div>
                <button class="toolbar-btn" id="list-btn" type="button" aria-label="リスト" data-format="list">
                    <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M7,5H21V7H7V5M7,13V11H21V13H7M4,4.5A1.5,1.5 0 0,1 5.5,6A1.5,1.5 0 0,1 4,7.5A1.5,1.5 0 0,1 2.5,6A1.5,1.5 0 0,1 4,4.5M4,10.5A1.5,1.5 0 0,1 5.5,12A1.5,1.5 0 0,1 4,13.5A1.5,1.5 0 0,1 2.5,12A1.5,1.5 0 0,1 4,10.5M7,19V17H21V19H7M4,16.5A1.5,1.5 0 0,1 5.5,18A1.5,1.5 0 0,1 4,19.5A1.5,1.5 0 0,1 2.5,18A1.5,1.5 0 0,1 4,16.5Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>

            <!-- AI Tools -->
            <div class="toolbar-group ai-group">
                <div class="toolbar-divider" aria-hidden="true"></div>
                <button class="toolbar-btn ai-btn" id="ai-suggest-btn" type="button" aria-label="AI提案">
                    <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z" fill="currentColor"/>
                    </svg>
                    AI提案
                </button>
                <button class="toolbar-btn tone-btn" id="tone-btn" type="button" aria-label="トーン切替">
                    <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V21A2,2 0 0,0 5,23H19A2,2 0 0,0 21,21V9M19,9H14V4H19V9Z" fill="currentColor"/>
                    </svg>
                    トーン
                </button>
            </div>

            <!-- Undo/Redo -->
            <div class="toolbar-group history-group">
                <div class="toolbar-divider" aria-hidden="true"></div>
                <button class="toolbar-btn" id="undo-btn" type="button" aria-label="元に戻す" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12.5,8C9.85,8 7.45,9 5.6,10.6L2,7V16H11L7.38,12.38C8.77,11.22 10.54,10.5 12.5,10.5C16.04,10.5 19.05,12.81 20.1,16L22.47,15.22C21.08,11.03 17.15,8 12.5,8Z" fill="currentColor"/>
                    </svg>
                </button>
                <button class="toolbar-btn" id="redo-btn" type="button" aria-label="やり直し" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M18.4,10.6C16.55,9 14.15,8 11.5,8C6.85,8 2.92,11.03 1.53,15.22L3.9,16C4.95,12.81 7.96,10.5 11.5,10.5C13.46,10.5 15.23,11.22 16.62,12.38L13,16H22V7L18.4,10.6Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- New Vertical Layout -->
        <div class="content-wrapper">
            <!-- AI Panel (Top Section) -->
            <section class="ai-panel" id="ai-panel" role="region" aria-label="AI支援パネル">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                        </svg>
                        AI 支援機能
                    </h2>
                </div>

                <div class="ai-panel-content">
                    <!-- Contact Information (Step 1: Who to send to) -->
                    <div class="ai-section" id="contact-section">
                        <h3 class="ai-section-title">相手先情報</h3>
                        <div class="contact-form">
                            <div class="form-field">
                                <label for="contact-name">氏名</label>
                                <input type="text" id="contact-name" class="form-input" placeholder="田中太郎">
                            </div>
                            <div class="form-field">
                                <label for="contact-company">所属</label>
                                <input type="text" id="contact-company" class="form-input" placeholder="株式会社○○">
                            </div>
                            <div class="form-field">
                                <label for="contact-relation">関係性</label>
                                <select id="contact-relation" class="form-input">
                                    <option value="">選択してください</option>
                                    <option value="customer">お客様</option>
                                    <option value="partner">パートナー</option>
                                    <option value="colleague">同僚</option>
                                    <option value="superior">上司</option>
                                    <option value="subordinate">部下</option>
                                    <option value="vendor">取引先</option>
                                    <option value="client">クライアント</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="contact-requirements">要件・プロジェクト</label>
                                <textarea id="contact-requirements" class="form-textarea" rows="2" placeholder="例: Webサイトリニューアル、予算500万円"></textarea>
                            </div>
                            <div class="form-field">
                                <label for="contact-topics">最近のトピック</label>
                                <textarea id="contact-topics" class="form-textarea" rows="2" placeholder="例: 次回打ち合わせは来週、デザイン案を準備中"></textarea>
                            </div>
                            <button class="apply-contact-btn" id="apply-contact-btn" type="button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                                </svg>
                                情報を適用
                            </button>
                        </div>
                        
                        <!-- Email History -->
                        <div class="email-history" id="email-history" style="display: none;">
                            <h4 class="email-history-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                                    <path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z"/>
                                </svg>
                                過去のメール履歴
                            </h4>
                            <div class="email-history-list" id="email-history-list">
                                <div class="no-history">メール履歴はありません。</div>
                            </div>
                        </div>
                        
                        <!-- Saved Contacts List -->
                        <div class="saved-contacts">
                            <h4 class="saved-contacts-title">保存済み連絡先</h4>
                            <div class="contacts-list" id="contacts-list">
                                <div class="no-contacts">保存された連絡先はありません。</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Chat (Step 2: Consult what to write) -->
                    <div class="ai-section" id="ai-chat-section">
                        <h3 class="ai-section-title">AIアシスタント</h3>
                        <div class="ai-chat-container">
                            <div class="ai-chat-messages" id="ai-chat-messages" style="display: none;">
                                <!-- Chat messages will appear here only when active -->
                            </div>
                            <div class="ai-chat-input-container">
                                <input type="text" class="ai-chat-input" id="ai-chat-input" placeholder="AIに質問または指示を入力してください">
                                <button class="ai-chat-send-btn" id="ai-chat-send-btn" type="button" aria-label="送信">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Suggestions (Step 3: Writing assistance) -->
                    <div class="ai-section" id="suggestions-section">
                        <h3 class="ai-section-title">AI提案</h3>
                        <div class="suggestions-list" id="suggestions-list" role="list">
                            <div class="no-suggestions">AI提案を生成するには、テキストを入力してTabキーを押してください。</div>
                        </div>
                    </div>

                    <!-- Grammar Check -->
                    <div class="ai-section" id="grammar-section">
                        <h3 class="ai-section-title">文法チェック</h3>
                        <div class="grammar-results" id="grammar-results" role="list">
                            <div class="no-issues">文法チェック機能は現在準備中です。文章校正は次期リリースで追加予定です。</div>
                        </div>
                    </div>

                    <!-- Tone Adjustment -->
                    <div class="ai-section" id="tone-section">
                        <h3 class="ai-section-title">トーン調整</h3>
                        <div class="tone-options" role="radiogroup" aria-label="トーン選択">
                            <label class="tone-option">
                                <input type="radio" name="tone" value="formal" checked>
                                <span>フォーマル</span>
                            </label>
                            <label class="tone-option">
                                <input type="radio" name="tone" value="casual">
                                <span>カジュアル</span>
                            </label>
                            <label class="tone-option">
                                <input type="radio" name="tone" value="friendly">
                                <span>友好的</span>
                            </label>
                        </div>
                    </div>

                    <!-- Templates -->
                    <div class="ai-section" id="templates-section">
                        <h3 class="ai-section-title">テンプレート</h3>
                        <div class="templates-list" id="templates-list">
                            <button class="template-item" data-template="business-email">
                                <span class="template-name">ビジネスメール</span>
                                <span class="template-desc">正式なビジネスメールテンプレート</span>
                            </button>
                            <button class="template-item" data-template="thank-you">
                                <span class="template-name">お礼メール</span>
                                <span class="template-desc">感謝の気持ちを表すメール</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main Editor (Bottom Section) -->
            <section class="editor-section" role="region" aria-label="メール作成エリア">
                <div class="section-header">
                    <h2 class="section-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                            <path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z"/>
                        </svg>
                        メール作成
                    </h2>
                </div>
                
                <!-- Email Header Fields -->
                <div class="email-header" id="email-header">
                    <div class="email-field">
                        <label for="email-to">宛先:</label>
                        <input type="email" id="email-to" class="email-input" placeholder="recipient@example.com" multiple>
                    </div>
                    <div class="email-field">
                        <label for="email-subject">件名:</label>
                        <input type="text" id="email-subject" class="email-input" placeholder="メールの件名を入力してください">
                    </div>
                </div>
                
                <div 
                    class="editor-textarea" 
                    id="main-editor"
                    contenteditable="true" 
                    role="textbox" 
                    aria-multiline="true"
                    aria-label="メール本文編集エリア"
                    data-placeholder="メール本文をここに入力してください"
                ></div>
                
                <!-- Grammar Check Indicators -->
                <div class="grammar-indicators" id="grammar-indicators" aria-live="polite"></div>
            </section>
        </div>

        <!-- AI Prompt Input -->
        <div class="ai-prompt-section" role="region" aria-label="AI プロンプト入力">
            <div class="prompt-input-container">
                <input 
                    type="text" 
                    class="prompt-input" 
                    id="ai-prompt-input"
                    placeholder="この文章をよりフォーマルにして"
                    aria-label="AI への指示を入力"
                />
                <button class="prompt-submit-btn" id="prompt-submit-btn" type="button" aria-label="AI に指示を送信">
                    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            <div class="prompt-suggestions">
                <button class="prompt-suggestion" data-prompt="この文章を要約して">要約</button>
                <button class="prompt-suggestion" data-prompt="この文章を詳しく展開して">展開</button>
                <button class="prompt-suggestion" data-prompt="文法をチェックして">文法チェック</button>
            </div>
        </div>
    </main>

    <!-- Loading Indicator -->
    <div class="loading-overlay" id="loading-overlay" role="status" aria-label="処理中" aria-hidden="true">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">AI が処理中…</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container" role="region" aria-label="通知" aria-live="polite"></div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal" role="dialog" aria-labelledby="settings-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="settings-title">設定</h2>
                <button class="close-modal-btn" id="close-settings-modal" type="button" aria-label="設定を閉じる">
                    <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="settings-form" onsubmit="return false;">
                    <div class="setting-group">
                        <label for="font-size-slider">フォントサイズ</label>
                        <input type="range" id="font-size-slider" min="14" max="24" value="16" aria-label="フォントサイズ調整">
                        <span id="font-size-display">16px</span>
                    </div>
                    
                    <div class="setting-group">
                        <label for="api-token-input">API認証トークン</label>
                        <input type="password" id="api-token-input" class="setting-input" placeholder="AIeditor_AUTH トークンを入力" autocomplete="current-password">
                        <button type="button" id="save-token-btn" class="setting-btn">保存</button>
                    </div>
                
                <div class="setting-group">
                    <label for="model-selector">使用するAIモデル</label>
                    <select id="model-selector" class="setting-input">
                        <option value="openai/gpt-oss-120b">GPT-OSS-120B (デフォルト)</option>
                    </select>
                    <small class="setting-description">APIから利用可能なモデル一覧を取得して選択できます</small>
                </div>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="auto-save-toggle" checked>
                        自動保存を有効にする
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label disabled">
                        <input type="checkbox" id="grammar-check-toggle" checked disabled>
                        リアルタイム文法チェック（開発中）
                    </label>
                    <small class="setting-description">現行バージョンでは文法解析は未実装です。アップデートまでお待ちください。</small>
                </div>

                <div class="setting-group">
                    <button type="button" id="clear-all-data-btn" class="setting-btn danger">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        全データをクリア
                    </button>
                    <small class="setting-description danger">APIキー、設定、チャット履歴を全て削除します（元に戻せません）</small>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="shortcuts-help" id="shortcuts-help" role="dialog" aria-labelledby="shortcuts-title" aria-hidden="true">
        <div class="shortcuts-content">
            <h3 id="shortcuts-title">キーボードショートカット</h3>
            <dl class="shortcuts-list">
                <dt>Tab</dt><dd>AI提案を受け入れ</dd>
                <dt>Ctrl+G / Cmd+G</dt><dd>文法チェック（開発中）</dd>
                <dt>Ctrl+T / Cmd+T</dt><dd>トーン切替</dd>
                <dt>Ctrl+S / Cmd+S</dt><dd>手動保存</dd>
                <dt>Ctrl+Z / Cmd+Z</dt><dd>元に戻す</dd>
                <dt>Ctrl+Y / Cmd+Y</dt><dd>やり直し</dd>
                <dt>Esc</dt><dd>パネル/モーダルを閉じる</dd>
            </dl>
        </div>
    </div>

    <!-- Theme Toggle Script -->
    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        
        // Load saved theme or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        
        // Theme toggle handler
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update button aria-label
                themeToggle.setAttribute('aria-label', 
                    newTheme === 'light' ? 'ダークモードに切り替え' : 'ライトモードに切り替え'
                );
            });
            
            // Set initial aria-label
            themeToggle.setAttribute('aria-label', 
                savedTheme === 'light' ? 'ダークモードに切り替え' : 'ライトモードに切り替え'
            );
        }
        
        // System theme detection (optional)
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        if (!localStorage.getItem('theme')) {
            const systemTheme = mediaQuery.matches ? 'dark' : 'light';
            html.setAttribute('data-theme', systemTheme);
            localStorage.setItem('theme', systemTheme);
        }
        
        // Listen for system theme changes
        mediaQuery.addListener((e) => {
            if (!localStorage.getItem('theme-user-preference')) {
                const systemTheme = e.matches ? 'dark' : 'light';
                html.setAttribute('data-theme', systemTheme);
            }
        });
        
        // Mark when user manually changes theme
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                localStorage.setItem('theme-user-preference', 'true');
            });
        }
    </script>
    
    <!-- Main Application Script (Inline) -->
    <script>
// Inline Application - Browser Compatible Version
// This is a simplified version that doesn't require ES modules

class SimpleAIEditor {
    constructor() {
        this.editor = document.getElementById('main-editor');
        this.history = [];
        this.historyIndex = -1;
        this.activeContactId = null;
        this.activeContactName = '';
        this.availableModels = [];
        this.currentModel = 'openai/gpt-oss-120b'; // デフォルトモデル
        this.db = null;
        this.dbName = 'AIEditorDB';
        this.dbVersion = 3;
        this.init();
    }

    async init() {
        if (!this.editor) return;
        
        // Initialize IndexedDB first
        await this.initDB();
        
        this.setupEditor();
        this.setupToolbar();
        this.setupAIPanel();
        this.setupSettings();
        this.setupPrompts();
        this.setupEmailFunctions();
        this.setupDraftManagement(); // 下書き管理システム
        this.setupTextExport(); // テキストエクスポート機能
        this.setupAIChat(); // AIチャットパネル
        await this.loadModelSettings();
        
        console.log('SimpleAIEditor initialized');
    }

    // IndexedDB Database initialization
    async initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => {
                console.error('IndexedDB initialization failed:', request.error);
                resolve(); // Don't fail initialization if DB is not available
            };
            
            request.onsuccess = () => {
                this.db = request.result;
                console.log('IndexedDB initialized successfully');
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Create settings store
                if (!db.objectStoreNames.contains('settings')) {
                    const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                    console.log('Settings store created');
                }
                
                // Create models store
                if (!db.objectStoreNames.contains('models')) {
                    const modelsStore = db.createObjectStore('models', { keyPath: 'id' });
                    console.log('Models store created');
                }
                
                // Create drafts store for draft management system
                if (!db.objectStoreNames.contains('drafts')) {
                    const draftsStore = db.createObjectStore('drafts', { keyPath: 'id' });
                    draftsStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('Drafts store created');
                }
                
                // Create contacts store for contact management
                if (!db.objectStoreNames.contains('contacts')) {
                    const contactsStore = db.createObjectStore('contacts', { keyPath: 'id' });
                    contactsStore.createIndex('name', 'name', { unique: false });
                    contactsStore.createIndex('company', 'company', { unique: false });
                    contactsStore.createIndex('timestamp', 'timestamp', { unique: false });
                    console.log('Contacts store created');
                }
                
                // Note: Chat history store removed - we don't store chat history
            };
        });
    }

    // Generic method to save data to IndexedDB
    async saveToDB(storeName, data) {
        if (!this.db) {
            console.warn('Database not available, falling back to localStorage');
            localStorage.setItem(`${storeName}_${data.key || data.id}`, JSON.stringify(data));
            return;
        }

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);
            
            request.onerror = () => {
                console.error(`Failed to save to ${storeName}:`, request.error);
                // Fallback to localStorage
                localStorage.setItem(`${storeName}_${data.key || data.id}`, JSON.stringify(data));
                resolve();
            };
            
            request.onsuccess = () => {
                console.log(`Data saved to ${storeName}:`, data.key || data.id);
                resolve();
            };
        });
    }

    // Generic method to load data from IndexedDB
    async loadFromDB(storeName, key) {
        if (!this.db) {
            console.warn('Database not available, falling back to localStorage');
            const data = localStorage.getItem(`${storeName}_${key}`);
            return data ? JSON.parse(data) : null;
        }

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            
            request.onerror = () => {
                console.error(`Failed to load from ${storeName}:`, request.error);
                // Fallback to localStorage
                const data = localStorage.getItem(`${storeName}_${key}`);
                resolve(data ? JSON.parse(data) : null);
            };
            
            request.onsuccess = () => {
                resolve(request.result || null);
            };
        });
    }

    // Load all data from a store
    async loadAllFromDB(storeName) {
        if (!this.db) {
            console.warn('Database not available, cannot load all data');
            return [];
        }

        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onerror = () => {
                console.error(`Failed to load all from ${storeName}:`, request.error);
                resolve([]);
            };
            
            request.onsuccess = () => {
                resolve(request.result || []);
            };
        });
    }

    setupEditor() {
        // Add to history initially
        this.addToHistory('');
        
        // Content change handler
        this.editor.addEventListener('input', () => {
            this.addToHistory(this.editor.textContent);
            this.updateToolbarState();
        });

        // Keyboard shortcuts
        this.editor.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        this.applyFormat('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        this.applyFormat('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        this.applyFormat('underline');
                        break;
                    case 'z':
                        e.preventDefault();
                        this.undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        this.redo();
                        break;
                }
            }
        });
    }

    setupToolbar() {
        // Format buttons
        document.getElementById('bold-btn')?.addEventListener('click', () => {
            this.applyFormat('bold');
        });

        document.getElementById('italic-btn')?.addEventListener('click', () => {
            this.applyFormat('italic');
        });

        document.getElementById('underline-btn')?.addEventListener('click', () => {
            this.applyFormat('underline');
        });

        document.getElementById('list-btn')?.addEventListener('click', () => {
            this.applyFormat('list');
        });

        // AI buttons
        document.getElementById('ai-suggest-btn')?.addEventListener('click', () => {
            this.generateAISuggestion();
        });

        document.getElementById('tone-btn')?.addEventListener('click', () => {
            this.toggleAIPanel();
        });

        // Undo/Redo buttons
        document.getElementById('undo-btn')?.addEventListener('click', () => {
            this.undo();
        });

        document.getElementById('redo-btn')?.addEventListener('click', () => {
            this.redo();
        });

        this.updateToolbarState();
    }

    setupAIPanel() {
        const aiPanel = document.getElementById('ai-panel');
        const closeBtn = document.getElementById('close-ai-panel');
        
        closeBtn?.addEventListener('click', () => {
            aiPanel?.classList.remove('show');
        });

        // Template buttons
        const templateBtns = document.querySelectorAll('.template-item');
        templateBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const templateType = btn.getAttribute('data-template');
                this.insertTemplate(templateType);
            });
        });

        // Tone options
        const toneOptions = document.querySelectorAll('input[name="tone"]');
        toneOptions.forEach(option => {
            option.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.applyTone(e.target.value);
                }
            });
        });

        // Contact information setup
        this.setupContactForm();
    }

    setupContactForm() {
        const applyContactBtn = document.getElementById('apply-contact-btn');
        
        // Load saved contact information
        this.loadContactInfo();
        
        // Update contact list
        this.updateContactList();
        
        // Apply contact info to email (auto-saves to contacts)
        applyContactBtn?.addEventListener('click', () => {
            this.applyContactInfo();
        });

        // Auto-save contact info to settings when fields change
        const contactFields = ['contact-name', 'contact-company', 'contact-relation', 'contact-requirements', 'contact-topics'];
        contactFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field?.addEventListener('change', () => {
                this.saveContactInfo();
            });
        });
    }

    async getContactInfo() {
        return {
            name: document.getElementById('contact-name')?.value || '',
            company: document.getElementById('contact-company')?.value || '',
            relation: document.getElementById('contact-relation')?.value || '',
            requirements: document.getElementById('contact-requirements')?.value || '',
            topics: document.getElementById('contact-topics')?.value || ''
        };
    }

    async saveContactInfo() {
        const contactInfo = await this.getContactInfo();
        await this.saveToDB('settings', {
            key: 'contact_info',
            value: contactInfo,
            timestamp: Date.now()
        });
    }
    
    async saveEmailToHistory(contactName) {
        if (!contactName) return;
        
        // Get email data
        const emailData = this.getEmailData();
        if (!emailData.body.trim()) return;
        
        // Find contact
        const contacts = await this.getAllContacts();
        let contact = null;
        
        if (this.activeContactId) {
            contact = contacts.find(c => c.id === this.activeContactId);
        }
        
        if (!contact) {
            contact = contacts.find(c => c.name === contactName);
        }
        
        if (!contact) {
            this.showToast('連絡先が見つからないため履歴を保存できませんでした', 'warning');
            return;
        }
        
        if (!Array.isArray(contact.emailHistory)) {
            contact.emailHistory = [];
        }
        
        const timestamp = Date.now();
        const emailRecord = {
            to: emailData.to,
            subject: emailData.subject,
            content: emailData.body,
            timestamp,
            date: new Date(timestamp).toLocaleString('ja-JP')
        };
        
        contact.emailHistory.unshift(emailRecord);
        contact.updatedAt = timestamp;
        contact.lastModified = new Date(timestamp).toLocaleString('ja-JP');
        
        if (contact.emailHistory.length > 20) {
            contact.emailHistory = contact.emailHistory.slice(0, 20);
        }
        
        try {
            await this.saveToDB('contacts', contact);
            this.activeContactId = contact.id;
            this.activeContactName = contact.name;
            this.displayEmailHistory(contact.emailHistory);
            await this.updateContactList();
            console.log('Email saved to history');
        } catch (error) {
            console.error('Failed to save email to history:', error);
            this.showToast('メール履歴の保存に失敗しました', 'error');
        }
    }

    async loadContactInfo() {
        const contactData = await this.loadFromDB('settings', 'contact_info');
        if (contactData && contactData.value) {
            const info = contactData.value;
            const nameField = document.getElementById('contact-name');
            const companyField = document.getElementById('contact-company');
            const relationField = document.getElementById('contact-relation');
            const requirementsField = document.getElementById('contact-requirements');
            const topicsField = document.getElementById('contact-topics');
            
            if (nameField) nameField.value = info.name || '';
            if (companyField) companyField.value = info.company || '';
            if (relationField) relationField.value = info.relation || '';
            if (requirementsField) requirementsField.value = info.requirements || '';
            if (topicsField) topicsField.value = info.topics || '';
        }
    }

    async applyContactInfo() {
        const info = await this.getContactInfo();
        
        if (!info.name) {
            this.showToast('相手先の氏名を入力してください', 'warning');
            return;
        }

        const now = Date.now();
        const contacts = await this.getAllContacts();
        let existingContact = null;

        if (this.activeContactId) {
            existingContact = contacts.find(c => c.id === this.activeContactId);
        }

        if (!existingContact) {
            existingContact = contacts.find(c => c.name === info.name);
        }

        let contact;
        const isUpdate = Boolean(existingContact);

        if (isUpdate) {
            contact = {
                ...existingContact,
                name: info.name,
                company: info.company || '',
                relation: info.relation || '',
                requirements: info.requirements || '',
                topics: info.topics || '',
                emailHistory: Array.isArray(existingContact.emailHistory) ? existingContact.emailHistory : [],
                updatedAt: now,
                lastModified: new Date(now).toLocaleString('ja-JP')
            };
            contact.timestamp = existingContact.timestamp || now;
        } else {
            contact = {
                id: now,
                name: info.name,
                company: info.company || '',
                relation: info.relation || '',
                requirements: info.requirements || '',
                topics: info.topics || '',
                emailHistory: [],
                timestamp: now,
                updatedAt: now,
                lastModified: new Date(now).toLocaleString('ja-JP')
            };
        }
        
        try {
            await this.saveToDB('contacts', contact);
            this.activeContactId = contact.id;
            this.activeContactName = contact.name;
            this.displayEmailHistory(contact.emailHistory);
            await this.updateContactList();
        } catch (error) {
            console.error('Failed to auto-save contact:', error);
            this.showToast('連絡先の保存に失敗しました', 'error');
            return;
        }

        // Generate appropriate greeting based on relation
        let greeting = this.generateGreeting(info);
        
        // Create email template with contact information
        let emailContent = `${greeting}\n\n`;
        
        // Add spacing for content
        emailContent += '[メール本文をここに入力してください]\n\n';
        
        // Add closing based on relation
        let closing = this.generateClosing(info.relation);
        emailContent += closing;
        
        // Insert into editor
        this.editor.innerHTML = emailContent.replace(/\n/g, '<br>');
        this.addToHistory(this.editor.innerHTML);
        
        // Also set email recipient if available
        const emailToField = document.getElementById('email-to');
        if (emailToField && !emailToField.value) {
            emailToField.placeholder = `${info.company ? info.company + 'の' : ''}${info.name}さんのメールアドレス`;
        }
        
        this.showToast(isUpdate ? '相手先情報を更新しました' : '相手先情報を連絡先に保存しました', 'success');
    }

    generateGreeting(info) {
        let greeting = '';
        
        if (info.company) {
            greeting += `${info.company}\n`;
        }
        
        greeting += `${info.name}様\n\n`;
        
        // Add appropriate opening based on relation
        switch (info.relation) {
            case 'customer':
            case 'client':
                greeting += 'いつもお世話になっております。';
                break;
            case 'partner':
            case 'vendor':
                greeting += 'いつもお世話になっております。';
                break;
            case 'colleague':
                greeting += 'お疲れさまです。';
                break;
            case 'superior':
                greeting += 'お疲れさまです。';
                break;
            case 'subordinate':
                greeting += 'お疲れさまです。';
                break;
            default:
                greeting += 'いつもお世話になっております。';
        }
        
        return greeting;
    }

    generateClosing(relation) {
        let closing = '';
        
        switch (relation) {
            case 'customer':
            case 'client':
                closing = 'ご不明な点がございましたら、お気軽にお声がけください。\n\nよろしくお願いいたします。';
                break;
            case 'partner':
            case 'vendor':
                closing = '引き続きよろしくお願いいたします。';
                break;
            case 'colleague':
            case 'subordinate':
                closing = 'よろしくお願いします。';
                break;
            case 'superior':
                closing = 'よろしくお願いいたします。';
                break;
            default:
                closing = 'よろしくお願いいたします。';
        }
        
        return closing;
    }

    // ===== CONTACT MANAGEMENT =====
    
    async loadContact(contactId) {
        try {
            const transaction = this.db.transaction(['contacts'], 'readonly');
            const store = transaction.objectStore('contacts');
            const request = store.get(contactId);
            
            request.onsuccess = () => {
                const contact = request.result;
                if (contact) {
                    // Load into form
                    document.getElementById('contact-name').value = contact.name || '';
                    document.getElementById('contact-company').value = contact.company || '';
                    document.getElementById('contact-relation').value = contact.relation || '';
                    document.getElementById('contact-requirements').value = contact.requirements || '';
                    document.getElementById('contact-topics').value = contact.topics || '';
                    
                    this.activeContactId = contact.id;
                    this.activeContactName = contact.name || '';
                    
                    // Display email history
                    this.displayEmailHistory(contact.emailHistory || []);
                    this.updateContactList();
                    
                    this.showToast(`${contact.name}さんの情報を読み込みました`, 'success');
                }
            };
        } catch (error) {
            console.error('Failed to load contact:', error);
            this.showToast('連絡先の読み込みに失敗しました', 'error');
        }
    }
    
    async deleteContact(contactId) {
        if (!confirm('この連絡先を削除しますか？')) {
            return;
        }
        
        try {
            const transaction = this.db.transaction(['contacts'], 'readwrite');
            const store = transaction.objectStore('contacts');
            const request = store.delete(contactId);
            
            request.onsuccess = () => {
                this.showToast('連絡先を削除しました', 'success');
                if (this.activeContactId === contactId) {
                    this.activeContactId = null;
                    this.activeContactName = '';
                    this.displayEmailHistory([]);
                }
                this.updateContactList();
            };
        } catch (error) {
            console.error('Failed to delete contact:', error);
            this.showToast('連絡先の削除に失敗しました', 'error');
        }
    }
    
    async getAllContacts() {
        if (!this.db) return [];
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['contacts'], 'readonly');
            const store = transaction.objectStore('contacts');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const contacts = request.result || [];
                const getOrderValue = (contact) => (contact && (contact.updatedAt || contact.timestamp)) || 0;
                contacts.sort((a, b) => getOrderValue(b) - getOrderValue(a));
                resolve(contacts);
            };
            
            request.onerror = () => {
                console.error('Failed to get contacts:', request.error);
                resolve([]);
            };
        });
    }
    
    async updateContactList() {
        const contactsList = document.getElementById('contacts-list');
        if (!contactsList) return;
        
        const contacts = await this.getAllContacts();
        
        if (contacts.length === 0) {
            contactsList.innerHTML = '<div class="no-contacts">保存された連絡先はありません。</div>';
            return;
        }
        
        contactsList.innerHTML = contacts.map(contact => {
            const isActive = this.activeContactId === contact.id;
            const relationLabel = this.getRelationLabel(contact.relation);
            const companyMarkup = contact.company ? `<div class="contact-company">${this.escapeHtml(contact.company)}</div>` : '';
            const relationMarkup = relationLabel ? `<div class="contact-relation">${this.escapeHtml(relationLabel)}</div>` : '';
            const updatedMarkup = contact.lastModified ? `<div class="contact-updated">${this.escapeHtml(contact.lastModified)}</div>` : '';
            return `
                <div class="contact-item${isActive ? ' active' : ''}" data-id="${contact.id}">
                    <div class="contact-info">
                        <div class="contact-name">${this.escapeHtml(contact.name || '名称未設定')}</div>
                        ${companyMarkup}
                        ${relationMarkup}
                        ${updatedMarkup}
                    </div>
                    <div class="contact-actions">
                        <button class="contact-load-btn" onclick="aiEditor.loadContact(${contact.id})" type="button" title="読み込み">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
                            </svg>
                        </button>
                        <button class="contact-delete-btn" onclick="aiEditor.deleteContact(${contact.id})" type="button" title="削除">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    getRelationLabel(relation) {
        const labels = {
            'customer': 'お客様',
            'partner': 'パートナー',
            'colleague': '同僚',
            'superior': '上司',
            'subordinate': '部下',
            'vendor': '取引先',
            'client': 'クライアント',
            'other': 'その他'
        };
        return labels[relation] || '';
    }
    
    // ===== EMAIL HISTORY =====
    
    displayEmailHistory(history) {
        const historyContainer = document.getElementById('email-history');
        const historyList = document.getElementById('email-history-list');
        
        if (!historyContainer || !historyList) return;
        
        if (!history || history.length === 0) {
            historyContainer.style.display = 'none';
            return;
        }
        
        historyContainer.style.display = 'block';
        
        // Sort by date descending (newest first)
        const sortedHistory = [...history].sort((a, b) => b.timestamp - a.timestamp);
        
        historyList.innerHTML = sortedHistory.map((item, index) => {
            const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleString('ja-JP') : '';
            const timestampText = this.escapeHtml(timestamp || '日時不明');
            const subject = item.subject ? this.escapeHtml(item.subject) : '(件名なし)';
            const previewSource = this.stripHtml(item.content || '');
            const truncatedPreview = previewSource.length > 100 ? `${previewSource.substring(0, 100)}…` : previewSource;
            const previewText = truncatedPreview.trim() ? truncatedPreview : '（本文なし）';
            const preview = this.escapeHtml(previewText);
            return `
                <div class="history-item" data-index="${index}">
                    <div class="history-date">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/>
                        </svg>
                        ${timestampText}
                    </div>
                    <div class="history-subject" title="${subject}">${subject}</div>
                    <div class="history-preview">${preview}</div>
                    <div class="history-actions">
                        <button class="history-view-btn" onclick="aiEditor.viewEmailHistory(${index})" type="button">
                            詳細を見る
                        </button>
                        <button class="history-delete-btn" onclick="aiEditor.deleteEmailHistory(${index})" type="button">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    stripHtml(html) {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
    }
    
    async viewEmailHistory(index) {
        // Get current contact
        const name = document.getElementById('contact-name')?.value;
        if (!name) return;
        
        // Find contact
        const contacts = await this.getAllContacts();
        const contact = contacts.find(c => c.name === name);
        if (!contact || !contact.emailHistory || !contact.emailHistory[index]) return;
        
        const email = contact.emailHistory[index];
        
        // Show modal with email content
        const modal = this.createModal('メール履歴詳細', `
            <div style="padding: var(--space-4);">
                <div style="margin-bottom: var(--space-3);">
                    <strong>日時:</strong> ${new Date(email.timestamp).toLocaleString('ja-JP')}
                </div>
                <div style="margin-bottom: var(--space-3);">
                    <strong>宛先:</strong> ${email.to || ''}
                </div>
                <div style="margin-bottom: var(--space-3);">
                    <strong>件名:</strong> ${email.subject || '(件名なし)'}
                </div>
                <div style="margin-bottom: var(--space-2);">
                    <strong>本文:</strong>
                </div>
                <div style="padding: var(--space-3); background: var(--background-secondary); border-radius: var(--border-radius); max-height: 400px; overflow-y: auto; line-height: 1.6;">
                    ${email.content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `);
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    async deleteEmailHistory(index) {
        if (!confirm('このメール履歴を削除しますか？')) return;
        
        // Get current contact
        const name = document.getElementById('contact-name')?.value;
        if (!name) return;
        
        // Find and update contact
        const contacts = await this.getAllContacts();
        const contact = contacts.find(c => c.name === name);
        if (!contact || !contact.emailHistory) return;
        
        contact.emailHistory.splice(index, 1);
        contact.lastModified = new Date().toLocaleString('ja-JP');
        
        try {
            await this.saveToDB('contacts', contact);
            this.displayEmailHistory(contact.emailHistory);
            this.showToast('メール履歴を削除しました', 'success');
        } catch (error) {
            console.error('Failed to delete email history:', error);
            this.showToast('削除に失敗しました', 'error');
        }
    }

    setupSettings() {
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-modal');
        
        settingsBtn?.addEventListener('click', () => {
            settingsModal?.classList.add('show');
            settingsModal?.setAttribute('aria-hidden', 'false');
            // フォーカスを最初の入力フィールドに移動
            const firstInput = settingsModal?.querySelector('input, select, button');
            firstInput?.focus();
        });

        closeSettingsBtn?.addEventListener('click', () => {
            settingsModal?.classList.remove('show');
            settingsModal?.setAttribute('aria-hidden', 'true');
            settingsBtn?.focus(); // フォーカスを戻す
        });
        
        // ESCキーでモーダルを閉じる
        settingsModal?.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                settingsModal.classList.remove('show');
                settingsModal.setAttribute('aria-hidden', 'true');
                settingsBtn?.focus();
            }
        });
        
        // モーダル外クリックで閉じる
        settingsModal?.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
                settingsModal.setAttribute('aria-hidden', 'true');
                settingsBtn?.focus();
            }
        });

        // Font size slider
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeDisplay = document.getElementById('font-size-display');
        
        fontSizeSlider?.addEventListener('input', (e) => {
            const size = e.target.value + 'px';
            this.editor.style.fontSize = size;
            fontSizeDisplay.textContent = size;
        });

        // API Token save button
        const saveTokenBtn = document.getElementById('save-token-btn');
        const apiTokenInput = document.getElementById('api-token-input');
        
        saveTokenBtn?.addEventListener('click', () => {
            const token = apiTokenInput.value.trim();
            if (token) {
                this.setAuthToken(token);
                apiTokenInput.value = '';
            } else {
                this.showToast('トークンを入力してください', 'warning');
            }
        });

        // Load existing token (masked)
        this.getAuthToken().then(existingToken => {
            if (existingToken && apiTokenInput) {
                apiTokenInput.placeholder = '認証トークンが設定済み (新しいトークンで上書きします)';
            }
        });

        // Model selector event handler
        const modelSelector = document.getElementById('model-selector');
        modelSelector?.addEventListener('change', (e) => {
            const selectedModel = e.target.value;
            this.setCurrentModel(selectedModel);
        });

        // Clear all data button
        const clearDataBtn = document.getElementById('clear-all-data-btn');
        clearDataBtn?.addEventListener('click', () => {
            this.clearAllData();
        });
    }

    setupPrompts() {
        const promptInput = document.getElementById('ai-prompt-input');
        const promptSubmit = document.getElementById('prompt-submit-btn');
        const promptSuggestions = document.querySelectorAll('.prompt-suggestion');
        
        promptSubmit?.addEventListener('click', () => {
            this.handlePrompt(promptInput.value);
        });

        promptInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.handlePrompt(promptInput.value);
            }
        });

        promptSuggestions.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const prompt = e.target.getAttribute('data-prompt');
                this.handlePrompt(prompt);
            });
        });
    }

    applyFormat(format) {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        const selectedText = range.toString();

        if (!selectedText) return;

        let element;
        switch (format) {
            case 'bold':
                element = document.createElement('strong');
                break;
            case 'italic':
                element = document.createElement('em');
                break;
            case 'underline':
                element = document.createElement('u');
                break;
            case 'list':
                this.applyListFormat();
                return;
        }

        if (element) {
            element.textContent = selectedText;
            range.deleteContents();
            range.insertNode(element);
            this.addToHistory(this.editor.innerHTML);
        }
    }

    applyListFormat() {
        const content = this.editor.textContent;
        const lines = content.split('\n');
        const newLines = lines.map(line => {
            if (line.trim().startsWith('•')) {
                return line.replace(/^\s*•\s*/, '');
            } else if (line.trim()) {
                return '• ' + line;
            }
            return line;
        });
        
        this.editor.innerHTML = newLines.join('<br>');
        this.addToHistory(this.editor.innerHTML);
    }

    async generateAISuggestion() {
        const content = this.editor.textContent;
        if (!content.trim()) {
            this.showToast('テキストを入力してからAI提案を使用してください', 'warning');
            return;
        }

        this.showToast('AI提案を生成中…', 'info');

        try {
            const response = await this.callOpenAIAPI(content, 'この文章を改善して、より読みやすく丁寧な表現にしてください。');
            
            if (response && response.choices && response.choices[0]) {
                const suggestion = response.choices[0].message.content.trim();
                this.displayAISuggestion(suggestion);
                this.toggleAIPanel(true);
                this.showToast('AI提案を生成しました', 'success');
            } else {
                throw new Error('AI応答の形式が不正です');
            }
        } catch (error) {
            console.error('AI提案の生成に失敗:', error);
            this.showToast('AI提案の生成に失敗しました', 'error');
            
            // フォールバック: シミュレートされた提案
            const fallbackSuggestions = [
                'この文章をより丁寧な表現に変更しました。',
                '専門的な語彙を使用して文章を改善しました。',
                '文章の構造を整理して読みやすくしました。'
            ];
            const randomSuggestion = fallbackSuggestions[Math.floor(Math.random() * fallbackSuggestions.length)];
            this.displayAISuggestion(randomSuggestion);
            this.toggleAIPanel(true);
        }
    }

    displayAISuggestion(suggestion) {
        const suggestionsList = document.getElementById('suggestions-list');
        if (!suggestionsList) return;

        suggestionsList.innerHTML = `
            <div class="suggestion-item" onclick="aiEditor.applySuggestionText('${suggestion}')">
                <div class="suggestion-text">${suggestion}</div>
                <div class="suggestion-confidence">信頼度: 85%</div>
            </div>
        `;
    }

    applySuggestionText(suggestion) {
        this.showToast('AI提案を適用しました：' + suggestion, 'success');
    }

    toggleAIPanel(show = null) {
        const aiPanel = document.getElementById('ai-panel');
        if (!aiPanel) return;

        if (show === null) {
            aiPanel.classList.toggle('show');
        } else if (show) {
            aiPanel.classList.add('show');
        } else {
            aiPanel.classList.remove('show');
        }
    }

    insertTemplate(templateType) {
        let subject = '';
        let content = '';
        
        switch (templateType) {
            case 'business-email':
                subject = 'ビジネス関連のご連絡';
                content = `○○様

いつもお世話になっております。
[会社名/氏名]です。

[本文内容をここに記載してください]

何かご不明点がございましたら、お気軽にお声がけください。

よろしくお願いいたします。

[署名]
[会社名]
[連絡先]`;
                break;
            case 'thank-you':
                subject = 'お礼';
                content = `○○様

お忙しい中、[内容]をいただき、誠にありがとうございます。

[感謝の詳細をここに記載してください]

今後ともどうぞよろしくお願いいたします。

[署名]
[会社名]
[連絡先]`;
                break;
        }

        // 件名を設定
        const subjectField = document.getElementById('email-subject');
        if (subjectField) {
            subjectField.value = subject;
        }

        // 本文を設定
        this.editor.innerHTML = content.replace(/\n/g, '<br>');
        this.addToHistory(this.editor.innerHTML);
        this.showToast('メールテンプレートを挿入しました', 'success');
    }

    async callOpenAIAPI(content, instruction) {
        const apiEndpoint = 'https://api.intelligence.io.solutions/api/v1/openai/gpt-oss-120b';
        const authToken = await this.getAuthToken();
        
        if (!authToken) {
            throw new Error('API認証トークンが設定されていません。環境変数 AIeditor_AUTH を設定してください。');
        }

        const requestBody = {
            model: this.currentModel.replace('openai/', ''), // Remove provider prefix for API
            messages: [
                {
                    role: "system",
                    content: "あなたは日本語の文章作成と編集を支援するAIアシスタントです。ユーザーの要求に応じて、文章の改善、トーン調整、文法チェックを行います。"
                },
                {
                    role: "user",
                    content: `${instruction}\n\n対象の文章：\n${content}`
                }
            ],
            max_tokens: 1000,
            temperature: 0.7
        };

        const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }

        return await response.json();
    }

    async getAuthToken() {
        // Try IndexedDB first, then fallback to environment variables
        const tokenData = await this.loadFromDB('settings', 'auth_token');
        if (tokenData && tokenData.value) {
            return tokenData.value;
        }
        
        // Fallback to environment variables or global variables
        return window.AIeditor_AUTH || '';
    }

    async setAuthToken(token) {
        const tokenData = {
            key: 'auth_token',
            value: token,
            timestamp: Date.now()
        };
        
        await this.saveToDB('settings', tokenData);
        this.showToast('API認証トークンを保存しました', 'success');
        
        // トークンが設定されたらモデル一覧を取得
        await this.fetchAvailableModels();
    }

    async fetchAvailableModels() {
        const authToken = await this.getAuthToken();
        if (!authToken) {
            console.warn('認証トークンが設定されていないため、モデル一覧を取得できません');
            return;
        }

        try {
            const response = await fetch('https://api.intelligence.io.solutions/api/v1/models', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`モデル一覧取得に失敗: ${response.status} ${response.statusText}`);
            }

            const modelsData = await response.json();
            this.availableModels = this.parseModelsResponse(modelsData);
            
            // IndexedDBに保存
            await this.saveToDB('models', {
                id: 'available_models', 
                models: this.availableModels,
                timestamp: Date.now()
            });
            
            this.updateModelSelector();
            console.log('利用可能なモデル:', this.availableModels.length, '個');
            
        } catch (error) {
            console.error('モデル一覧の取得に失敗:', error);
            this.showToast('モデル一覧の取得に失敗しました', 'error');
            
            // キャッシュされたモデル一覧があれば使用
            this.loadCachedModels();
        }
    }

    parseModelsResponse(response) {
        // APIレスポンスの構造に応じてパースする
        let models = [];
        
        if (response.data && Array.isArray(response.data)) {
            // OpenAI形式の場合
            models = response.data.map(model => ({
                id: model.id || model.model,
                name: model.id || model.model,
                description: model.description || model.id || model.model,
                created: model.created,
                owned_by: model.owned_by
            }));
        } else if (Array.isArray(response)) {
            // 配列形式の場合
            models = response.map(model => ({
                id: model.id || model.model || model.name,
                name: model.name || model.id || model.model,
                description: model.description || model.name || model.id
            }));
        } else if (response.models && Array.isArray(response.models)) {
            // models配列がある場合
            models = response.models.map(model => ({
                id: model.id || model.model,
                name: model.name || model.id || model.model,
                description: model.description || model.name || model.id
            }));
        }

        // デフォルトモデルが含まれているかチェック
        const hasDefault = models.some(model => model.id === this.currentModel);
        if (!hasDefault) {
            models.unshift({
                id: this.currentModel,
                name: 'GPT-OSS-120B (デフォルト)',
                description: 'デフォルトの高性能言語モデル'
            });
        }

        return models;
    }

    async loadCachedModels() {
        const cachedData = await this.loadFromDB('models', 'available_models');
        if (cachedData && cachedData.models) {
            try {
                this.availableModels = cachedData.models;
                this.updateModelSelector();
                console.log('キャッシュされたモデル一覧を読み込みました');
            } catch (error) {
                console.error('キャッシュされたモデル一覧の読み込みに失敗:', error);
            }
        } else {
            // キャッシュがない場合はデフォルトモデルのみ
            this.availableModels = [{
                id: this.currentModel,
                name: 'GPT-OSS-120B (デフォルト)',
                description: 'デフォルトの高性能言語モデル'
            }];
            this.updateModelSelector();
        }
    }

    async loadModelSettings() {
        // 保存されたモデル設定を読み込み
        const savedModelData = await this.loadFromDB('settings', 'selected_model');
        if (savedModelData && savedModelData.value) {
            this.currentModel = savedModelData.value;
        }
        
        // 認証トークンがあればモデル一覧を取得
        const authToken = await this.getAuthToken();
        if (authToken) {
            await this.fetchAvailableModels();
        } else {
            await this.loadCachedModels();
        }
    }

    updateModelSelector() {
        const modelSelector = document.getElementById('model-selector');
        if (!modelSelector) return;

        // Clear existing options
        modelSelector.innerHTML = '';
        
        // Add available models as options
        this.availableModels.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            option.title = model.description;
            
            if (model.id === this.currentModel) {
                option.selected = true;
            }
            
            modelSelector.appendChild(option);
        });

        console.log(`モデル選択ドロップダウンを更新: ${this.availableModels.length}個のモデル`);
    }

    updateCurrentModelDisplay() {
        // Update the save status indicator to show current model
        const saveStatus = document.getElementById('save-status');
        if (saveStatus) {
            const selectedModel = this.availableModels.find(model => model.id === this.currentModel);
            const modelName = selectedModel ? selectedModel.name : this.currentModel;
            const saveIndicator = document.getElementById('save-indicator');
            if (saveIndicator) {
                saveIndicator.title = `現在のモデル: ${modelName}`;
            }
        }
    }

    async clearAllData() {
        const confirmed = confirm(
            'この操作により、以下のデータが完全に削除されます：\n' +
            '• API認証トークン\n' +
            '• モデル設定\n' +
            '• 保存された設定\n' +
            '\nこの操作は元に戻せません。続行しますか？'
        );
        
        if (!confirmed) return;

        try {
            // Clear IndexedDB data
            if (this.db) {
                // Clear settings store
                const settingsTransaction = this.db.transaction(['settings'], 'readwrite');
                const settingsStore = settingsTransaction.objectStore('settings');
                await new Promise((resolve, reject) => {
                    const clearRequest = settingsStore.clear();
                    clearRequest.onsuccess = () => resolve();
                    clearRequest.onerror = () => reject(clearRequest.error);
                });

                // Clear models store
                const modelsTransaction = this.db.transaction(['models'], 'readwrite');
                const modelsStore = modelsTransaction.objectStore('models');
                await new Promise((resolve, reject) => {
                    const clearRequest = modelsStore.clear();
                    clearRequest.onsuccess = () => resolve();
                    clearRequest.onerror = () => reject(clearRequest.error);
                });
            }

            // Clear localStorage fallback data
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('AIeditor_') || key.startsWith('settings_') || key.startsWith('models_'))) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));

            // Reset to defaults
            this.currentModel = 'openai/gpt-oss-120b';
            this.availableModels = [{
                id: this.currentModel,
                name: 'GPT-OSS-120B (デフォルト)',
                description: 'デフォルトの高性能言語モデル'
            }];
            
            this.updateModelSelector();

            // Clear API token input placeholder
            const apiTokenInput = document.getElementById('api-token-input');
            if (apiTokenInput) {
                apiTokenInput.placeholder = 'AIeditor_AUTH トークンを入力';
            }

            this.showToast('全てのデータが削除されました', 'success');
            
        } catch (error) {
            console.error('データクリアに失敗:', error);
            this.showToast('データクリアに失敗しました：' + error.message, 'error');
        }
    }

    async setCurrentModel(modelId) {
        this.currentModel = modelId;
        
        // Save to IndexedDB
        await this.saveToDB('settings', {
            key: 'selected_model',
            value: modelId,
            timestamp: Date.now()
        });
        
        const selectedModel = this.availableModels.find(model => model.id === modelId);
        const modelName = selectedModel ? selectedModel.name : modelId;
        
        this.showToast(`モデルを ${modelName} に変更しました`, 'success');
        this.updateCurrentModelDisplay();
    }

    async applyTone(tone) {
        const content = this.editor.textContent;
        if (!content.trim()) {
            this.showToast('テキストを入力してからトーン調整を使用してください', 'warning');
            return;
        }

        let instruction = '';
        switch (tone) {
            case 'formal':
                instruction = 'この文章を丁寧で正式なビジネス文書のトーンに調整してください。';
                break;
            case 'casual':
                instruction = 'この文章を親しみやすくカジュアルなトーンに調整してください。';
                break;
            case 'friendly':
                instruction = 'この文章を温かみがあり友好的なトーンに調整してください。';
                break;
        }

        this.showToast('トーンを調整中…', 'info');

        try {
            const response = await this.callOpenAIAPI(content, instruction);
            
            if (response && response.choices && response.choices[0]) {
                const adjustedText = response.choices[0].message.content.trim();
                this.editor.innerHTML = adjustedText.replace(/\n/g, '<br>');
                this.addToHistory(this.editor.innerHTML);
                
                let message = '';
                switch (tone) {
                    case 'formal':
                        message = 'フォーマルなトーンに調整しました';
                        break;
                    case 'casual':
                        message = 'カジュアルなトーンに調整しました';
                        break;
                    case 'friendly':
                        message = '友好的なトーンに調整しました';
                        break;
                }
                this.showToast(message, 'success');
            } else {
                throw new Error('AI応答の形式が不正です');
            }
        } catch (error) {
            console.error('トーン調整に失敗:', error);
            this.showToast('トーン調整に失敗しました：' + error.message, 'error');
        }
    }

    async handlePrompt(prompt) {
        if (!prompt.trim()) return;

        const content = this.editor.textContent;
        if (!content.trim()) {
            this.showToast('テキストを入力してからAIプロンプトを使用してください', 'warning');
            return;
        }

        this.showToast('AI処理中…', 'info');
        
        try {
            const response = await this.callOpenAIAPI(content, prompt);
            
            if (response && response.choices && response.choices[0]) {
                const result = response.choices[0].message.content.trim();
                
                // 結果を提案として表示
                this.displayAISuggestion(result);
                this.toggleAIPanel(true);
                this.showToast('AI処理が完了しました', 'success');
                document.getElementById('ai-prompt-input').value = '';
            } else {
                throw new Error('AI応答の形式が不正です');
            }
        } catch (error) {
            console.error('AI処理に失敗:', error);
            this.showToast('AI処理に失敗しました：' + error.message, 'error');
        }
    }

    addToHistory(content) {
        if (this.history.length > 0 && this.history[this.historyIndex] === content) {
            return;
        }

        if (this.historyIndex < this.history.length - 1) {
            this.history = this.history.slice(0, this.historyIndex + 1);
        }

        this.history.push(content);
        this.historyIndex = this.history.length - 1;

        if (this.history.length > 50) {
            this.history.shift();
            this.historyIndex--;
        }

        this.updateToolbarState();
    }

    undo() {
        if (this.canUndo()) {
            this.historyIndex--;
            this.restoreFromHistory();
        }
    }

    redo() {
        if (this.canRedo()) {
            this.historyIndex++;
            this.restoreFromHistory();
        }
    }

    canUndo() {
        return this.historyIndex > 0;
    }

    canRedo() {
        return this.historyIndex < this.history.length - 1;
    }

    restoreFromHistory() {
        if (this.historyIndex >= 0 && this.historyIndex < this.history.length) {
            this.editor.innerHTML = this.history[this.historyIndex];
            this.updateToolbarState();
        }
    }

    updateToolbarState() {
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');

        if (undoBtn) {
            undoBtn.disabled = !this.canUndo();
        }

        if (redoBtn) {
            redoBtn.disabled = !this.canRedo();
        }
    }

    setupEmailFunctions() {
        // メール送信ボタンの追加（プロンプトセクションに）
        const promptSection = document.querySelector('.ai-prompt-section');
        if (promptSection) {
            const emailActions = document.createElement('div');
            emailActions.className = 'email-actions';
            emailActions.innerHTML = `
                <button class="email-action-btn preview-btn" id="email-preview-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                        <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" fill="currentColor"/>
                    </svg>
                    プレビュー
                </button>
                <button class="email-action-btn send-btn" id="email-send-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" fill="currentColor"/>
                    </svg>
                    送信
                </button>
            `;
            promptSection.appendChild(emailActions);

            // イベントリスナーを追加
            document.getElementById('email-preview-btn')?.addEventListener('click', () => {
                this.previewEmail();
            });

            document.getElementById('email-send-btn')?.addEventListener('click', () => {
                this.sendEmail();
            });
        }
    }

    getEmailData() {
        return {
            to: document.getElementById('email-to')?.value || '',
            subject: document.getElementById('email-subject')?.value || '',
            body: this.editor.textContent || ''
        };
    }

    previewEmail() {
        const emailData = this.getEmailData();
        
        if (!emailData.to || !emailData.subject || !emailData.body.trim()) {
            this.showToast('宛先、件名、本文を入力してください', 'warning');
            return;
        }

        // プレビューモーダルを作成
        const previewModal = this.createPreviewModal(emailData);
        document.body.appendChild(previewModal);
        
        setTimeout(() => {
            previewModal.classList.add('show');
        }, 10);
    }

    createPreviewModal(emailData) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay email-preview-modal';
        modal.innerHTML = `
            <div class="modal-content email-preview-content">
                <div class="modal-header">
                    <h2>メールプレビュー</h2>
                    <button class="close-modal-btn" id="close-preview-modal">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body email-preview-body">
                    <div class="email-preview-field">
                        <strong>宛先:</strong> ${emailData.to}
                    </div>
                    <div class="email-preview-field">
                        <strong>件名:</strong> ${emailData.subject}
                    </div>
                    <div class="email-preview-separator"></div>
                    <div class="email-preview-body-content">
                        ${emailData.body.replace(/\n/g, '<br>').replace(/\s\s+/g, '&nbsp;&nbsp;')}
                    </div>
                </div>
            </div>
        `;

        // 閉じるボタンのイベントリスナー
        modal.addEventListener('click', (e) => {
            if (e.target === modal || e.target.id === 'close-preview-modal' || e.target.closest('.close-modal-btn')) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        });

        // ESCキーで閉じる
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                    document.removeEventListener('keydown', handleEscape);
                }, 300);
            }
        };
        document.addEventListener('keydown', handleEscape);

        return modal;
    }

    sendEmail() {
        const emailData = this.getEmailData();
        
        if (!emailData.to || !emailData.subject || !emailData.body.trim()) {
            this.showToast('宛先、件名、本文を入力してください', 'warning');
            return;
        }

        // メール送信のシミュレーション
        this.showToast('メールを送信中…', 'info');
        
        setTimeout(async () => {
            // 実際のメール送信APIをここで呼び出す
            // この例ではシミュレーション
            
            // Save email to contact history
            const contactName = document.getElementById('contact-name')?.value;
            if (contactName) {
                await this.saveEmailToHistory(contactName);
            }
            
            this.showToast('メールを送信し、履歴に保存しました！', 'success');
            
            // 送信後、フィールドをクリア（オプション）
            // this.clearEmailFields();
        }, 2000);
    }

    clearEmailFields() {
        document.getElementById('email-to').value = '';
        document.getElementById('email-subject').value = '';
        this.editor.innerHTML = '';
        this.addToHistory('');
    }

    // ===== 下書き管理システム =====
    
    setupDraftManagement() {
        // 自動保存タイマーを設定（30秒ごと）
        this.autoSaveInterval = setInterval(() => {
            this.autoSaveDraft();
        }, 30000);
        
        // エディタの変更を監視
        this.isDraftModified = false;
        this.editor.addEventListener('input', () => {
            this.isDraftModified = true;
        });
        
        // 下書きボタンを追加
        this.setupDraftButton();
        
        // 初回の下書き数を更新
        this.updateDraftCount();
    }
    
    setupDraftButton() {
        const headerNav = document.querySelector('.header-nav');
        if (!headerNav) return;
        
        const draftBtn = document.createElement('button');
        draftBtn.className = 'nav-button draft-btn';
        draftBtn.id = 'drafts-btn';
        draftBtn.type = 'button';
        draftBtn.setAttribute('aria-label', '下書き一覧');
        draftBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z" fill="currentColor"/>
            </svg>
            <span class="draft-count-badge" id="draft-count-badge">0</span>
        `;
        
        draftBtn.addEventListener('click', () => {
            this.showDraftList();
        });
        
        // 設定ボタンの前に挿入
        const settingsBtn = document.getElementById('settings-btn');
        if (settingsBtn) {
            headerNav.insertBefore(draftBtn, settingsBtn);
        } else {
            headerNav.appendChild(draftBtn);
        }
        
        // CSS for draft badge
        if (!document.getElementById('draft-badge-style')) {
            const style = document.createElement('style');
            style.id = 'draft-badge-style';
            style.textContent = `
                .draft-btn {
                    position: relative;
                }
                .draft-count-badge {
                    position: absolute;
                    top: -4px;
                    right: -4px;
                    background: var(--error-color);
                    color: white;
                    font-size: 10px;
                    font-weight: 600;
                    padding: 2px 5px;
                    border-radius: 10px;
                    min-width: 16px;
                    text-align: center;
                    display: none;
                }
                .draft-count-badge.show {
                    display: block;
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    async autoSaveDraft() {
        if (!this.isDraftModified) return;
        
        const emailData = this.getEmailData();
        
        // 内容が空の場合は保存しない
        if (!emailData.body.trim() && !emailData.subject.trim() && !emailData.to.trim()) {
            return;
        }
        
        const draft = {
            id: Date.now(),
            to: emailData.to || '',
            subject: emailData.subject || '無題',
            body: emailData.body || '',
            timestamp: Date.now(),
            lastModified: new Date().toLocaleString('ja-JP')
        };
        
        try {
            await this.saveDraft(draft);
            this.isDraftModified = false;
            this.showToast('下書きを自動保存しました', 'success');
            await this.updateDraftCount();
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    }
    
    async saveDraft(draft) {
        await this.saveToDB('drafts', draft);
        await this.cleanOldDrafts();
    }
    
    async cleanOldDrafts() {
        const drafts = await this.loadAllDrafts();
        const maxDrafts = 10;
        
        if (drafts.length > maxDrafts) {
            // 古い下書きを削除（タイムスタンプ順）
            drafts.sort((a, b) => b.timestamp - a.timestamp);
            const draftsToDelete = drafts.slice(maxDrafts);
            
            for (const draft of draftsToDelete) {
                await this.deleteDraft(draft.id);
            }
        }
    }
    
    async loadAllDrafts() {
        if (!this.db) {
            // LocalStorage fallback
            const drafts = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('drafts_')) {
                    try {
                        const draft = JSON.parse(localStorage.getItem(key));
                        drafts.push(draft);
                    } catch (e) {
                        console.error('Failed to parse draft:', e);
                    }
                }
            }
            return drafts;
        }
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['drafts'], 'readonly');
            const store = transaction.objectStore('drafts');
            const request = store.getAll();
            
            request.onsuccess = () => {
                resolve(request.result || []);
            };
            
            request.onerror = () => {
                console.error('Failed to load drafts:', request.error);
                resolve([]);
            };
        });
    }
    
    async loadDraft(draftId) {
        if (!this.db) {
            const draftData = localStorage.getItem(`drafts_${draftId}`);
            return draftData ? JSON.parse(draftData) : null;
        }
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['drafts'], 'readonly');
            const store = transaction.objectStore('drafts');
            const request = store.get(draftId);
            
            request.onsuccess = () => {
                resolve(request.result || null);
            };
            
            request.onerror = () => {
                console.error('Failed to load draft:', request.error);
                resolve(null);
            };
        });
    }
    
    async deleteDraft(draftId) {
        if (!this.db) {
            localStorage.removeItem(`drafts_${draftId}`);
            return;
        }
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['drafts'], 'readwrite');
            const store = transaction.objectStore('drafts');
            const request = store.delete(draftId);
            
            request.onsuccess = () => {
                resolve();
            };
            
            request.onerror = () => {
                console.error('Failed to delete draft:', request.error);
                resolve();
            };
        });
    }
    
    async updateDraftCount() {
        const drafts = await this.loadAllDrafts();
        const badge = document.getElementById('draft-count-badge');
        if (badge) {
            badge.textContent = drafts.length;
            if (drafts.length > 0) {
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }
    }
    
    async showDraftList() {
        const drafts = await this.loadAllDrafts();
        drafts.sort((a, b) => b.timestamp - a.timestamp);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay draft-list-modal';
        modal.innerHTML = `
            <div class="modal-content draft-list-content">
                <div class="modal-header">
                    <h2>下書き一覧</h2>
                    <button class="close-modal-btn" id="close-draft-modal">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body draft-list-body">
                    ${drafts.length === 0 ? '<p class="no-drafts-message">下書きはありません</p>' : ''}
                    ${drafts.map(draft => `
                        <div class="draft-item" data-draft-id="${draft.id}">
                            <div class="draft-item-header">
                                <div class="draft-item-subject">${this.escapeHtml(draft.subject)}</div>
                                <div class="draft-item-date">${draft.lastModified}</div>
                            </div>
                            <div class="draft-item-preview">${this.escapeHtml(draft.body.substring(0, 100))}…</div>
                            <div class="draft-item-actions">
                                <button class="draft-load-btn" data-draft-id="${draft.id}">読み込み</button>
                                <button class="draft-delete-btn" data-draft-id="${draft.id}">削除</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // イベントリスナー
        modal.addEventListener('click', async (e) => {
            if (e.target === modal || e.target.id === 'close-draft-modal' || e.target.closest('.close-modal-btn')) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
            
            if (e.target.classList.contains('draft-load-btn')) {
                const draftId = parseInt(e.target.getAttribute('data-draft-id'));
                await this.loadDraftToEditor(draftId);
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
            
            if (e.target.classList.contains('draft-delete-btn')) {
                const draftId = parseInt(e.target.getAttribute('data-draft-id'));
                await this.deleteDraft(draftId);
                await this.updateDraftCount();
                // モーダルを再表示
                modal.remove();
                this.showDraftList();
            }
        });
        
        // CSS追加
        if (!document.getElementById('draft-list-style')) {
            const style = document.createElement('style');
            style.id = 'draft-list-style';
            style.textContent = `
                .draft-list-content {
                    max-width: 700px;
                }
                .draft-list-body {
                    max-height: 500px;
                    overflow-y: auto;
                }
                .no-drafts-message {
                    text-align: center;
                    color: var(--text-muted);
                    padding: var(--space-8);
                }
                .draft-item {
                    border: 1px solid var(--border-color);
                    border-radius: var(--border-radius);
                    padding: var(--space-4);
                    margin-bottom: var(--space-3);
                    background: var(--background-secondary);
                }
                .draft-item-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: var(--space-2);
                }
                .draft-item-subject {
                    font-weight: var(--font-weight-semibold);
                    color: var(--text-primary);
                    font-size: var(--font-size-base);
                }
                .draft-item-date {
                    font-size: var(--font-size-xs);
                    color: var(--text-muted);
                }
                .draft-item-preview {
                    font-size: var(--font-size-sm);
                    color: var(--text-secondary);
                    margin-bottom: var(--space-3);
                    line-height: var(--line-height-normal);
                }
                .draft-item-actions {
                    display: flex;
                    gap: var(--space-2);
                }
                .draft-load-btn,
                .draft-delete-btn {
                    padding: var(--space-2) var(--space-4);
                    border: 1px solid var(--border-color);
                    border-radius: var(--border-radius);
                    font-size: var(--font-size-sm);
                    cursor: pointer;
                    transition: all var(--transition-fast);
                }
                .draft-load-btn {
                    background: var(--primary-color);
                    color: white;
                    border-color: var(--primary-color);
                }
                .draft-load-btn:hover {
                    background: var(--primary-dark);
                }
                .draft-delete-btn {
                    background: var(--background-primary);
                    color: var(--error-color);
                    border-color: var(--error-color);
                }
                .draft-delete-btn:hover {
                    background: var(--error-color);
                    color: white;
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    async loadDraftToEditor(draftId) {
        const draft = await this.loadDraft(draftId);
        if (!draft) {
            this.showToast('下書きの読み込みに失敗しました', 'error');
            return;
        }
        
        // エディタに読み込み
        document.getElementById('email-to').value = draft.to || '';
        document.getElementById('email-subject').value = draft.subject || '';
        this.editor.innerHTML = draft.body.replace(/\n/g, '<br>');
        this.addToHistory(this.editor.innerHTML);
        
        this.showToast('下書きを読み込みました', 'success');
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ===== テキストエクスポート機能 =====
    
    setupTextExport() {
        // エクスポートボタンを追加
        const toolbarAIGroup = document.querySelector('.toolbar-group.ai-group');
        if (!toolbarAIGroup) return;
        
        const exportBtn = document.createElement('button');
        exportBtn.className = 'toolbar-btn export-btn';
        exportBtn.id = 'export-btn';
        exportBtn.type = 'button';
        exportBtn.setAttribute('aria-label', 'エクスポート');
        exportBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z" fill="currentColor"/>
            </svg>
            <span>エクスポート</span>
        `;
        
        exportBtn.addEventListener('click', () => {
            this.showExportMenu();
        });
        
        toolbarAIGroup.appendChild(exportBtn);
        
        // CSS追加
        if (!document.getElementById('export-style')) {
            const style = document.createElement('style');
            style.id = 'export-style';
            style.textContent = `
                .export-btn span {
                    font-size: var(--font-size-sm);
                    margin-left: var(--space-2);
                }
                .export-menu {
                    position: fixed;
                    background: var(--background-primary);
                    border: 1px solid var(--border-color);
                    border-radius: var(--border-radius);
                    box-shadow: var(--shadow-lg);
                    z-index: var(--z-dropdown);
                    min-width: 220px;
                    opacity: 0;
                    transform: translateY(-10px);
                    transition: all var(--transition-fast);
                    pointer-events: none;
                }
                .export-menu.show {
                    opacity: 1;
                    transform: translateY(0);
                    pointer-events: all;
                }
                .export-menu-item {
                    display: flex;
                    align-items: center;
                    gap: var(--space-3);
                    padding: var(--space-3) var(--space-4);
                    border: none;
                    background: transparent;
                    width: 100%;
                    text-align: left;
                    cursor: pointer;
                    font-size: var(--font-size-sm);
                    color: var(--text-primary);
                    transition: background var(--transition-fast);
                }
                .export-menu-item:hover {
                    background: var(--background-secondary);
                }
                .export-menu-item:first-child {
                    border-radius: var(--border-radius) var(--border-radius) 0 0;
                }
                .export-menu-item:last-child {
                    border-radius: 0 0 var(--border-radius) var(--border-radius);
                }
                .export-menu-item svg {
                    width: 16px;
                    height: 16px;
                    color: var(--text-secondary);
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    showExportMenu() {
        // 既存のメニューを削除
        const existingMenu = document.querySelector('.export-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
        
        // エクスポートボタンの位置を取得
        const exportBtn = document.getElementById('export-btn');
        if (!exportBtn) return;
        
        const btnRect = exportBtn.getBoundingClientRect();
        
        const menu = document.createElement('div');
        menu.className = 'export-menu';
        menu.style.position = 'fixed';
        menu.style.top = `${btnRect.bottom + 8}px`;
        menu.style.right = `${window.innerWidth - btnRect.right}px`;
        menu.innerHTML = `
            <button class="export-menu-item" data-export-type="plain">
                <svg viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" fill="currentColor"/>
                </svg>
                プレーンテキスト
            </button>
            <button class="export-menu-item" data-export-type="markdown">
                <svg viewBox="0 0 24 24">
                    <path d="M20.56 18H3.44C2.65 18 2 17.37 2 16.59V7.41C2 6.63 2.65 6 3.44 6H20.56C21.35 6 22 6.63 22 7.41V16.59C22 17.37 21.35 18 20.56 18M6.81 15.19V11.53L8.73 13.88L10.65 11.53V15.19H12.58V8.81H10.65L8.73 11.16L6.81 8.81H4.89V15.19H6.81M19.69 12H17.77V8.81H15.85V12H13.92L16.81 15.28L19.69 12Z" fill="currentColor"/>
                </svg>
                Markdown
            </button>
            <button class="export-menu-item" data-export-type="clipboard">
                <svg viewBox="0 0 24 24">
                    <path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" fill="currentColor"/>
                </svg>
                クリップボードにコピー
            </button>
        `;
        
        // イベントリスナー
        menu.addEventListener('click', (e) => {
            const item = e.target.closest('.export-menu-item');
            if (item) {
                const exportType = item.getAttribute('data-export-type');
                this.handleExport(exportType);
                menu.classList.remove('show');
                setTimeout(() => menu.remove(), 300);
            }
        });
        
        // 外側クリックで閉じる
        const closeMenu = (e) => {
            if (!menu.contains(e.target) && !e.target.closest('#export-btn')) {
                menu.classList.remove('show');
                setTimeout(() => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }, 300);
            }
        };
        
        document.body.appendChild(menu);
        setTimeout(() => {
            menu.classList.add('show');
            document.addEventListener('click', closeMenu);
        }, 10);
    }
    
    handleExport(exportType) {
        const emailData = this.getEmailData();
        
        if (!emailData.body.trim()) {
            this.showToast('エクスポートするテキストがありません', 'warning');
            return;
        }
        
        switch (exportType) {
            case 'plain':
                this.exportPlainText(emailData);
                break;
            case 'markdown':
                this.exportMarkdown(emailData);
                break;
            case 'clipboard':
                this.copyToClipboard(emailData);
                break;
        }
    }
    
    exportPlainText(emailData) {
        const content = `宛先: ${emailData.to}
件名: ${emailData.subject}

${emailData.body}`;
        
        this.downloadTextFile(content, 'email.txt', 'text/plain');
        this.showToast('プレーンテキストをダウンロードしました', 'success');
    }
    
    exportMarkdown(emailData) {
        const content = `# ${emailData.subject}

**宛先:** ${emailData.to}

---

${emailData.body}`;
        
        this.downloadTextFile(content, 'email.md', 'text/markdown');
        this.showToast('Markdownをダウンロードしました', 'success');
    }
    
    async copyToClipboard(emailData) {
        const content = `宛先: ${emailData.to}
件名: ${emailData.subject}

${emailData.body}`;
        
        try {
            await navigator.clipboard.writeText(content);
            this.showToast('クリップボードにコピーしました', 'success');
        } catch (error) {
            console.error('Clipboard copy failed:', error);
            // フォールバック: テキストエリアを使用
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                this.showToast('クリップボードにコピーしました', 'success');
            } catch (e) {
                this.showToast('クリップボードへのコピーに失敗しました', 'error');
            }
            
            document.body.removeChild(textarea);
        }
    }
    
    downloadTextFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // メモリ解放
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }
    
    // ===== AIチャットパネル =====
    
    setupAIChat() {
        const toggleBtn = document.getElementById('toggle-chat-btn');
        const chatContent = document.getElementById('ai-chat-content');
        const chatMessages = document.getElementById('ai-chat-messages');
        const chatInput = document.getElementById('ai-chat-input');
        const sendBtn = document.getElementById('ai-chat-send-btn');

        // トグル操作は該当DOMが存在するときのみ設定
        if (toggleBtn && chatContent) {
            toggleBtn.addEventListener('click', () => {
                const isExpanded = chatContent.style.maxHeight !== '0px' && chatContent.style.maxHeight !== '';
                if (isExpanded) {
                    chatContent.style.maxHeight = '0px';
                    const icon = toggleBtn.querySelector('svg');
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    chatContent.style.maxHeight = '200px';
                    const icon = toggleBtn.querySelector('svg');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                }
            });
        }

        if (!sendBtn || !chatInput) {
            console.warn('AI chat UI is missing required elements: send button or input field.');
            return;
        }

        sendBtn.addEventListener('click', () => {
            this.handleAIChatMessage(chatInput.value);
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.handleAIChatMessage(chatInput.value);
            }
        });
    }

    async handleAIChatMessage(message) {
        if (!message.trim()) return;
        
        const chatMessages = document.getElementById('ai-chat-messages');
        const chatInput = document.getElementById('ai-chat-input');
        
        if (!chatMessages) return;
        
        // メッセージエリアを表示
        chatMessages.style.display = 'block';
        
        // ユーザーメッセージを追加
        const userMsg = document.createElement('div');
        userMsg.className = 'chat-message user-message';
        userMsg.textContent = message;
        chatMessages.appendChild(userMsg);
        
        // 入力をクリア
        if (chatInput) chatInput.value = '';
        
        // AIからの応答をシミュレート
        this.showToast('AI処理中…', 'info');
        
        try {
            const content = this.editor.textContent;
            const response = await this.callOpenAIAPI(content, message);
            
            if (response && response.choices && response.choices[0]) {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-message ai-message';
                aiMsg.textContent = response.choices[0].message.content.trim();
                chatMessages.appendChild(aiMsg);
                
                // スクロール
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                this.showToast('AI応答を受信しました', 'success');
            } else {
                throw new Error('AI応答の形式が不正です');
            }
        } catch (error) {
            console.error('AI Chat error:', error);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'chat-message error-message';
            errorMsg.textContent = 'エラー: ' + error.message;
            chatMessages.appendChild(errorMsg);
            
            this.showToast('AI処理に失敗しました', 'error');
        }
    }

    showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type} show`;
        toast.textContent = message;

        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.aiEditor = new SimpleAIEditor();
});

// Fallback initialization
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.aiEditor) {
            window.aiEditor = new SimpleAIEditor();
        }
    });
} else {
    if (!window.aiEditor) {
        window.aiEditor = new SimpleAIEditor();
    }
}    </script>
</body>
</html>
