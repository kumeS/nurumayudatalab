<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCA Analysis System - AIçµ±åˆçµ±è¨ˆè§£æãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <style>
        /* ãƒªã‚»ãƒƒãƒˆã¨ãƒ™ãƒ¼ã‚¹è¨­å®š */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f8f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background-color: white;
            border-bottom: 2px solid #000;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            letter-spacing: -0.5px;
        }
        
        .logo .pca {
            color: #000;
        }
        
        .logo .analysis {
            color: #ff1744;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .ai-badge {
            background-color: #ff1744;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .llm-txt {
            color: #333;
            font-size: 15px;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        .title-section {
            text-align: center;
            margin-bottom: 40px;
            max-width: 920px;
            position: relative;
        }
        
        /* è£…é£¾çš„ãªã‚¢ã‚¤ã‚³ãƒ³ */
        .deco-icon {
            position: absolute;
            filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.08));
            z-index: 1;
        }
        
        .deco-icon-dna {
            width: 50px;
            height: 50px;
            top: -10px;
            left: -80px;
            transform: rotate(-15deg);
        }
        
        .deco-icon-molecule {
            width: 45px;
            height: 45px;
            bottom: 20px;
            right: -85px;
            transform: rotate(20deg);
        }
        
        .deco-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .title {
            font-size: 65px;
            font-weight: 900;
            margin-bottom: 20px;
            line-height: 0.92;
            letter-spacing: -3px;
            color: #000;
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            font-size: 18px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .feature-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .feature-badge {
            background-color: #e8f4fd;
            color: #0066cc;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #b3d9ff;
        }
        
        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-container {
            width: 100%;
            max-width: 1200px;
            margin-bottom: 30px;
        }
        
        .tab-nav {
            display: flex;
            background-color: #fff;
            border: 2px solid #000;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background-color: #f0f0f0;
            color: #666;
            border: none;
            border-right: 2px solid #000;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.12s ease;
            box-shadow: 0 3px 0 #ccc;
            position: relative;
            top: 0;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button.active {
            background-color: #ffb347;
            color: #000;
            box-shadow: 0 3px 0 #e69500;
            top: -1px;
        }
        
        .tab-button:hover:not(.active) {
            background-color: #e0e0e0;
            top: -1px;
            box-shadow: 0 4px 0 #bbb;
        }
        
        .tab-button:active {
            top: 2px;
            box-shadow: 0 1px 0 #ccc;
        }
        
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            background-color: #f5e6d3;
            border: 2px solid #000;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        
        .tab-content::before {
            content: '';
            position: absolute;
            top: -5px;
            right: 20px;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"><circle cx="15" cy="8" r="3" fill="%234caf50" stroke="%23000" stroke-width="1"/><circle cx="8" cy="22" r="3" fill="%234caf50" stroke="%23000" stroke-width="1"/><circle cx="22" cy="22" r="3" fill="%234caf50" stroke="%23000" stroke-width="1"/><line x1="15" y1="11" x2="11" y2="19" stroke="%23000" stroke-width="1"/><line x1="15" y1="11" x2="19" y2="19" stroke="%23000" stroke-width="1"/><line x1="11" y1="22" x2="19" y2="22" stroke="%23000" stroke-width="1"/></svg>') center/contain no-repeat;
            opacity: 0.3;
            z-index: 0;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .upload-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #000;
        }
        
        .upload-area {
            border: 3px dashed #000;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: #ffb347;
            background-color: #fffaf5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        
        .upload-area.dragover {
            border-color: #ff1744;
            background-color: #fff5f5;
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(255, 23, 68, 0.2);
        }
        
        .upload-icon {
            font-size: 64px;
            color: #ffb347;
            margin-bottom: 20px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-button {
            background-color: #ffb347;
            color: #000;
            border: 2px solid #000;
            border-radius: 10px;
            padding: 15px 32px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
            box-shadow: 0 3px 0 #000;
            position: relative;
            top: 0;
            font-size: 17px;
        }
        
        .upload-button:hover {
            background-color: #ff9f1a;
            top: -1px;
            box-shadow: 0 4px 0 #000;
        }
        
        .upload-button:active {
            top: 2px;
            box-shadow: 0 1px 0 #000;
        }
        
        /* è¨­å®šãƒ‘ãƒãƒ« */
        .settings-panel {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .results-container {
            margin-top: 30px;
        }
        
        .result-section {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
        }
        
        .result-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .result-status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .result-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .result-status.processing {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .result-content {
            display: grid;
            gap: 20px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .image-container {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .image-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .image-description {
            font-size: 12px;
            color: #666;
        }
        
        /* LLMè§£é‡ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .llm-interpretation {
            background-color: #e8f4fd;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .llm-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .llm-icon {
            width: 24px;
            height: 24px;
            background-color: #0066cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .llm-title {
            font-size: 16px;
            font-weight: 700;
            color: #0066cc;
        }
        
        .llm-content {
            line-height: 1.6;
            color: #333;
        }
        
        .llm-content h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: #0066cc;
        }
        
        .llm-content ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        /* è§£é‡ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .interpretation-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #0066cc;
            border-radius: 5px;
        }
        
        .interpretation-section h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
            font-size: 16px;
        }
        
        .section-content p {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .fallback-section {
            border-left-color: #ffc107;
        }
        
        .fallback-section h4 {
            color: #856404;
        }
        
        .confidence-score {
            margin-left: auto;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ff1744;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: 2px solid #000;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.12s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 3px 0 #000;
            position: relative;
            top: 0;
            font-size: 15px;
        }
        
        .btn:hover {
            top: -1px;
            box-shadow: 0 4px 0 #000;
        }
        
        .btn:active {
            top: 2px;
            box-shadow: 0 1px 0 #000;
        }
        
        .btn-primary {
            background-color: #ffb347;
            color: #000;
        }
        
        .btn-primary:hover {
            background-color: #ff9f1a;
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            top: 0 !important;
            box-shadow: 0 3px 0 #ccc !important;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header {
                padding: 10px 20px;
                flex-direction: column;
                gap: 10px;
            }
            
            .title {
                font-size: 42px;
                letter-spacing: -2px;
            }
            
            .deco-icon {
                display: none;
            }
            
            .tab-nav {
                flex-direction: column;
            }
            
            .tab-button {
                border-right: none;
                border-bottom: 1px solid #000;
                box-shadow: none;
                border-radius: 0;
            }
            
            .tab-button:last-child {
                border-bottom: none;
            }
            
            .tab-button.active {
                box-shadow: none;
                top: 0;
            }
            
            .tab-button:hover:not(.active) {
                box-shadow: none;
                top: 0;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
        
        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
        .hidden {
            display: none !important;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-success {
            color: #28a745;
        }
        
        .text-error {
            color: #dc3545;
        }
        
        .text-warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="logo">
            <span class="pca">PCA</span>
            <span class="analysis">Analysis</span>
        </div>
        <div class="header-right">
            <span class="ai-badge">AI</span>
            <span class="llm-txt">LLMçµ±åˆè§£æã‚·ã‚¹ãƒ†ãƒ </span>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="title-section">
            <div class="deco-icon deco-icon-dna">
                <svg viewBox="0 0 50 50">
                    <path d="M10 5 Q25 15 40 5 Q25 25 10 15 Q25 35 40 25 Q25 45 10 35" stroke="#ff1744" stroke-width="3" fill="none"/>
                    <path d="M40 5 Q25 15 10 5 Q25 25 40 15 Q25 35 10 25 Q25 45 40 35" stroke="#ff1744" stroke-width="3" fill="none"/>
                    <circle cx="10" cy="5" r="2" fill="#ff1744"/>
                    <circle cx="40" cy="5" r="2" fill="#ff1744"/>
                    <circle cx="10" cy="15" r="2" fill="#ff1744"/>
                    <circle cx="40" cy="15" r="2" fill="#ff1744"/>
                    <circle cx="10" cy="25" r="2" fill="#ff1744"/>
                    <circle cx="40" cy="25" r="2" fill="#ff1744"/>
                    <circle cx="10" cy="35" r="2" fill="#ff1744"/>
                    <circle cx="40" cy="35" r="2" fill="#ff1744"/>
                    <circle cx="10" cy="45" r="2" fill="#ff1744"/>
                    <circle cx="40" cy="45" r="2" fill="#ff1744"/>
                </svg>
            </div>
            <h1 class="title">AIçµ±åˆPCAè§£æ</h1>
            <p class="subtitle">
                loadingsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚ˆã‚‹é«˜åº¦ãªçµ±è¨ˆè§£æã¨<br>
                LLMã«ã‚ˆã‚‹å¤šè§’çš„ãªçµæœè§£é‡ˆã‚’æä¾›ã™ã‚‹çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
            </p>
            <div class="feature-badges">
                <span class="feature-badge">CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                <span class="feature-badge">ã‚«ã‚¹ã‚¿ãƒ è§£æ</span>
                <span class="feature-badge">LLMè§£é‡ˆ</span>
                <span class="feature-badge">é«˜åº¦ãªå¯è¦–åŒ–</span>
                <span class="feature-badge">ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</span>
            </div>
            <div class="deco-icon deco-icon-molecule">
                <svg viewBox="0 0 45 45">
                    <circle cx="22.5" cy="8" r="4" fill="#4dd0e1" stroke="#000" stroke-width="2"/>
                    <circle cx="8" cy="22.5" r="4" fill="#4dd0e1" stroke="#000" stroke-width="2"/>
                    <circle cx="37" cy="22.5" r="4" fill="#4dd0e1" stroke="#000" stroke-width="2"/>
                    <circle cx="22.5" cy="37" r="4" fill="#4dd0e1" stroke="#000" stroke-width="2"/>
                    <circle cx="22.5" cy="22.5" r="3" fill="#ffb347" stroke="#000" stroke-width="2"/>
                    <line x1="22.5" y1="12" x2="22.5" y2="19.5" stroke="#000" stroke-width="2"/>
                    <line x1="12" y1="22.5" x2="19.5" y2="22.5" stroke="#000" stroke-width="2"/>
                    <line x1="33" y1="22.5" x2="25.5" y2="22.5" stroke="#000" stroke-width="2"/>
                    <line x1="22.5" y1="33" x2="22.5" y2="25.5" stroke="#000" stroke-width="2"/>
                </svg>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="upload">ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <button class="tab-button" data-tab="analysis">è§£æå®Ÿè¡Œ</button>
                <button class="tab-button" data-tab="results">çµæœãƒ»è§£é‡ˆ</button>
                <button class="tab-button" data-tab="export">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
            
            <div class="tab-content">
                <!-- ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
                <div class="tab-pane active" id="upload-pane">
                    <div class="upload-section">
                        <h2 class="section-title">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">
                                CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>
                                ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </div>
                            <input type="file" id="file-input" class="file-input" accept=".csv">
                            <button class="upload-button" onclick="document.getElementById('file-input').click()">
                                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </button>
                        </div>
                    </div>

                    <div id="file-info" class="result-section hidden">
                        <div class="result-header">
                            <h3 class="result-title">ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±</h3>
                            <span class="result-status success">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</span>
                        </div>
                        <div id="file-details"></div>
                    </div>

                    <div id="data-summary" class="result-section hidden">
                        <div class="result-header">
                            <h3 class="result-title">ãƒ‡ãƒ¼ã‚¿æ¦‚è¦</h3>
                        </div>
                        <div id="summary-content"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="downloadSampleData()">
                            ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                        <button class="btn btn-primary hidden" id="proceed-analysis" onclick="switchTab('analysis')">
                            è§£æã«é€²ã‚€
                        </button>
                    </div>
                </div>

                <!-- è§£æå®Ÿè¡Œã‚¿ãƒ– -->
                <div class="tab-pane" id="analysis-pane">
                    <div class="settings-panel">
                        <h2 class="section-title">è§£æè¨­å®š</h2>
                        
                        <div class="setting-group">
                            <label class="setting-label">PCAè¨­å®š</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="scale-data" checked>
                                    <label for="scale-data">ãƒ‡ãƒ¼ã‚¿ã®æ¨™æº–åŒ– (Scale)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="center-data" checked>
                                    <label for="center-data">ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒåŒ– (Center)</label>
                                </div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label" for="num-components">ä¸»æˆåˆ†æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                            <input type="number" id="num-components" class="setting-input" placeholder="è‡ªå‹•é¸æŠ" min="1">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">è¿½åŠ è§£æ</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="loading-test" checked>
                                    <label for="loading-test">å› å­è² è·é‡æ¤œå®š</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="multivariate-analysis">
                                    <label for="multivariate-analysis">å¤šå¤‰é‡è§£æ</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="run-analysis" onclick="runAnalysis()" disabled>
                            è§£æå®Ÿè¡Œ
                        </button>
                        <button class="btn btn-secondary" onclick="resetAnalysis()">
                            è¨­å®šãƒªã‚»ãƒƒãƒˆ
                        </button>
                        <button class="btn btn-info" onclick="testAPIConnection()">
                            ğŸ”— APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
                        </button>
                        <button class="btn btn-success" onclick="runCompleteAPITest()">
                            ğŸ§ª å®Œå…¨APIçµ±åˆãƒ†ã‚¹ãƒˆ
                        </button>
                    </div>

                    <div id="analysis-progress" class="result-section hidden">
                        <div class="result-header">
                            <h3 class="result-title">è§£æé€²è¡ŒçŠ¶æ³</h3>
                            <span class="result-status processing">å®Ÿè¡Œä¸­</span>
                        </div>
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>è§£æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...</span>
                        </div>
                    </div>
                </div>

                <!-- çµæœãƒ»è§£é‡ˆã‚¿ãƒ– -->
                <div class="tab-pane" id="results-pane">
                    <div id="analysis-results"></div>
                </div>

                <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
                <div class="tab-pane" id="export-pane">
                    <div class="section-title">çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                    <div class="settings-panel">
                        <div class="setting-group">
                            <label class="setting-label">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="radio" id="export-json" name="export-format" value="json" checked>
                                    <label for="export-json">JSONå½¢å¼</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" id="export-html" name="export-format" value="html">
                                    <label for="export-html">HTMLãƒ¬ãƒãƒ¼ãƒˆ</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" id="export-csv" name="export-format" value="csv">
                                    <label for="export-csv">CSVå½¢å¼</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="include-images" checked>
                                <label for="include-images">ç”»åƒã‚’å«ã‚€</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="exportResults()" disabled id="export-btn">
                            ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()" disabled id="export-data-btn">
                            ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="llm.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentDataId = null;
        let analysisResults = {};
        let currentAnalysisId = null;
        
        // APIè¨­å®š
        const API_BASE_URL = 'http://localhost:7860'; // loadings-web-api-sample-mainã®URL (Dockerè¨­å®šã«åˆã‚ã›ã‚‹)
        
        // DOMè¦ç´ ã®å–å¾—
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAPIHealth();
        });
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            fileInput.addEventListener('change', handleFileSelect);
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                }
            });
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
                if (pane.id === tabId + '-pane') {
                    pane.classList.add('active');
                }
            });
        }
        
        // APIå¥åº·çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('APIæ¥ç¶šç¢ºèªå®Œäº†');
                } else {
                    console.warn('APIæ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                }
            } catch (error) {
                console.error('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†
        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showLoading('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
                
                const response = await fetch(`${API_BASE_URL}/upload/csv`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.status === 'success') {
                    currentDataId = result.data_id;
                    displayFileInfo(result);
                    displayDataSummary(result.data_summary);
                    document.getElementById('proceed-analysis').classList.remove('hidden');
                    document.getElementById('run-analysis').disabled = false;
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
                }
            } catch (error) {
                hideLoading();
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
        function displayFileInfo(result) {
            const fileInfoDiv = document.getElementById('file-info');
            const detailsDiv = document.getElementById('file-details');
            
            detailsDiv.innerHTML = `
                <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${result.file_info.filename}</p>
                <p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚åˆ»:</strong> ${result.file_info.upload_time}</p>
                <p><strong>ãƒ‡ãƒ¼ã‚¿ID:</strong> ${result.data_id}</p>
                <p><strong>é™¤å»ã•ã‚ŒãŸè¡Œæ•°:</strong> ${result.data_summary.removed_rows}</p>
            `;
            
            fileInfoDiv.classList.remove('hidden');
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ¦‚è¦è¡¨ç¤º
        function displayDataSummary(summary) {
            const summaryDiv = document.getElementById('data-summary');
            const contentDiv = document.getElementById('summary-content');
            
            contentDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>ãƒ‡ãƒ¼ã‚¿æ¬¡å…ƒ</h4>
                        <p>è¡Œæ•°: ${summary.dimensions.rows}</p>
                        <p>åˆ—æ•°: ${summary.dimensions.columns}</p>
                    </div>
                    <div>
                        <h4>ãƒ‡ãƒ¼ã‚¿å“è³ª</h4>
                        <p>æ¬ æå€¤: ${summary.data_quality.missing_percentage}%</p>
                        <p>æ¨å¥¨äº‹é …: ${summary.data_quality.recommendation.length}ä»¶</p>
                    </div>
                    <div>
                        <h4>åˆ—å</h4>
                        <p style="font-size: 12px; word-break: break-all;">${summary.column_names.join(', ')}</p>
                    </div>
                </div>
            `;
            
            summaryDiv.classList.remove('hidden');
        }
        
        // è§£æå®Ÿè¡Œ
        async function runAnalysis() {
            if (!currentDataId) {
                alert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                return;
            }
            
            const scale = document.getElementById('scale-data').checked;
            const center = document.getElementById('center-data').checked;
            const components = document.getElementById('num-components').value;
            
            try {
                showAnalysisProgress();
                
                // PCAè§£æå®Ÿè¡Œ
                const pcaResponse = await fetch(`${API_BASE_URL}/analyze/pca-custom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data_id: currentDataId,
                        scale: scale,
                        center: center,
                        components: components ? parseInt(components) : null
                    })
                });
                
                const pcaResult = await pcaResponse.json();
                
                if (pcaResult.status === 'success') {
                    currentAnalysisId = pcaResult.analysis_id;
                    analysisResults.pca = pcaResult;
                    
                    // å› å­è² è·é‡æ¤œå®šå®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    if (document.getElementById('loading-test').checked) {
                        const loadingResponse = await fetch(`${API_BASE_URL}/analyze/loading-test`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                data_id: currentDataId
                            })
                        });
                        
                        const loadingResult = await loadingResponse.json();
                        if (loadingResult.status === 'success') {
                            analysisResults.loading_test = loadingResult;
                        }
                    }
                    
                    hideAnalysisProgress();
                    await displayResults();
                    await generateLLMInterpretation();
                    switchTab('results');
                    
                    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('export-data-btn').disabled = false;
                } else {
                    hideAnalysisProgress();
                    alert('è§£æã‚¨ãƒ©ãƒ¼: ' + pcaResult.message);
                }
            } catch (error) {
                hideAnalysisProgress();
                console.error('è§£æã‚¨ãƒ©ãƒ¼:', error);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // è§£æé€²è¡ŒçŠ¶æ³è¡¨ç¤º
        function showAnalysisProgress() {
            const progressElement = document.getElementById('analysis-progress') || createAnalysisProgressElement();
            progressElement.classList.remove('hidden');
            progressElement.style.display = 'block';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const progressBar = progressElement.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = '0%';
                animateProgressBar(progressBar, 0, 100, 8000); // 8ç§’ã§å®Œäº†
            }
        }
        
        function hideAnalysisProgress() {
            const progressElement = document.getElementById('analysis-progress');
            if (progressElement) {
                progressElement.classList.add('hidden');
                progressElement.style.display = 'none';
            }
        }
        
        // è§£æé€²è¡Œè¦ç´ ä½œæˆ
        function createAnalysisProgressElement() {
            const existingElement = document.getElementById('analysis-progress');
            if (existingElement) return existingElement;
            
            const progressElement = document.createElement('div');
            progressElement.id = 'analysis-progress';
            progressElement.className = 'hidden';
            progressElement.style.cssText = `
                margin: 20px 0;
                padding: 20px;
                background-color: #f0f8ff;
                border: 2px solid #0066cc;
                border-radius: 8px;
                text-align: center;
                font-family: inherit;
            `;
            
            progressElement.innerHTML = `
                <h4 style="margin: 0 0 15px 0; color: #0066cc;">ğŸ”¬ PCAè§£æå®Ÿè¡Œä¸­</h4>
                <div class="progress-container" style="
                    width: 100%;
                    height: 20px;
                    background-color: #e0e0e0;
                    border-radius: 10px;
                    margin: 10px 0;
                    overflow: hidden;
                ">
                    <div class="progress-bar" style="
                        height: 100%;
                        background: linear-gradient(90deg, #0066cc, #4CAF50);
                        border-radius: 10px;
                        width: 0%;
                        transition: width 0.3s ease;
                    "></div>
                </div>
                <div class="progress-text" style="
                    font-size: 14px;
                    color: #666;
                    margin-top: 10px;
                ">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ â†’ PCAè¨ˆç®— â†’ å¯è¦–åŒ–ç”Ÿæˆ â†’ AIè§£é‡ˆ</div>
            `;
            
            // é©åˆ‡ãªå ´æ‰€ã«æŒ¿å…¥
            const fileInfoDiv = document.getElementById('file-info');
            if (fileInfoDiv) {
                fileInfoDiv.insertAdjacentElement('afterend', progressElement);
            } else {
                document.querySelector('.container').appendChild(progressElement);
            }
            
            return progressElement;
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateProgressBar(progressBar, start, end, duration) {
            const startTime = Date.now();
            const difference = end - start;
            
            function step() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = start + (difference * progress);
                
                progressBar.style.width = currentValue + '%';
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            
            requestAnimationFrame(step);
        }
        
        // å®Œå…¨APIçµ±åˆãƒ†ã‚¹ãƒˆ
        async function runCompleteAPITest() {
            try {
                showLoading('å®Œå…¨APIçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...');
                
                console.log('ğŸ§ª APIçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                // 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
                console.log('1ï¸âƒ£ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯...');
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                if (!healthResponse.ok) {
                    throw new Error(`ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—: HTTP ${healthResponse.status}`);
                }
                const healthData = await healthResponse.json();
                console.log('âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ:', healthData);
                
                // 2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§PCAè§£æ
                console.log('2ï¸âƒ£ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§PCAè§£æ...');
                const testData = generateTestCSVData();
                const formData = new FormData();
                const blob = new Blob([testData], { type: 'text/csv' });
                formData.append('file', blob, 'test_data.csv');
                
                const uploadResponse = await fetch(`${API_BASE_URL}/upload/csv`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: HTTP ${uploadResponse.status}`);
                }
                
                const uploadResult = await uploadResponse.json();
                console.log('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', uploadResult);
                
                // 3. PCAè§£æå®Ÿè¡Œ
                console.log('3ï¸âƒ£ PCAè§£æå®Ÿè¡Œ...');
                const pcaResponse = await fetch(`${API_BASE_URL}/analyze/pca-custom`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data_id: uploadResult.data_id,
                        scale: true,
                        center: true,
                        components: null
                    })
                });
                
                if (!pcaResponse.ok) {
                    throw new Error(`PCAè§£æå¤±æ•—: HTTP ${pcaResponse.status}`);
                }
                
                const pcaResult = await pcaResponse.json();
                console.log('âœ… PCAè§£ææˆåŠŸ:', pcaResult);
                
                hideLoading();
                
                // çµæœè¡¨ç¤º
                const testResultsHtml = `
                    <div style="margin: 20px 0; padding: 20px; background-color: #e8f5e8; border: 2px solid #4CAF50; border-radius: 8px;">
                        <h3 style="color: #2E7D32; margin: 0 0 15px 0;">ğŸ§ª APIçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†</h3>
                        <p><strong>âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯:</strong> æˆåŠŸ</p>
                        <p><strong>âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</strong> ãƒ‡ãƒ¼ã‚¿ID ${uploadResult.data_id}</p>
                        <p><strong>âœ… PCAè§£æ:</strong> ${pcaResult.results?.summary?.num_components || 'N/A'}æˆåˆ†è§£æå®Œäº†</p>
                        <p><strong>çµ±è¨ˆæƒ…å ±:</strong> KaiseråŸºæº– ${pcaResult.statistical_info?.kaiser_components || 'N/A'}æˆåˆ†</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§è§£æã‚’é–‹å§‹ã§ãã¾ã™ã€‚
                        </p>
                    </div>
                `;
                
                const analysisResultsDiv = document.getElementById('analysis-results');
                analysisResultsDiv.innerHTML = testResultsHtml;
                
                alert('ğŸ‰ APIçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼\nã™ã¹ã¦ã®æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
                
            } catch (error) {
                hideLoading();
                console.error('âŒ APIçµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ APIçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}\n\nAPIã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }
        
        // ãƒ†ã‚¹ãƒˆCSVãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateTestCSVData() {
            const samples = ['Sample1', 'Sample2', 'Sample3', 'Sample4', 'Sample5'];
            const variables = ['Var1', 'Var2', 'Var3', 'Var4', 'Var5', 'Var6'];
            
            let csv = variables.join(',') + '\n';
            
            for (let i = 0; i < samples.length; i++) {
                const row = variables.map(() => (Math.random() * 100).toFixed(2));
                csv += row.join(',') + '\n';
            }
            
            return csv;
        }
        
        // çµæœè¡¨ç¤º
        async function displayResults() {
            const resultsDiv = document.getElementById('analysis-results');
            const pcaResult = analysisResults.pca;
            
            let html = `
                <div class="result-section">
                    <div class="result-header">
                        <h3 class="result-title">PCAè§£æçµæœ</h3>
                        <span class="result-status success">å®Œäº†</span>
                    </div>
                    <div class="result-content">
                        <div class="image-grid">
                            <div class="image-container">
                                <img src="${pcaResult.results.biplot_image}" alt="PCA Biplot">
                                <div class="image-title">PCAãƒã‚¤ãƒ—ãƒ­ãƒƒãƒˆ</div>
                                <div class="image-description">ã‚µãƒ³ãƒ—ãƒ«ã¨å¤‰æ•°ã®é–¢ä¿‚ã‚’2æ¬¡å…ƒã§å¯è¦–åŒ–</div>
                            </div>
            `;
            
            // æˆåˆ†åˆ¥ç”»åƒè¡¨ç¤º
            Object.keys(pcaResult.results.component_images).forEach(component => {
                const images = pcaResult.results.component_images[component];
                html += `
                    <div class="image-container">
                        <img src="${images.loading_plot}" alt="${component} Loading Plot">
                        <div class="image-title">${component} å› å­è² è·é‡</div>
                        <div class="image-description">å¤‰æ•°ã®${component}ã¸ã®å¯„ä¸åº¦</div>
                    </div>
                    <div class="image-container">
                        <img src="${images.pvalue_plot}" alt="${component} P-value Plot">
                        <div class="image-title">${component} På€¤åˆ†å¸ƒ</div>
                        <div class="image-description">çµ±è¨ˆçš„æœ‰æ„æ€§ã®è©•ä¾¡</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>çµ±è¨ˆæƒ…å ±</h4>
                            <p><strong>è§£æã—ãŸä¸»æˆåˆ†æ•°:</strong> ${pcaResult.results.summary.num_components}</p>
                            <p><strong>KaiseråŸºæº–ã«ã‚ˆã‚‹æ¨å¥¨æˆåˆ†æ•°:</strong> ${pcaResult.statistical_info.kaiser_components}</p>
                            <p><strong>ç´¯ç©å¯„ä¸ç‡80%é”æˆæˆåˆ†æ•°:</strong> ${pcaResult.statistical_info.components_80_percent}</p>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        // LLMè§£é‡ˆç”Ÿæˆ
        async function generateLLMInterpretation() {
            if (!analysisResults.pca) return;
            
            try {
                showLoading('AIè§£é‡ˆã‚’ç”Ÿæˆä¸­...');
                
                const interpretationPrompt = createInterpretationPrompt();
                
                // LLM APIå‘¼ã³å‡ºã—ï¼ˆçµ±è¨ˆè§£æç‰¹åŒ–ï¼‰
                const messages = [
                    {
                        role: "system",
                        content: "ã‚ãªãŸã¯çµ±è¨ˆè§£æã¨PCAï¼ˆä¸»æˆåˆ†åˆ†æï¼‰ã®å°‚é–€å®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸPCAè§£æçµæœã‚’å¤šè§’çš„ã«è§£é‡ˆã—ã€å®Ÿç”¨çš„ãªæ´å¯Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"
                    },
                    {
                        role: "user", 
                        content: interpretationPrompt
                    }
                ];
                
                // æ–°ã—ã„LLMçµ±è¨ˆè§£ææ©Ÿèƒ½ã‚’ä½¿ç”¨
                const interpretation = await generateStatisticalInterpretation(analysisResults);
                
                hideLoading();
                displayStructuredInterpretation(interpretation);
            } catch (error) {
                hideLoading();
                console.error('LLMè§£é‡ˆã‚¨ãƒ©ãƒ¼:', error);
                alert('AIè§£é‡ˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // çµ±è¨ˆè§£æç‰¹åŒ–LLM APIå‘¼ã³å‡ºã—
        async function callStatisticalLLMAPI(messages) {
            const apiUrl = 'https://nurumayu-worker.skume-bioinfo.workers.dev/';
            
            const requestData = {
                model: "meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8",
                temperature: 0.3, // çµ±è¨ˆè§£æã§ã¯ä¸€è²«æ€§ã‚’é‡è¦–
                stream: false,
                max_completion_tokens: 2000,
                messages: messages
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`LLM APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return formatStatisticalResponse(data.choices[0].message.content);
                } else if (data.answer) {
                    return formatStatisticalResponse(data.answer);
                } else {
                    throw new Error('LLMãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æœŸå¾…ã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('LLM APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                throw new Error(`AIè§£é‡ˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // çµ±è¨ˆè§£æãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatStatisticalResponse(content) {
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã‚’HTMLã«å¤‰æ›
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // ãƒªã‚¹ãƒˆå½¢å¼ã®å¤‰æ›
            html = html.replace(/^(\d+)\.\s*(.*?)(?=\n|$)/gm, '<li>$2</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            return `<p>${html}</p>`;
        }
        
        // è§£é‡ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
        function createInterpretationPrompt() {
            const pcaResult = analysisResults.pca;
            const stats = pcaResult.statistical_info;
            
            return `ä»¥ä¸‹ã®PCAè§£æçµæœã‚’å¤šè§’çš„ã«è§£é‡ˆã—ã¦ãã ã•ã„ï¼š

ãƒ‡ãƒ¼ã‚¿æƒ…å ±:
- ä¸»æˆåˆ†æ•°: ${pcaResult.results.summary.num_components}
- KaiseråŸºæº–æ¨å¥¨æˆåˆ†æ•°: ${stats.kaiser_components}
- ç´¯ç©å¯„ä¸ç‡80%é”æˆæˆåˆ†æ•°: ${stats.components_80_percent}
- ç¬¬1ä¸»æˆåˆ†å¯„ä¸ç‡: ${(stats.explained_variance_ratio[0] * 100).toFixed(2)}%

è§£é‡ˆã®è¦³ç‚¹:
1. çµ±è¨ˆå­¦çš„è¦³ç‚¹ï¼ˆä¸»æˆåˆ†ã®æ•°å€¤çš„æ„å‘³ã€å¯„ä¸ç‡ã®è§£é‡ˆï¼‰
2. ç”Ÿç‰©å­¦çš„è¦³ç‚¹ï¼ˆå¯èƒ½æ€§ã®ã‚ã‚‹ç”Ÿç‰©å­¦çš„å«æ„ï¼‰
3. å®Ÿé¨“ç§‘å­¦çš„è¦³ç‚¹ï¼ˆå®Ÿé¨“ãƒ‡ã‚¶ã‚¤ãƒ³ã¨çµæœã®é–¢é€£æ€§ï¼‰
4. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ææ¡ˆ

å„è¦³ç‚¹ã«ã¤ã„ã¦å…·ä½“çš„ã§å®Ÿç”¨çš„ãªè§£é‡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚`;
        }
        
        // æ§‹é€ åŒ–LLMè§£é‡ˆè¡¨ç¤º
        function displayStructuredInterpretation(interpretation) {
            const resultsDiv = document.getElementById('analysis-results');
            
            const confidenceColor = interpretation.confidence_score > 0.7 ? '#28a745' : 
                                   interpretation.confidence_score > 0.5 ? '#ffc107' : '#dc3545';
            
            const llmHtml = `
                <div class="llm-interpretation">
                    <div class="llm-header">
                        <div class="llm-icon">ğŸ¤–</div>
                        <h3 class="llm-title">AIçµ±åˆè§£é‡ˆ</h3>
                        <div class="confidence-score" style="
                            background-color: ${confidenceColor};
                            color: white;
                            padding: 4px 8px;
                            border-radius: 12px;
                            font-size: 12px;
                            font-weight: 600;
                        ">
                            ä¿¡é ¼åº¦: ${Math.round(interpretation.confidence_score * 100)}%
                        </div>
                    </div>
                    <div class="llm-content">
                        ${renderInterpretationSections(interpretation)}
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML += llmHtml;
        }
        
        // è§£é‡ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderInterpretationSections(interpretation) {
            let html = '';
            
            // çµ±è¨ˆå­¦çš„è§£é‡ˆ
            if (interpretation.statistical_interpretation) {
                html += `
                    <div class="interpretation-section">
                        <h4>ğŸ“Š çµ±è¨ˆå­¦çš„è§£é‡ˆ</h4>
                        <div class="section-content">
                            <p><strong>æ¦‚è¦:</strong> ${interpretation.statistical_interpretation.summary}</p>
                            <p><strong>ä¸»æˆåˆ†:</strong> ${interpretation.statistical_interpretation.principal_components}</p>
                            <p><strong>å¯„ä¸ç‡:</strong> ${interpretation.statistical_interpretation.variance_explained}</p>
                            <p><strong>çµ±è¨ˆçš„æœ‰æ„æ€§:</strong> ${interpretation.statistical_interpretation.statistical_significance}</p>
                        </div>
                    </div>
                `;
            }
            
            // ç”Ÿç‰©å­¦çš„è§£é‡ˆ
            if (interpretation.biological_interpretation) {
                html += `
                    <div class="interpretation-section">
                        <h4>ğŸ§¬ ç”Ÿç‰©å­¦çš„è§£é‡ˆ</h4>
                        <div class="section-content">
                            <p><strong>ç”Ÿç‰©å­¦çš„æ„å‘³:</strong> ${interpretation.biological_interpretation.biological_meaning}</p>
                            <p><strong>ãƒ‘ã‚¹ã‚¦ã‚§ã‚¤é–¢é€£:</strong> ${interpretation.biological_interpretation.pathway_implications}</p>
                            <p><strong>æ©Ÿèƒ½çš„æ´å¯Ÿ:</strong> ${interpretation.biological_interpretation.functional_insights}</p>
                        </div>
                    </div>
                `;
            }
            
            // å®Ÿé¨“è©•ä¾¡
            if (interpretation.experimental_evaluation) {
                html += `
                    <div class="interpretation-section">
                        <h4>ğŸ”¬ å®Ÿé¨“ç§‘å­¦çš„è©•ä¾¡</h4>
                        <div class="section-content">
                            <p><strong>å®Ÿé¨“ãƒ‡ã‚¶ã‚¤ãƒ³:</strong> ${interpretation.experimental_evaluation.design_assessment}</p>
                            <p><strong>ãƒ‡ãƒ¼ã‚¿å“è³ª:</strong> ${interpretation.experimental_evaluation.data_quality}</p>
                            <p><strong>åˆ¶é™äº‹é …:</strong> ${interpretation.experimental_evaluation.limitations}</p>
                        </div>
                    </div>
                `;
            }
            
            // å®Ÿç”¨çš„æ¨å¥¨
            if (interpretation.practical_recommendations) {
                html += `
                    <div class="interpretation-section">
                        <h4>ğŸ’¡ å®Ÿç”¨çš„æ¨å¥¨äº‹é …</h4>
                        <div class="section-content">
                            <p><strong>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:</strong> ${interpretation.practical_recommendations.next_steps}</p>
                            <p><strong>è¿½åŠ è§£æ:</strong> ${interpretation.practical_recommendations.additional_analyses}</p>
                            <p><strong>æ³¨æ„ç‚¹:</strong> ${interpretation.practical_recommendations.interpretive_cautions}</p>
                        </div>
                    </div>
                `;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ç”Ÿå¿œç­”è¡¨ç¤º
            if (interpretation.raw_response && interpretation.parsing_status === 'fallback_used') {
                html += `
                    <div class="interpretation-section fallback-section">
                        <h4>âš ï¸ ç”Ÿæˆã•ã‚ŒãŸè§£é‡ˆï¼ˆæ§‹é€ åŒ–å¤±æ•—ï¼‰</h4>
                        <div class="section-content" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <pre style="white-space: pre-wrap; word-wrap: break-word;">${interpretation.raw_response}</pre>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadSampleData() {
            try {
                const response = await fetch(`${API_BASE_URL}/data/example`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample_data.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportResults() {
            if (!currentAnalysisId) {
                alert('å…ˆã«è§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const includeImages = document.getElementById('include-images').checked;
            
            try {
                const response = await fetch(`${API_BASE_URL}/export/report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_id: currentAnalysisId,
                        format: format,
                        include_images: includeImages
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                    const reportData = JSON.stringify(result.report, null, 2);
                    const blob = new Blob([reportData], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analysis_report_${currentAnalysisId}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + result.message);
                }
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportData() {
            if (!currentDataId) {
                alert('å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/export/data/${currentDataId}?include_analysis=true`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_data_${currentDataId}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // è¨­å®šãƒªã‚»ãƒƒãƒˆ
        function resetAnalysis() {
            document.getElementById('scale-data').checked = true;
            document.getElementById('center-data').checked = true;
            document.getElementById('num-components').value = '';
            document.getElementById('loading-test').checked = true;
            document.getElementById('multivariate-analysis').checked = false;
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(message) {
            const loadingElement = document.getElementById('loading-overlay') || createLoadingOverlay();
            const messageElement = loadingElement.querySelector('.loading-message');
            if (messageElement) {
                messageElement.textContent = message;
            }
            loadingElement.style.display = 'flex';
            console.log('Loading:', message);
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideLoading() {
            const loadingElement = document.getElementById('loading-overlay');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            console.log('Loading complete');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
        function createLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                font-family: inherit;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background-color: white;
                    padding: 30px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    border: 2px solid #000;
                ">
                    <div class="spinner" style="
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #ff1744;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 15px;
                    "></div>
                    <div class="loading-message" style="
                        font-size: 16px;
                        font-weight: 600;
                        color: #333;
                    ">å‡¦ç†ä¸­...</div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            return overlay;
        }
        
        // APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testAPIConnection() {
            try {
                showLoading('APIæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...');
                const response = await fetch(`${API_BASE_URL}/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    hideLoading();
                    alert(`âœ… APIæ¥ç¶šæˆåŠŸï¼\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.status}\nåˆ©ç”¨å¯èƒ½ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${data.available_endpoints?.length || 0}å€‹`);
                    return true;
                } else {
                    hideLoading();
                    alert(`âŒ APIæ¥ç¶šå¤±æ•—: HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                hideLoading();
                console.error('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                alert(`âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}\n\nAPI ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:\ncd loadings-web-api-sample-main\ndocker compose up -d`);
                return false;
            }
        }
    </script>
    
    <!-- LLMçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="llm.js"></script>
</body>
</html> 