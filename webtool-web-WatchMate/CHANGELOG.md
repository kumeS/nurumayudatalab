# 変更履歴

## v2.0 - 2026年2月 

### 🎉 メジャーアップデート

#### バックエンド（worker.js）
- **パーサー刷新**: HTMLRewriter → サイト別正規表現パーサーに完全移行
  - test.sh による実地検証済みパターンを採用
  - 各サイト固有のHTML構造に最適化
  - `extractedBy` フィールドでパーサー種別を記録
- **maxResults機能**: キーワードごとに取得件数（5〜100件）を設定可能
  - デフォルト: 20件
  - Cron実行時に各キーワードの設定値を使用
  - API `/api/search/manual` でも対応
- **キーワードデータモデル拡張**:
  ```javascript
  {
    id, keyword, sites[], enabled, 
    emailNotification, notifyEmail, notifyConditions[],
    maxResults,  // ← 新規追加
    createdAt, lastScraped, lastNotified
  }
  ```
- **APIエンドポイント強化**:
  - `/api/keywords/update`: maxResults を含む全フィールド更新対応
  - `/api/search/manual`: maxResults パラメータ追加

#### フロントエンド（index.html + admin-v2.js）
- **4タブUI**: 従来の3タブから拡張
  1. **キーワード管理**: 取得件数上限設定、編集モーダル追加
  2. **データ可視化**: 全商品テーブル表示、高度なフィルタリング（NEW）
  3. **手動検索**: リアルタイム検索機能（NEW）
  4. **設定**: メール通知テスト機能

- **キーワード管理強化**:
  - ✅ maxResults 入力欄（5〜100の範囲指定）
  - ✅ 編集モーダル: キーワード、サイト、maxResults、メール設定を一括編集
  - ✅ テーブルに maxResults 列を追加
  - ❌ 最大20単語制限を撤廃（無制限に登録可能）

- **データ可視化機能（新規）**:
  - ✅ キーワード選択ドロップダウン（複数キーワード一括表示 or 個別選択）
  - ✅ 商品名テキストフィルタ（リアルタイム絞り込み）
  - ✅ サイト別チェックボックスフィルタ
  - ✅ 全商品テーブル表示（従来は2件のサンプルのみ）
  - ✅ サイト別統計カード（件数表示）
  - ✅ 結果サマリー表示

- **手動検索機能（新規）**:
  - ✅ 任意のキーワードでリアルタイム検索
  - ✅ サイト選択（複数可）
  - ✅ 取得件数指定（5〜100）
  - ✅ 結果の二次フィルタリング（商品名、サイト）
  - ✅ 検索結果はKVに保存されない（一時的な確認用）

- **localStorage統合**:
  - ✅ Worker URLを自動保存・復元
  - ✅ 設定変更時に即座に保存

- **共通UI改善**:
  - 再利用可能な関数: `renderProductTable()`, `renderSiteStats()`
  - レスポンシブ対応の強化
  - 視覚的フィードバックの改善（ローディングスピナー、エラー表示）

#### ドキュメント
- **README.md**: v2.0の新機能を反映、HTMLRewriter → 正規表現パーサーの説明に修正
- **SETUP.md**: ファイル名を admin.html → index.html に修正
- **wrangler.toml**: コメントを詳細化、設定手順を明記
- **.gitignore**: 新規作成（Cloudflare Workers プロジェクト用）

### 🔧 技術的改善
- **パフォーマンス**: 正規表現による直接抽出で処理速度向上
- **保守性**: サイト別パーサーで変更箇所を限定
- **信頼性**: test.sh による実地検証でパターンの精度を保証
- **ユーザビリティ**: 直感的な4タブUI、高度なフィルタリング機能

### 📊 統計
- **worker.js**: 1834行 → 1553行（最適化により281行削減）
- **index.html**: 437行 → 596行（機能拡張により159行増加）
- **admin-v2.js**: 422行 → 516行（高度な機能により94行増加）

---

## v1.0 - 2024年初期

- 初回リリース
- 4サイト対応（7net, HMV, Animate, Rakuten）
- Cloudflare Workers + KV による基本的な監視機能
- 簡易的な管理画面
- メール通知機能（Resend/SendGrid）
