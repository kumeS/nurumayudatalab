# WatchMate v2.0 - ECサイト監視ツール

WatchMateは、日本の主要なECサイト（4サイト）を対象に、指定したキーワードの新着商品を定期的に監視するサーバーレスアプリケーションです。Cloudflare Workers上で自動実行され、Webベースの管理画面（Admin Dashboard）から最新の状況を効率的に把握できます。

## 🚀 主な機能

*   **マルチサイト監視**: 以下の4つのサイトを自動スクレイピングします。 **自然な検索挙動**を重視し、サイトへの負荷を考慮した設計になっています。
    *   セブンネットショッピング (Omni7)
    *   HMV & BOOKS online
    *   アニメイトオンラインショップ
    *   楽天ブックス
*   **Web管理ダッシュボード (`index.html`)**:
    *   **静的サイト構成**: Webサーバー（Node.js等）は不要です。ローカルまたはGitHub Pages等で動作します。
    *   **4タブUI**: キーワード管理 / データ可視化 / 手動検索 / 設定
    *   **監視キーワードの管理**: 無制限に登録可能、各キーワードごとに取得件数（5〜100件）を指定
    *   **データ可視化**: キーワード別フィルタ、商品名での絞り込み、サイト別統計表示
    *   **手動検索**: 任意のキーワードでリアルタイム検索、結果はKVに保存されない
    *   **二次フィルタリング**: 検索結果を商品名で更に絞り込み
    *   Cloudflare KVに蓄積された検索結果データの閲覧
*   **データ自動管理**:
    *   Cloudflare KVに蓄積されるデータは、**1週間経過後に自動削除**される仕様となっており、ストレージを圧迫しません。
*   **自動スケジュール実行**: Cloudflare Cron Triggers により、30分ごとに自動で更新チェックを行います。
*   **メール通知 (オプション)**:
    *   必要に応じて、新商品検知時に **Resend** (推奨) または SendGrid を経由して通知を送ることも可能です。
*   **サーバーレスアーキテクチャ**: Cloudflare Workers & KV Storage を採用し、低コストかつ高可用性を実現。

## 🛠️ 技術スタック

*   **ランタイム**: [Cloudflare Workers](https://workers.cloudflare.com/) (V8 Isolates)
*   **データベース**: [Cloudflare KV](https://developers.cloudflare.com/workers/learning/how-kv-works/) (Key-Value Storage)
*   **HTMLパース**: 正規表現ベースの専用パーサー（各サイト別に最適化）
*   **フロントエンド**: HTML5, CSS3, Vanilla JavaScript (完全な静的サイト)
*   **メール配信 (任意)**: Resend API または SendGrid API
*   **言語**: JavaScript (ES Modules)

### サイト別正規表現パーサー

v2.0では、test.shで検証済みの**正規表現ベースの専用パーサー**を各ECサイト向けに実装しています。

**メリット:**
- ✅ **実証済み**: test.shによる実地検証でパターンを確立
- ✅ **高速処理**: 正規表現による直接抽出で効率的
- ✅ **外部依存なし**: 追加ライブラリ不要
- ✅ **サイト特化**: 各サイトのHTML構造に最適化されたパターン
- ✅ **軽量**: Cloudflare Workers の実行時間制限内で確実に動作

## 📂 プロジェクト構成

```text
├── worker.js        # メインロジック (スクレイピング, Cronスケジューラ, API)
├── index.html       # 管理画面 UI (静的ファイル)
├── admin-v2.js      # 管理画面用 フロントエンドロジック
├── test.sh          # スクレイピング検証用シェルスクリプト
├── wrangler.toml    # Cloudflare Workers 設定ファイル
├── README.md        # 当ドキュメント
└── SETUP.md         # 詳細セットアップ手順
```

## ⚙️ セットアップ & デプロイ

詳細な構築手順（Cloudflare Workersのデプロイ、KV設定など）については、別紙 [SETUP.md](SETUP.md) を参照してください。

## 🖥️ 管理画面 (Admin Dashboard) の利用

管理画面 (`index.html`) は静的なHTMLファイルです。Webサーバーを用意する必要はありません。

1.  **ホスティング**: `index.html` と `admin-v2.js` を任意の場所（ローカルフォルダ、GitHub Pages、Netlifyなど）に配置します。
2.  **接続設定**:
    *   管理画面は、デプロイされた Cloudflare Worker の API と直接通信してデータを取得・表示します。
    *   Workers側 (`worker.js`) の CORS設定で、管理画面のURL（オリジン）が許可されていることを確認してください。
3.  **機能**:
    *   **キーワード管理タブ**: 検索キーワードを無制限に登録、各キーワードごとに取得件数（5〜100件）、対象サイト、メール通知を設定可能
    *   **データ可視化タブ**: キーワード選択、商品名フィルタ、サイトフィルタで全商品データを表示、サイト別統計も表示
    *   **手動検索タブ**: 任意のキーワードでリアルタイム検索（KVに保存されない）、結果を商品名で更に絞り込み可能
    *   **設定タブ**: メール通知のテスト送信機能
    *   **データ保持**: 1週間以上前の古いデータは自動的にクリーンアップされます（KV TTL）

## 🎯 監視サイト一覧

| サイト | URL | 商品カテゴリ |
|--------|-----|-------------|
| 📘 セブンネット | 7net.omni7.jp | 書籍・雑誌・CD・DVD |
| 🎵 HMV | hmv.co.jp | 音楽CD・DVD・Blu-ray |
| ⭐ アニメイト | animate-onlineshop.jp | アニメ・ゲーム・グッズ |
| 📕 楽天ブックス | books.rakuten.co.jp | 書籍・雑誌・CD・DVD |

## 💡 使い方

### 基本的な使い方

#### 1. キーワードを追加

管理画面から監視したいキーワードを登録:
```
キーワード: "Python プログラミング"
サイト: セブンネット、楽天ブックス
メール通知: 有効
通知先: your@example.com
```

→ 30分ごとに自動監視開始！

#### 2. 新商品が見つかると...

- **KVに保存** - データ蓄積
- **メール送信** - 指定アドレスに通知
- **管理画面で確認** - いつでも確認可能

#### 3. データを確認

- **最新データ**: 「データ可視化」タブ
- **4サイト別**: 各サイトの商品数を表示
- **サンプル商品**: 各サイトから2件ずつ表示

### メール通知の仕組み

#### 通知トリガー

新商品が見つかったとき:

1. **前回のスクレイピング結果と比較**
2. **新しい商品タイトルを検出**
3. **メールを自動送信**
4. **最終通知時刻を記録**

#### メール内容

```
件名: WatchMate - [キーワード] の新商品が見つかりました！

本文:
- キーワード名
- 新商品数
- 商品リスト（タイトル・価格・サイト）
- 商品ページへのリンク
```

#### 通知頻度

- **最大**: 30分ごと（Cron実行時）
- **実際**: 新商品発見時のみ

## 🔌 API リファレンス

Worker はフロントエンド向けに以下の RESTful API を提供しています。

| メソッド | エンドポイント | 説明 |
| :--- | :--- | :--- |
| **GET** | `/health` | システム稼働状況と統計情報の確認 |
| **GET** | `/api/keywords` | 監視中のキーワード一覧を取得 |
| **POST** | `/api/keywords/add` | 新規キーワードの追加 (上限20個) |
| **POST** | `/api/keywords/delete` | キーワードの削除 |
| **PUT** | `/api/keywords/update` | キーワード設定（有効/無効）の更新 |
| **GET** | `/api/data` | 全キーワードの最新検索結果を取得 |
| **GET** | `/api/data/history` | スクレイピング履歴ログの取得 |
| **POST** | `/api/email/test` | テストメールの送信トリガー (オプション) |
| **GET** | `/api/search/manual` | スクレイピングジョブの手動実行 (デバッグ用) |

## � カスタマイズ

### スクレイピング頻度の変更

`wrangler.toml`:

```toml
# 15分ごとに変更（1日96回）
crons = ["*/15 * * * *"]

# 1時間ごとに変更（1日24回）
crons = ["0 * * * *"]
```

### 検索件数の変更

`worker.js` の各search関数:

```javascript
// 20件 → 50件に変更
search7net(keyword, 50)
searchHMV(keyword, 50)
searchAnimate(keyword, 50)
searchRakuten(keyword, 50)
```

### HTMLパースのセレクタ調整（上級者向け）

サイトのHTML構造が変更された場合、`worker.js` の `SITE_CONFIGS` を更新:

```javascript
const SITE_CONFIGS = {
  '7net': {
    selectors: {
      title: [
        '.product-title',    // メインセレクタ
        'h3.item-name',      // フォールバックセレクタ
      ],
      price: ['.price', '.product-price'],
      url: ['a.product-link', 'a[href*="/product/"]']
    }
  }
};
```

**セレクタの優先順位:**
1. HTMLRewriter API（セレクタベース）
2. 正規表現パーサー（パターンマッチング）
3. 汎用フォールバックパターン

## 💰 料金

### Cloudflare Workers（無料プラン）

- 10万リクエスト/日
- CPU時間: 10ms/リクエスト

**使用量試算（10キーワード、4サイト）:**
```
Cron実行: 48回/日
UI操作: 100回/日
合計: 148リクエスト/日

→ 無料枠の0.15%
```

### Cloudflare KV（無料プラン）

- 読み取り: 10万回/日
- 書き込み: 1,000回/日
- ストレージ: 1GB

**使用量試算:**
```
書き込み: 480回/日（48回 × 10キーワード）
ストレージ: 約10MB

→ 完全に無料枠内
```

### メールサービス

**Resend（推奨）:**
- 月3,000通まで無料
- 超過分: $0.001/通

**SendGrid:**
- 1日100通まで無料
- 超過分: 有料プランに移行

**使用量試算（10キーワード）:**
```
最大: 10キーワード × 48回/日 = 480通/日
実際: 新商品発見時のみ → 1日10通程度

→ 無料枠で十分
```

**合計: 完全無料で運用可能！**

## �📝 ライセンス
本プロジェクトは個人利用または教育目的での利用を想定しています。スクレイピング対象サイトの利用規約を尊重してご利用ください。
